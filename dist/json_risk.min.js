/*! json_risk 25-01-2019 */

!function(t,e){"object"==typeof module&&"undefined"!=typeof exports?module.exports=e():t.JsonRisk=e()}(this,function(){var t={valuation_date:null,pricer:function(t,e){return null}};return t}),function(t){t.get_const_curve=function(t){if("number"!=typeof t)throw new Error("get_const_curve: input must be number.");if(t<=-1)throw new Error("get_const_curve: invalid input.");return{type:"yield",times:[1],dfs:[1/(1+t)]}},t.get_initialised_curve=function(e){if(!e)return t.get_const_curve(0);var r,n=function(e){var r,n;{if(void 0===e.times){if(void 0!==e.days)for(r=e.days.length,n=new Array(r);r>0;)n[--r]=e.days[r]/365;else if(void 0!==e.dates)for(r=e.dates.length,n=new Array(r),yf=t.year_fraction_factory("act/365"),ref_date=t.date_str_to_date(e.dates[0]);r>0;)n[--r]=yf(ref_date,t.date_str_to_date(e.dates[r]));else{if(void 0===e.labels)throw new Error("init_curve: invalid curve, cannot derive times");for(r=e.labels.length,n=new Array(r);r>0;)n[--r]=t.period_str_to_time(e.labels[r])}return n}for(r=e.times.length;r>0;)if(r--,"number"!=typeof e.times[r])throw new Error("get_curve_times: invalid vector of times, must be numeric");return e.times}}(e);if(void 0!==e.dfs)r=e.dfs;else{if(void 0===e.zcs)throw new Error("get_initialised_curve: invalid curve, both dfs and zcs undefined");r=function(t,e){var r,n;if(r=t.length,e.length!==r)throw new Error("get_dfs: invalid input, length of zcs does not match length of times");n=new Array(r);for(;r>0;){if("number"!=typeof t[--r])throw new Error("get_curve_times: invalid vector of times, must be numeric");n[r]=Math.pow(1+t[r],-e[r])}return n}(e.zcs,n)}return{type:"yield",times:n,dfs:r}},get_df_internal=function(t,e,r,n){if(e<1/512)return 1;if(r==n)return e===t.times[r]?t.dfs[r]:Math.pow(t.dfs[r],e/t.times[r]);if(e<t.times[r])return Math.pow(t.dfs[r],e/t.times[r]);if(e>t.times[n])return Math.pow(t.dfs[n],e/t.times[n]);if(r+1==n){if(t.times[n]-t.times[r]<1/512)throw new Error("get_df_internal: invalid curve, support points must be increasing and differ at least one day");return t.dfs[r]*(t.times[n]-e)/(t.times[n]-t.times[r])+t.dfs[n]*(e-t.times[r])/(t.times[n]-t.times[r])}return imed=Math.ceil((r+n)/2),e>t.times[imed]?get_df_internal(t,e,imed,n):get_df_internal(t,e,r,imed)},t.get_df=function(e,r){var n=t.get_initialised_curve(e);return get_df_internal(n,r,0,n.times.length-1)},t.get_rate=function(e,r){return r<1/512?0:Math.pow(t.get_df(e,r),-1/r)-1},t.get_fwd_rate=function(e,r,n){if(n-r<1/512)return 0;var i=t.get_initialised_curve(e);return Math.pow(t.get_df(i,n)/t.get_df(i,r),-1/(n-r))-1}}(this.JsonRisk||module.exports),function(t){t.irregular_fixed_income=function(e){var r=t.get_initialised_date(e.maturity);if(!r)throw new Error("irregular_fixed_income: must provide maturity date.");if("number"!=typeof e.notional)throw new Error("irregular_fixed_income: must provide valid notional.");if(this.notional=e.notional,"number"!=typeof e.tenor)throw new Error("irregular_fixed_income: must provide valid tenor.");if(e.tenor<0||e.tenor!==Math.floor(e.tenor))throw new Error("irregular_fixed_income: must provide valid tenor.");var n=e.tenor;this.type="string"==typeof e.type?e.type:"unknown",this.is_holiday_func=t.is_holiday_factory(e.calendar||""),this.year_fraction_func=t.year_fraction_factory(e.dcc||""),this.bdc=e.bdc||"";var i=t.get_initialised_date(e.effective_date),a=t.get_initialised_date(e.first_date),o=t.get_initialised_date(e.next_to_last_date),_="number"==typeof e.settlement_days?e.settlement_days:0;this.settlement_date=t.adjust(t.add_days(t.valuation_date,_),"following",this.is_holiday_func);"number"==typeof e.residual_spread&&e.residual_spread,e.currency;if("number"==typeof e.fixed_rate)this.is_float=!1,this.fixed_rate=e.fixed_rate;else{if(this.is_float=!0,this.float_spread="number"==typeof e.float_spread?e.float_spread:0,"number"!=typeof e.current_rate)throw new Error("irregular_fixed_income: must provide valid current_rate.");this.current_rate=e.current_rate}this.schedule=t.backward_schedule(i,r,n,this.is_holiday_func,this.bdc,a,o),this.cash_flows=this.fix_cash_flows(this.schedule,this.bdc,this.is_holiday_func,this.year_fraction_func,this.notional,this.is_float?this.current_rate:this.fixed_rate)},t.irregular_fixed_income.prototype.fix_cash_flows=function(e,r,n,i,a,o){if(null===t.valuation_date)throw new Error("fix_cash_flows: valuation_date must be set");var _,s,d=new Array(e.length-1),f=new Array(e.length-1),l=new Array(e.length-1),u=new Array(e.length-1),c=new Array(e.length-1),h=new Array(e.length-1),m=new Array(e.length-1),p=new Array(e.length-1),w=new Array(e.length-1),g=new Array(e.length-1),y=new Array(e.length-1),v=new Array(e.length-1),b=new Array(e.length-1),x=new Array(e.length-1),A=new Array(e.length-1),E=new Array(e.length-1),D=t.year_fraction_factory(null);for(_=0;_<e.length-1;_++)d[_]=e[_],f[_]=e[_+1],l[_]=(s=e[_+1],t.adjust(s,r,n)),h[_]=D(t.valuation_date,e[_+1]),m[_]=!0,p[_]=!1,w[_]=!1,g[_]=!1,y[_]=a,v[_]=a*o*i(d[_],f[_]),b[_]=v[_],x[_]=0,A[_]=v[_],E[_]=A[_];return E[e.length-2]+=a,x[e.length-2]+=a,p[e.length-2]=!0,{date_accrual_start:d,date_accrual_end:f,date_pmt:l,t_accrual_start:u,t_accrual_end:c,t_pmt:h,is_interest_date:m,is_repay_date:p,is_fixing_date:w,is_condition_date:g,current_principal:y,interest_current_period:v,accrued_interest:b,pmt_principal:x,pmt_interest:A,pmt_total:E}},t.irregular_fixed_income.prototype.get_cash_flows=function(e){if(!this.is_float)return this.cash_flows;var r,n,i,a=this.cash_flows,o=t.year_fraction_factory(null),_=a.t_pmt.length;for(r=1;r<_;r++)a.is_fixing_date[r]=!0,n=t.get_fwd_rate(e,o(t.valuation_date,a.date_accrual_start[r]),o(t.valuation_date,a.date_accrual_end[r]))+this.float_spread,i=this.notional*n*this.year_fraction_func(a.date_accrual_start[r],a.date_accrual_end[r]),a.interest_current_period[r]=i,a.accrued_interest[r]=i,a.pmt_interest[r]=i;return a.pmt_total[_-1]=a.pmt_interest[_-1]+this.notional,a},t.irregular_fixed_income.prototype.present_value=function(e,r,n){return t.dcf(this.get_cash_flows(n||null),e,r,this.residual_spread,this.settlement_date)},t.pricer_loan=function(e,r,n,i){return new t.irregular_fixed_income(e).present_value(r,n,i)}}(this.JsonRisk||module.exports),function(t){t.backward_schedule=function(e,r,n,i,a,o,_){if(!(r instanceof Date))throw new Error("backward_schedule: maturity must be provided");if(!(e instanceof Date)){if(null===t.valuation_date)throw new Error("backward_schedule: if valuation_date is unset, effective date must be provided");if(o instanceof Date)throw new Error("backward_schedule: if first date is provided, effective date must be provided")}if(e instanceof Date&&r<e||t.valuation_date instanceof Date&&r<t.valuation_date)throw new Error("backward_schedule: maturity is before valution or effective date.");if("number"!=typeof n)throw new Error("backward_schedule: tenor must be a nonnegative integer, e.g., 6 for semiannual schedule, 0 for zerobond/iam schedule");if(n<0||Math.floor(n)!==n)throw new Error("backward_schedule: tenor must be a nonnegative integer, e.g., 6 for semiannual schedule, 0 for zerobond/iam schedule");if(0===n)return[e,r];var s=function(e){return t.adjust(e,a,i)},d=[r],f=r;_ instanceof Date&&s(_)<s(r)&&(d.unshift(_),f=_);for(var l,u=0;;){if(u++,l=t.add_months(f,-n*u),o instanceof Date&&l<o)return s(d[0]).getTime()!==s(o).getTime()&&d.unshift(o),s(d[0]).getTime()!==s(e).getTime()&&d.unshift(e),d;if(e instanceof Date&&l<e)return s(d[0]).getTime()!=s(e).getTime()&&d.unshift(e),d;if(t.valuation_date instanceof Date&&l<t.valuation_date)return d.unshift(l),s(l)>t.valuation_date&&(u++,l=t.add_months(f,-n*u),o instanceof Date&&l<o?d.unshift(o):e instanceof Date&&l<e?d.unshift(e):d.unshift(l)),d;d.unshift(l)}}}(this.JsonRisk||module.exports),function(t){t.dcf=function(e,r,n,i,a){if(null===t.valuation_date)throw new Error("dcf: valuation_date must be set");var o=t.get_initialised_curve(r),_=t.get_initialised_curve(n);"number"!=typeof i&&(i=0);var s=t.get_initialised_date(a);if(s||(s=t.valuation_date),void 0===e.t_pmt||void 0===e.pmt_total)throw new Error("dcf: invalid cashflow object");if(e.t_pmt.length!==e.pmt_total.length)throw new Error("dcf: invalid cashflow object");for(var d,f,l,u=0,c=0;e.date_pmt[c]<=s;)c++;for(;c<e.t_pmt.length;)d=t.get_df(o,e.t_pmt[c]),f=t.get_df(_,e.t_pmt[c]),l=Math.exp(-e.t_pmt[c]*i),u+=e.pmt_total[c]*d*f*l,c++;return u},t.simple_fixed_income=function(e){var r=t.get_initialised_date(e.maturity);if(!r)throw new Error("simple_fixed_income: must provide maturity date.");if("number"!=typeof e.notional)throw new Error("simple_fixed_income: must provide valid notional.");if(this.notional=e.notional,"number"!=typeof e.tenor)throw new Error("simple_fixed_income: must provide valid tenor.");if(e.tenor<0||e.tenor!==Math.floor(e.tenor))throw new Error("simple_fixed_income: must provide valid tenor.");var n=e.tenor;this.type="string"==typeof e.type?e.type:"unknown",this.is_holiday_func=t.is_holiday_factory(e.calendar||""),this.year_fraction_func=t.year_fraction_factory(e.dcc||""),this.bdc=e.bdc||"";var i=t.get_initialised_date(e.effective_date),a=t.get_initialised_date(e.first_date),o=t.get_initialised_date(e.next_to_last_date),_="number"==typeof e.settlement_days?e.settlement_days:0;this.settlement_date=t.adjust(t.add_days(t.valuation_date,_),"following",this.is_holiday_func);"number"==typeof e.residual_spread&&e.residual_spread,e.currency;if("number"==typeof e.fixed_rate)this.is_float=!1,this.fixed_rate=e.fixed_rate;else{if(this.is_float=!0,this.float_spread="number"==typeof e.float_spread?e.float_spread:0,"number"!=typeof e.current_rate)throw new Error("simple_fixed_income: must provide valid current_rate.");this.current_rate=e.current_rate}this.schedule=t.backward_schedule(i,r,n,this.is_holiday_func,this.bdc,a,o),this.cash_flows=this.fix_cash_flows(this.schedule,this.bdc,this.is_holiday_func,this.year_fraction_func,this.notional,this.is_float?this.current_rate:this.fixed_rate)},t.simple_fixed_income.prototype.fix_cash_flows=function(e,r,n,i,a,o){if(null===t.valuation_date)throw new Error("fix_cash_flows: valuation_date must be set");var _,s,d=new Array(e.length-1),f=new Array(e.length-1),l=new Array(e.length-1),u=new Array(e.length-1),c=new Array(e.length-1),h=new Array(e.length-1),m=new Array(e.length-1),p=new Array(e.length-1),w=new Array(e.length-1),g=new Array(e.length-1),y=new Array(e.length-1),v=new Array(e.length-1),b=new Array(e.length-1),x=new Array(e.length-1),A=new Array(e.length-1),E=new Array(e.length-1),D=t.year_fraction_factory(null);for(_=0;_<e.length-1;_++)d[_]=e[_],f[_]=e[_+1],l[_]=(s=e[_+1],t.adjust(s,r,n)),h[_]=D(t.valuation_date,e[_+1]),m[_]=!0,p[_]=!1,w[_]=!1,g[_]=!1,y[_]=a,v[_]=a*o*i(d[_],f[_]),b[_]=v[_],x[_]=0,A[_]=v[_],E[_]=A[_];return E[e.length-2]+=a,x[e.length-2]+=a,p[e.length-2]=!0,{date_accrual_start:d,date_accrual_end:f,date_pmt:l,t_accrual_start:u,t_accrual_end:c,t_pmt:h,is_interest_date:m,is_repay_date:p,is_fixing_date:w,is_condition_date:g,current_principal:y,interest_current_period:v,accrued_interest:b,pmt_principal:x,pmt_interest:A,pmt_total:E}},t.simple_fixed_income.prototype.get_cash_flows=function(e){if(!this.is_float)return this.cash_flows;var r,n,i,a=this.cash_flows,o=t.year_fraction_factory(null),_=a.t_pmt.length;for(r=1;r<_;r++)a.is_fixing_date[r]=!0,n=t.get_fwd_rate(e,o(t.valuation_date,a.date_accrual_start[r]),o(t.valuation_date,a.date_accrual_end[r]))+this.float_spread,i=this.notional*n*this.year_fraction_func(a.date_accrual_start[r],a.date_accrual_end[r]),a.interest_current_period[r]=i,a.accrued_interest[r]=i,a.pmt_interest[r]=i;return a.pmt_total[_-1]=a.pmt_interest[_-1]+this.notional,a},t.simple_fixed_income.prototype.present_value=function(e,r,n){return t.dcf(this.get_cash_flows(n||null),e,r,this.residual_spread,this.settlement_date)},t.pricer_bond=function(e,r,n){return new t.simple_fixed_income(e).present_value(r,n,null)},t.pricer_floater=function(e,r,n,i){return new t.simple_fixed_income(e).present_value(r,n,i)},t.pricer_swap=function(e,r,n){var i=e.payer?-1:1,a=new t.simple_fixed_income({notional:e.notional*i,maturity:e.maturity,fixed_rate:e.fixed_rate,tenor:e.fixed_tenor,effective_date:e.effective_date,calendar:e.calendar,bdc:e.fixed_bdc,dcc:e.fixed_dcc}),o=new t.simple_fixed_income({notional:-e.notional*i,maturity:e.maturity,float_spread:e.float_spread,tenor:e.float_tenor,effective_date:e.effective_date,calendar:e.calendar,bdc:e.float_bdc,dcc:e.float_dcc,current_rate:e.float_current_rate});return a.present_value(r,null,n)+o.present_value(r,null,n)},t.pricer_fxterm=function(e,r){var n=new t.simple_fixed_income({notional:e.notional,maturity:e.maturity,fixed_rate:0,tenor:0}).present_value(r,null,null);return"number"!=typeof e.notional_2?n:n+new t.simple_fixed_income({notional:e.notional_2,maturity:e.maturity_2,fixed_rate:0,tenor:0}).present_value(r,null,null)}}(this.JsonRisk||module.exports),function(t){var e=1/864e5;function r(t){return t%4==0&&(2e3===t||t%100!=0)}function n(t,e){return 1===e?r(t)?29:28:3===e||5===e||8===e||10===e?30:31}function i(t,r){return(r-t)*e}function a(t,e){return i(t,e)/365}function o(t,e){return i(t,e)/360}function _(t,e){return(360*(e.getFullYear()-t.getFullYear())+30*(e.getMonth()-t.getMonth())+(Math.min(e.getDate(),30)-Math.min(t.getDate(),30)))/360}function s(t,e){if(t-e==0)return 0;if(t>e)return-s(e,t);var n=t.getFullYear(),a=e.getFullYear();if(n===a)return i(e,t)/(r(n)?366:365);var o=a-n-1;return o+=i(t,new Date(n+1,0,1))/(r(n)?366:365),o+=i(new Date(a,0,1),e)/(r(a)?366:365)}function f(t){return d=t.getDay(),0===d||6===d}function l(e){var r=e.getDay();if(0===r)return!0;if(6===r)return!0;var n=e.getDate(),i=e.getMonth();if(1===n&&0===i)return!0;if(25===n&&11===i)return!0;var a=e.getFullYear();if((1998===a||1999===a||2001===a)&&31===n&&11===i)return!0;if(a>2e3){if(1===n&&4===i||26===n&&11===i)return!0;var o=function(t){var e=Math.floor,r=e(t/100),n=t-19*e(t/19),i=e((r-17)/25),a=r-e(r/4)-e((r-i)/3)+19*n+15;a-=30*e(a/30),a-=e(a/28)*(1-e(a/28)*e(29/(a+1))*e((21-n)/11));var o=t+e(t/4)+a+2-r+e(r/4),_=a-(o-=7*e(o/7)),s=3+e((_+40)/44),d=_+28-31*e(s/4);return new Date(t,s-1,d)}(a);if(e.getTime()===t.add_days(o,-2).getTime())return!0;if(e.getTime()===t.add_days(o,1).getTime())return!0}return!1}t.period_str_to_time=function(t){var e=parseInt(t),r=t.charAt(t.length-1);if("Y"===r||"y"===r)return e;if("M"===r||"m"===r)return e/12;if("W"===r||"w"===r)return e/52;if("D"===r||"d"===r)return e/365;throw new Error("period_str_to_time(str) - Invalid time period string: "+t)},t.date_str_to_date=function(t){var e,r,i,a=null;if(null!==(a=/^([1-2][0-9]{3})[\/-]([0-9]{1,2})[\/-]([0-9]{1,2})/.exec(t))?(i=parseInt(a[1]),r=parseInt(a[2])-1,e=parseInt(a[3])):null!==(a=/^([0-9]{1,2})\.([0-9]{1,2})\.([1-2][0-9]{3})/.exec(t))&&(i=parseInt(a[3]),r=parseInt(a[2])-1,e=parseInt(a[1])),null===a)throw new Error("date_str_to_time(str) - Invalid date string: "+t);if(r<0||r>11)throw new Error("date_str_to_time(str) - Invalid month in date string: "+t);if(e<0||e>n(i,r))throw new Error("date_str_to_time(str) - Invalid day in date string: "+t);return new Date(i,r,e)},t.get_initialised_date=function(e){if(!e)return null;if(e instanceof Date)return e;if(e instanceof String||"string"==typeof e)return t.date_str_to_date(e);throw new Error("get_initialised_date: invalid input.")},t.year_fraction_factory=function(t){if(!(t instanceof String)&&"string"!=typeof t)return a;var e=t.toLowerCase();if("a"===e.charAt(0)){if("actual/365"===e||"act/365"===e||"a/365"===e||"act/365 (fixed)"===e||"actual/365 (fixed)"===e)return a;if("act/360"===e||"a/360"===e)return o;if("act/act"===e||"a/a"===e)return s}return"3"===e.charAt(0)&&"30e/360"===e?_:a},t.add_days=function(t,e){return new Date(t.valueOf()+864e5*e)},t.add_months=function(t,e,r){for(y=t.getFullYear(),m=t.getMonth()+e;m>=12;)m-=12,y+=1;for(;m<0;)m+=12,y-=1;return d=void 0===r?t.getDate():r,new Date(y,m,Math.min(d,n(y,m)))},t.is_holiday_factory=function(t){return"target"===t.toLowerCase()?l:f},t.adjust=function(e,r,n){var i,a=(r||"u").charAt(0).toLowerCase(),o=new Date(e);if("u"===a)return o;if("m"===a&&(i=o.getMonth()),"m"===a||"f"===a)for(;n(o);)o=t.add_days(o,1);if("f"===a)return o;if("m"===a&&i===o.getMonth())return o;for("m"===a&&(o=t.add_days(o,-1));n(o);)o=t.add_days(o,-1);return o}}(this.JsonRisk||module.exports);