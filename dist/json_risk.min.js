/*! json_risk 24-03-2019 */

!function(t,e){"object"==typeof module&&"undefined"!=typeof exports?module.exports=e():t.JsonRisk=e()}(this,function(){var t={valuation_date:null,pricer:function(t,e){return null}};return t}),function(t){var e=null;function r(r,a){if(!r.times){if(r.days)return r.days[a]/365;if(r.dates)return(e=e||t.year_fraction_factory("a/365"))(t.get_safe_date(r.dates[0]),t.get_safe_date(r.dates[a]));if(r.labels)return t.period_str_to_time(r.labels[a]);throw new Error("get_time_at: invalid curve, cannot derive times")}return r.times[a]}function a(t,e){if(t.dfs)return t.dfs[e];if(t.zcs)return Math.pow(1+t.zcs[e],-r(t,e));throw new Error("get_df: invalid curve, must provide dfs or zcs")}t.get_const_curve=function(t){if("number"!=typeof t)throw new Error("get_const_curve: input must be number.");if(t<=-1)throw new Error("get_const_curve: invalid input.");return{type:"yield",times:[1],dfs:[1/(1+t)]}},t.get_curve_times=function(t){var e=(t.times||t.days||t.dates||t.labels||[]).length;if(!e)throw new Error("get_curve_times: invalid curve, need to provide valid times, days, dates, or labels");for(var a=new Array(e);e>0;)a[--e]=r(t,e);return a},t.get_safe_curve=function(e){return e?{type:"yield",times:t.get_curve_times(e),dfs:function(t){var e=(t.times||t.days||t.dates||t.labels||[]).length;if(!e)throw new Error("get_curve_dfs: invalid curve, need to provide valid times, days, dates, or labels");if(t.dfs){if(t.dfs.length!==e)throw new Error("get_curve_dfs: invalid curve, dfs length must match times length")}else if(t.zcs.length!==e)throw new Error("get_curve_dfs: invalid curve, zcs length must match times length");for(var r=new Array(e);e>0;)if(r[--e]=t.dfs?t.dfs[e]:a(t,e),"number"!=typeof r[e])throw new Error("get_curve_dfs: invalid curve, must provide numeric zcs or dfs");return r}(e)}:t.get_const_curve(0)},t.get_df=function(e,i,n,s){if(void 0===n&&(n=0),void 0===s&&(s=(e.times||e.days||e.dates||e.labels).length-1),i<1/512)return 1;if(n===s)return i===r(e,n)?a(e,n):Math.pow(a(e,n),i/r(e,n));if(i<r(e,n))return Math.pow(a(e,n),i/r(e,n));if(i>r(e,s))return Math.pow(a(e,s),i/r(e,s));if(n+1===s){if(r(e,s)-r(e,n)<1/512)throw new Error("get_df_internal: invalid curve, support points must be increasing and differ at least one day");return a(e,n)*(r(e,s)-i)/(r(e,s)-r(e,n))+a(e,s)*(i-r(e,n))/(r(e,s)-r(e,n))}return imed=Math.ceil((n+s)/2),i>r(e,imed)?t.get_df(e,i,imed,s):t.get_df(e,i,n,imed)},t.get_rate=function(e,r){return r<1/512?0:Math.pow(t.get_df(e,r),-1/r)-1},t.get_fwd_rate=function(e,r,a){return a-r<1/512?0:Math.pow(t.get_df(e,a)/t.get_df(e,r),-1/(a-r))-1}}(this.JsonRisk||module.exports),function(t){t.irregular_fixed_income=function(e){var r=t.get_safe_date(e.maturity);if(!r)throw new Error("irregular_fixed_income: must provide maturity date.");if("number"!=typeof e.notional)throw new Error("irregular_fixed_income: must provide valid notional.");if(this.notional=e.notional,"number"!=typeof e.tenor)throw new Error("irregular_fixed_income: must provide valid tenor.");if(e.tenor<0||e.tenor!==Math.floor(e.tenor))throw new Error("irregular_fixed_income: must provide valid tenor.");var a=e.tenor;this.amortization="string"==typeof e.amortization?e.amortization.toLowerCase():"bullet";var n=e.repay_tenor;if("annuity"===this.amortization||"stepdown"===this.amortization){if(e.repay_tenor<0||e.repay_tenor!==Math.floor(e.repay_tenor))throw new Error("irregular_fixed_income: must provide valid repay_tenor.");n=e.repay_tenor,this.repay_amount=e.repay_amount}else this.repay_amount=0;this.current_accrued_interest=e.current_accrued_interest||0,this.type="string"==typeof e.type?e.type:"unknown",this.is_holiday_func=t.is_holiday_factory(e.calendar||""),this.year_fraction_func=t.year_fraction_factory(e.dcc||""),this.bdc=e.bdc||"";var s=t.get_safe_date(e.effective_date),_=t.get_safe_date(e.first_date),o=t.get_safe_date(e.next_to_last_date),l=t.get_safe_date(e.repay_first_date),f=t.get_safe_date(e.repay_next_to_last_date),u=t.get_safe_date(e.fixing_first_date);t.get_safe_date(e.fixing_next_to_last_date);if(null!=e.conditions_valid_until)for(this.conditions_valid_until=new Array(e.conditions_valid_until.length-1),i=0;i<e.conditions_valid_until;i++)this.conditions_valid_until[i]=t.get_safe_date(e.conditions_valid_until[i]);var d="number"==typeof e.settlement_days?e.settlement_days:0;this.settlement_date=t.adjust(t.add_days(t.valuation_date,d),"following",this.is_holiday_func);"number"==typeof e.residual_spread&&e.residual_spread,e.currency;if("number"==typeof e.fixed_rate||e.fixed_rate.length>1)this.is_float=!1,this.fixed_rate=e.fixed_rate,this.fixing_tenor=0;else{if(this.is_float=!0,this.float_spread="number"==typeof e.float_spread||e.float_spread.length>1?e.float_spread:0,"number"!=typeof e.current_rate)throw new Error("irregular_fixed_income: must provide valid current_rate.");this.current_rate=e.current_rate,this.cap_rate=e.cap_rate,this.floor_rate=e.floor_rate,this.fixing_tenor=e.fixing_tenor,this.fixing_first_date=t.get_safe_date(e.fixing_first_date),this.fixing_next_to_last_date=t.get_safe_date(e.fixing_next_to_last_date)}this.schedule=t.backward_schedule(s,r,a,this.is_holiday_func,this.bdc,_,o),1==this.is_float&&(this.fixing_schedule=t.backward_schedule(this.fixing_first_date,this.fixing_next_to_last_date,this.fixing_tenor,this.is_holiday_func,this.bdc,this.fixing_first_date,this.fixing_next_to_last_date)),this.repay_schedule=t.backward_schedule(s,r,n,this.is_holiday_func,this.bdc,l,f),this.merged_schedule=this.get_merged_schedule(this.schedule,this.repay_schedule,this.is_float,a,this.fixing_tenor,u),this.cash_flows=this.fixflt_cash_flows(this.merged_schedule,this.bdc,this.is_holiday_func,this.year_fraction_func,this.notional,this.is_float?this.current_rate:this.fixed_rate,null)},t.irregular_fixed_income.prototype.fixflt_cash_flows=function(e,r,a,i,n,s,_){if(null===t.valuation_date)throw new Error("fix_cash_flows: valuation_date must be set");t.year_fraction_factory(null);var o=new Array(e.date_accrual_start.length-1),l=new Array(e.date_accrual_start.length-1),f=new Array(e.date_accrual_start.length-1),u=new Array(e.date_accrual_start.length-1),d=new Array(e.date_accrual_start.length-1),c=new Array(e.date_accrual_start.length-1);this.temp_rate=s||s[0],this.temp_notional=n,this.temp_int_accrual=this.current_accrued_interest,this.temp_payment=this.repay_amount||this.repay_amount[0],this.temp_amortization=this.amortization||this.amortization[0],1==this.is_float&&(this.float_rate_series=this.get_fwd_rate_series(_),this.rate_pos=0,null!=this.float_spread&&(this.temp_float_spread=this.float_spread||this.float_spread[0]),null!=this.cap_rate&&(this.temp_cap_rate=this.cap_rate||this.cap_rate[0]),null!=this.floor_rate&&(this.temp_floor_rate=this.floor_rate||this.floor_rate[0]));for(var h=0,p=0;p<e.date_accrual_start.length;p++)1==e.is_condition_date[p]&&(h++,this.temp_amortization=this.amortization[h],this.temp_payment=this.repay_amount[h]),cf_step=this.cf_step(this.temp_notional,this.temp_int_accrual,e.date_accrual_start[p],e.date_accrual_end[p],e.is_interest_date[p],e.is_repay_date[p],e.is_fixing_date[p],e.is_condition_date[p],i,this.temp_rate,this.temp_amortization,this.temp_payment),o[p]=cf_step.current_principal,l[p]=cf_step.interest_current_period,f[p]=cf_step.accrued_interest,u[p]=cf_step.pmt_principal,d[p]=cf_step.pmt_interest,c[p]=cf_step.pmt_principal+cf_step.pmt_interest,1==e.is_condition_date&&(this.temp_amortization=this.amortization[h],this.temp_rate=s[h]?s[h]:this.temp_rate,this.temp_payment=this.repay_amount[h]),1==this.is_float&&(1==e.is_fixing_date[p]&&(this.temp_rate=this.float_rate_series[this.rate_pos],this.rate_pos<this.float_rate_series.length-1&&this.rate_pos++),1==e.is_condition_date[p]&&(this.temp_float_spread=this.float_spread[h],this.temp_cap_rate=this.cap_rate[h],this.temp_floor_rate=this.floor_rate[h]),isNaN(this.temp_floor_rate)&&isNaN(this.temp_cap_rate)?this.temp_rate+=this.temp_float_spread||0:isNaN(this.temp_floor_rate)&&"number"==typeof this.temp_cap_rate?this.temp_rate=Math.max(this.temp_rate,this.temp_cap_rate-(this.temp_float_spread||0))+(this.temp_float_spread||0):isNaN(this.temp_cap_rate)&&"number"==typeof this.temp_floor_rate?this.temp_rate=Math.min(this.temp_rate,this.temp_floor_rate-(this.temp_float_spread||0))+(this.temp_float_spread||0):this.temp_rate=Math.min(Math.max(this.temp_rate,this.temp_floor_rate-(this.temp_float_spread||0)),this.temp_cap_rate-(this.temp_float_spread||0))+(this.temp_spread_spread||0));return{date_accrual_start:e.date_accrual_start,date_accrual_end:e.date_accrual_end,date_pmt:e.date_pmt,t_accrual_start:e.t_accrual_start,t_accrual_end:e.t_accrual_end,t_pmt:e.t_pmt,is_interest_date:e.is_interest_date,is_repay_date:e.is_repay_date,is_fixing_date:e.is_fixing_date,is_condition_date:e.is_condition_date,current_principal:o,interest_current_period:l,accrued_interest:f,pmt_principal:u,pmt_interest:d,pmt_total:c}},t.irregular_fixed_income.prototype.get_cash_flows=function(t){return this.cash_flows},t.irregular_fixed_income.prototype.present_value=function(e,r,a){return t.dcf(this.get_cash_flows(a||null),e,r,this.residual_spread,this.settlement_date)},t.pricer_loan=function(e,r,a,i){return new t.irregular_fixed_income(e).present_value(r,a,i)},t.irregular_fixed_income.prototype.get_merged_schedule=function(e,r,a,i,n,s){for(var _=n/i,o=[],l=0;l<e.length;l++)o.push([e[l],0]);for(var f=0;f<r.length;f++)o.push([r[f],1]);if(null!=this.conditions_valid_until&&this.conditions_valid_until.length>1)for(var u=0;u<this.conditions_valid_until.length-1;u++)o.push([this.conditions_valid_until[u],.5,u]);o.sort(function(t,e){return t[0]>e[0]?1:t[0]<e[0]?-1:0});for(var d=0;d<o.length-1;d++)for(;o[d+1]&&Math.abs(o[d][0]-o[d+1][0])<1e3;)2==o[d].length&&2==o[d+1].length?(o[d]=[o[d][0],2],o.splice(d+1,1)):3==o[d+1].length?(o[d]=[o[d][0],o[d][1],o[d+1][2]],o.splice(d+1,1)):3==o[d].length&&(o[d]=[o[d+1][0],o[d+1][1],o[d][2]],o.splice(d+1,1));if(null===t.valuation_date)throw new Error("fix_cash_flows: valuation_date must be set");for(var c=o.length-1,h=t.year_fraction_factory(null),p=new Array(c),m=new Array(c),v=new Array(c),g=new Array(c),y=new Array(c),w=new Array(c),x=new Array(c),b=new Array(c),E=new Array(c),M=new Array(c),A=function(e){return t.adjust(e,this.bdc,this.is_holiday_func)},z=0;z<c;z++)p[z]=o[z][0],m[z]=o[z+1][0],v[z]=o[z+1][1]<=0||1==o[z+1][1]||o[z+1][1]>=2?A(o[z+1][0]):null,g[z]=h(t.valuation_date,o[z][0]),y[z]=h(t.valuation_date,o[z+1][0]),w[z]=null!=v[z]?h(t.valuation_date,v[z]):null,x[z]=o[z+1][1]<=0||o[z+1][1]>=2,b[z]=1==o[z+1][1]||o[z+1][1]>=2,E[z]=!1,M[z]=3==o[z+1].length;if(1==a){for(var k,D,j=0;j<c;j++)if(1==x[j]&&m[j]-s>1e3){k=j;break}D=2*_-1;for(var T=0;T<c;T++)1==x[T]&&T>=k&&++D%_==0&&(E=!0)}return{date_accrual_start:p,date_accrual_end:m,date_pmt:v,t_accrual_start:g,t_accrual_end:y,t_pmt:w,is_interest_date:x,is_repay_date:b,is_fixing_date:E,is_condition_date:M}},t.irregular_fixed_income.prototype.get_fwd_rate_series=function(e){for(var r=t.year_fraction_factory(null),a=[],i=0;i<this.fixing_schedule.length-1;i++)this.fixing_schedule[i]-t.valuation_date>1e3&&a.push(t.get_fwd_rate(e,r(t.valuation_date,this.fixing_schedule[i]),r(t.valuation_date,this.fixing_schedule[i+1])));return a},t.irregular_fixed_income.prototype.cf_step=function(t,e,r,a,i,n,s,_,o,l,f,u){var d,c,h,p,m,v=0;switch(f){case"bullet":c=e+(h=t*o(r,a)*l),d=t,m=1==i?c+e:0,e=1==_&&0==i?c:0,p=0;break;case"capitalization":c=e+(h=t*o(r,a)*l),d=1==_&&0==i?t:Math.max(t+c,0),e=0==i?c:0,m=0,p=0;break;case"stepdown":c=e+(h=t*o(r,a)*l),d=1==n?Math.max(t-u,0):t,p=1==n?Math.min(u,t):0,m=1==i?c:0,e=0==i?c:0;break;case"annuity":c=e+(h=t*o(r,a)*l),d=1==n&&0==i?Math.max(t-u,0):1==n&&1==i?Math.max(t+c-u,0):0==n&&1==i?Math.max(t+c,0):t,v=1==n?Math.min(u,t+c):0,e=0==i?c:0,p=v,m=0;break;default:throw new Error("invalid amortization type parameter.")}return this.temp_notional=d,this.temp_int_accrual=e,{current_principal:"deposit"==this.type?-t:t,interest_current_period:"deposit"==this.type?-h:h,accrued_interest:"deposit"==this.type?-e:e,pmt_principal:"deposit"==this.type?-p:p,pmt_interest:"deposit"==this.type?-m:m}}}(this.JsonRisk||module.exports),function(t){var e=Math.sqrt(4*Math.acos(0));t.ndf=function(t){return Math.exp(-t*t/2)/e},t.cndf=function(t){var r,a=Math.abs(t);if(a<=37){var i=Math.exp(-a*a/2);if(a<7.07106781186547)r=i*((((((.0352624965998911*a+.700383064443688)*a+6.37396220353165)*a+33.912866078383)*a+112.079291497871)*a+221.213596169931)*a+220.206867912376)/(((((((.0883883476483184*a+1.75566716318264)*a+16.064177579207)*a+86.7807322029461)*a+296.564248779674)*a+637.333633378831)*a+793.826512519948)*a+440.413735824752);else r=i/(e*(a+1/(a+2/(a+3/(a+4/(a+.65))))))}else r=0;return t<=0?r:1-r},t.find_root_secant=function(t,e,r,a,i){for(var n=e,s=r,_=0,o=a||20,l=i||1e-9,f=0,u=1;Math.abs(u)>l&&Math.abs(u-f)>l&&o>0;)f=t(n),_=s,s-=(u=t(s))*(s-n)/(u-f),n=_,o--;if(0===o)throw new Error("find_root_secant: failed, too many iterations");return s}}(this.JsonRisk||module.exports),function(t){t.backward_schedule=function(e,r,a,i,n,s,_){if(!(r instanceof Date))throw new Error("backward_schedule: maturity must be provided");if(!(e instanceof Date)){if(null===t.valuation_date)throw new Error("backward_schedule: if valuation_date is unset, effective date must be provided");if(s instanceof Date)throw new Error("backward_schedule: if first date is provided, effective date must be provided")}if(e instanceof Date&&r<e||t.valuation_date instanceof Date&&r<t.valuation_date)throw new Error("backward_schedule: maturity is before valution or effective date.");if("number"!=typeof a)throw new Error("backward_schedule: tenor must be a nonnegative integer, e.g., 6 for semiannual schedule, 0 for zerobond/iam schedule");if(a<0||Math.floor(a)!==a)throw new Error("backward_schedule: tenor must be a nonnegative integer, e.g., 6 for semiannual schedule, 0 for zerobond/iam schedule");if(0===a)return[e instanceof Date?e:t.valuation_date,r];var o=function(e){return t.adjust(e,n,i)},l=[r],f=r;_ instanceof Date&&o(_)<o(r)&&(l.unshift(_),f=_);for(var u,d=0;;){if(d++,u=t.add_months(f,-a*d),s instanceof Date&&u<s)return o(l[0]).getTime()!==o(s).getTime()&&l.unshift(s),o(l[0]).getTime()!==o(e).getTime()&&l.unshift(e),l;if(e instanceof Date&&u<e)return o(l[0]).getTime()!==o(e).getTime()&&l.unshift(e),l;if(t.valuation_date instanceof Date&&u<t.valuation_date)return l.unshift(u),o(u)>t.valuation_date&&(d++,u=t.add_months(f,-a*d),s instanceof Date&&u<s?l.unshift(s):e instanceof Date&&u<e?l.unshift(e):l.unshift(u)),l;l.unshift(u)}}}(this.JsonRisk||module.exports),function(t){t.dcf=function(e,r,a,i,n){var s=r||t.get_safe_curve(null),_=a||t.get_safe_curve(null);if(null===t.valuation_date)throw new Error("dcf: valuation_date must be set");"number"!=typeof i&&(i=0);var o=t.get_safe_date(n);if(o||(o=t.valuation_date),void 0===e.t_pmt||void 0===e.pmt_total)throw new Error("dcf: invalid cashflow object");if(e.t_pmt.length!==e.pmt_total.length)throw new Error("dcf: invalid cashflow object");for(var l,f,u,d=0,c=0;e.date_pmt[c]<=o;)c++;for(;c<e.t_pmt.length;)l=t.get_df(s,e.t_pmt[c]),f=t.get_df(_,e.t_pmt[c]),u=Math.pow(1+i,-e.t_pmt[c]),d+=e.pmt_total[c]*l*f*u,c++;return d},t.irr=function(e,r,a){if(null===t.valuation_date)throw new Error("irr: valuation_date must be set");void 0===a&&(a=0);var i=t.year_fraction_factory(null)(t.valuation_date,r);return t.find_root_secant(function(n){return t.dcf(e,null,null,n,r)+a*Math.pow(1+n,-i)},0,1e-4)},t.simple_fixed_income=function(e,r){var a=t.get_safe_date(e.maturity);if(!a)throw new Error("simple_fixed_income: must provide maturity date.");if("number"!=typeof e.notional)throw new Error("simple_fixed_income: must provide valid notional.");if(this.notional=e.notional,this.include_notional_pmt=!1!==r,"number"!=typeof e.tenor)throw new Error("simple_fixed_income: must provide valid tenor.");if(e.tenor<0||e.tenor!==Math.floor(e.tenor))throw new Error("simple_fixed_income: must provide valid tenor.");var i=e.tenor;this.type="string"==typeof e.type?e.type:"unknown",this.is_holiday_func=t.is_holiday_factory(e.calendar||""),this.year_fraction_func=t.year_fraction_factory(e.dcc||""),this.bdc=e.bdc||"";var n=t.get_safe_date(e.effective_date),s=t.get_safe_date(e.first_date),_=t.get_safe_date(e.next_to_last_date),o="number"==typeof e.settlement_days?e.settlement_days:0;this.settlement_date=t.adjust(t.add_days(t.valuation_date,o),"following",this.is_holiday_func);"number"==typeof e.residual_spread&&e.residual_spread,e.currency;if("number"==typeof e.fixed_rate)this.is_float=!1,this.fixed_rate=e.fixed_rate;else{if(this.is_float=!0,this.float_spread="number"==typeof e.float_spread?e.float_spread:0,"number"!=typeof e.float_current_rate)throw new Error("simple_fixed_income: must provide valid float_current_rate.");this.current_rate=e.float_current_rate}this.schedule=t.backward_schedule(n,a,i,this.is_holiday_func,this.bdc,s,_),this.cash_flows=this.fix_cash_flows(this.schedule,this.bdc,this.is_holiday_func,this.year_fraction_func,this.notional,this.is_float?this.current_rate:this.fixed_rate)},t.simple_fixed_income.prototype.fix_cash_flows=function(e,r,a,i,n,s){if(null===t.valuation_date)throw new Error("fix_cash_flows: valuation_date must be set");var _,o,l=new Array(e.length-1),f=new Array(e.length-1),u=new Array(e.length-1),d=new Array(e.length-1),c=new Array(e.length-1),h=new Array(e.length-1),p=new Array(e.length-1),m=new Array(e.length-1),v=new Array(e.length-1),g=new Array(e.length-1),y=new Array(e.length-1),w=new Array(e.length-1),x=new Array(e.length-1),b=new Array(e.length-1),E=new Array(e.length-1),M=new Array(e.length-1),A=t.year_fraction_factory(null);for(_=0;_<e.length-1;_++)l[_]=e[_],f[_]=e[_+1],u[_]=(o=e[_+1],t.adjust(o,r,a)),h[_]=A(t.valuation_date,u[_]),d[_]=A(t.valuation_date,e[_]),c[_]=A(t.valuation_date,e[_+1]),p[_]=!0,m[_]=!1,v[_]=!1,g[_]=!1,y[_]=n,w[_]=n*s*i(l[_],f[_]),x[_]=w[_],b[_]=0,E[_]=w[_],M[_]=E[_];return this.include_notional_pmt&&(M[e.length-2]+=n,b[e.length-2]+=n),m[e.length-2]=!0,{date_accrual_start:l,date_accrual_end:f,date_pmt:u,t_accrual_start:d,t_accrual_end:c,t_pmt:h,is_interest_date:p,is_repay_date:m,is_fixing_date:v,is_condition_date:g,current_principal:y,interest_current_period:w,accrued_interest:x,pmt_principal:b,pmt_interest:E,pmt_total:M}},t.simple_fixed_income.prototype.get_cash_flows=function(e){if(!this.is_float)return this.cash_flows;var r,a,i,n=this.cash_flows,s=t.year_fraction_factory(null),_=n.t_pmt.length;for(r=0;r<_;r++)n.is_fixing_date[r]=!0,a=n.date_accrual_start[r]<t.valuation_date?this.current_rate:t.get_fwd_rate(e,s(t.valuation_date,n.date_accrual_start[r]),s(t.valuation_date,n.date_accrual_end[r]))+this.float_spread,i=this.notional*a*this.year_fraction_func(n.date_accrual_start[r],n.date_accrual_end[r]),n.interest_current_period[r]=i,n.accrued_interest[r]=i,n.pmt_interest[r]=i;return n.pmt_total[_-1]=n.pmt_interest[_-1]+this.notional,n},t.simple_fixed_income.prototype.present_value=function(e,r,a){return t.dcf(this.get_cash_flows(t.get_safe_curve(a)||null),t.get_safe_curve(e),t.get_safe_curve(r),this.residual_spread,this.settlement_date)},t.pricer_bond=function(e,r,a){return new t.simple_fixed_income(e).present_value(r,a,null)},t.pricer_floater=function(e,r,a,i){return new t.simple_fixed_income(e).present_value(r,a,i)},t.pricer_fxterm=function(e,r){var a=new t.simple_fixed_income({notional:e.notional,maturity:e.maturity,fixed_rate:0,tenor:0}).present_value(r,null,null);return"number"!=typeof e.notional_2?a:a+new t.simple_fixed_income({notional:e.notional_2,maturity:e.maturity_2,fixed_rate:0,tenor:0}).present_value(r,null,null)}}(this.JsonRisk||module.exports),function(t){function e(e,r){if(e.terms)return e.terms[r];if(e.labels_term)return t.period_str_to_time(e.labels_term[r]);throw new Error("get_term_at: invalid surface, cannot derive terms")}function r(e,r){if(e.expiries)return e.expiries[r];if(e.labels_expiry)return t.period_str_to_time(e.labels_expiry[r]);throw new Error("get_expiry_at: invalid surface, cannot derive expiries")}function a(t,r,i,n,s){n=n||0,s=s||(t.terms||t.labels_term||[]).length-1;var _=t.values[r];return n===s?_[n]:i<e(t,n)?_[n]:i>e(t,s)?_[s]:n+1===s?_[n]*(e(t,s)-i)/(e(t,s)-e(t,n))+_[s]*(i-e(t,n))/(e(t,s)-e(t,n)):(imed=Math.ceil((n+s)/2),i>e(t,imed)?a(t,r,i,imed,s):a(t,r,i,n,imed))}t.get_const_surface=function(t,e){if("number"!=typeof t)throw new Error("get_const_surface: input must be number.");return{type:e||"",expiries:[1],terms:[1],values:[[t]]}},t.get_safe_surface=function(a){return a?{type:a.type||"",expiries:function(t){var e=(t.expiries||t.labels_expiry||[]).length;if(!e)throw new Error("get_surface_terms: invalid surface, need to provide valid expiries or labels_expiry");for(var a=new Array(e);e>0;)a[--e]=r(t,e);return a}(a),terms:function(t){var r=(t.terms||t.labels_term||[]).length;if(!r)throw new Error("get_surface_terms: invalid surface, need to provide valid terms or labels_term");for(var a=new Array(r);r>0;)a[--r]=e(t,r);return a}(a),values:a.values}:t.get_const_surface(0)},t.get_surface_rate=function(e,i,n,s,_){return(s=s||0)===(_=_||(e.expiries||e.labels_expiry||[]).length-1)?a(e,s,n):i<r(e,s)?a(e,s,n):i>r(e,_)?a(e,_,n):s+1===_?a(e,s,n)*(r(e,_)-i)/(r(e,_)-r(e,s))+a(e,_,n)*(i-r(e,s))/(r(e,_)-r(e,s)):(imed=Math.ceil((s+_)/2),i>r(e,imed)?t.get_surface_rate(e,i,n,imed,_):t.get_surface_rate(e,i,n,s,imed))}}(this.JsonRisk||module.exports),function(t){t.swap=function(e){this.phi=e.is_payer?-1:1,this.fixed_rate=e.fixed_rate,this.fixed_leg=new t.simple_fixed_income({notional:e.notional*this.phi,maturity:e.maturity,fixed_rate:e.fixed_rate,tenor:e.fixed_tenor,effective_date:e.effective_date,calendar:e.calendar,bdc:e.fixed_bdc,dcc:e.fixed_dcc},!1),this.fixed_leg_1bp=new t.simple_fixed_income({notional:e.notional*this.phi,maturity:e.maturity,fixed_rate:1e-4,tenor:e.fixed_tenor,effective_date:e.effective_date,calendar:e.calendar,bdc:e.fixed_bdc,dcc:e.fixed_dcc},!1),this.float_leg=new t.simple_fixed_income({notional:-e.notional*this.phi,maturity:e.maturity,float_spread:e.float_spread,tenor:e.float_tenor,effective_date:e.effective_date,calendar:e.calendar,bdc:e.float_bdc,dcc:e.float_dcc,float_current_rate:e.float_current_rate},!1)},t.swap.prototype.present_value=function(t,e){var r=0;return r+=this.fixed_leg.present_value(t,null,null),r+=this.float_leg.present_value(t,null,e)},t.swap.prototype.fair_rate=function(t,e){var r=this.float_leg.present_value(t,null,e);return-this.phi*r/this.annuity(t)},t.swap.prototype.annuity=function(t){return this.fixed_leg_1bp.present_value(t)*this.phi*1e4},t.swap.prototype.present_value=function(t,e){var r=0;return r+=this.fixed_leg.present_value(t,null,null),r+=this.float_leg.present_value(t,null,e)},t.swap.prototype.get_cash_flows=function(t){return{fixed_leg:this.fixed_leg.get_cash_flows(),float_leg:this.float_leg.get_cash_flows(t)}},t.pricer_swap=function(e,r,a){return new t.swap(e).present_value(r,a)}}(this.JsonRisk||module.exports),function(t){t.swaption=function(e){if(this.sign=e.is_short?-1:1,this.maturity=t.get_safe_date(e.maturity),!this.maturity)throw new Error("swaption: must provide valid maturity date.");if(this.expiry=t.get_safe_date(e.expiry),!this.expiry)throw new Error("swaption: must provide valid expiry date.");this.swap=new t.swap(e)},t.swaption.prototype.present_value=function(e,r,a){if(null===t.valuation_date)throw new Error("swaption.present_value: valuation_date must be set");var i=t.year_fraction_factory(null),n=i(t.valuation_date,this.maturity),s=i(t.valuation_date,this.expiry),_=n-s;if(_<1/512)return 0;var o,l=this.swap.fair_rate(e,r),f=t.get_surface_rate(a,s,_)*Math.sqrt(s);if(s<1/512||f<1e-4)o=Math.max(this.swap.phi*(this.swap.fixed_rate-l),0);else{var u=(this.swap.fixed_rate-l)/f;o=this.swap.phi*(this.swap.fixed_rate-l)*t.cndf(this.swap.phi*u)+f*t.ndf(u)}return o*=this.swap.annuity(e),o*=this.sign},t.pricer_swaption=function(e,r,a,i){return new t.swaption(e).present_value(r,a,i)},t.create_equivalent_regular_swaption=function(e,r,a){if(void 0===e.date_pmt||void 0===e.pmt_total||void 0===e.current_principal)throw new Error("create_equivalent_regular_swaption: invalid cashflow object");if(e.t_pmt.length!==e.pmt_total.length||e.t_pmt.length!==e.current_principal.length)throw new Error("create_equivalent_regular_swaption: invalid cashflow object");if(null===t.valuation_date)throw new Error("create_equivalent_swaption: valuation_date must be set");a||(a={});var i,n=a.tenor||6,s=a.bdc||"unadjusted",_=a.calendar||"",o=0;for(i=0;i<e.current_principal.length;i++)e.date_pmt[i]<=r&&(o=e.current_principal[i]);if(0===o)throw new Error("create_equivalent_regular_swaption: invalid cashflow object or expiry, zero outstanding principal");var l=t.irr(e,r,-o);l=12/n*(Math.pow(1+l,n/12)-1);for(var f=t.get_const_curve(l+1e-4),u=t.get_const_curve(l-1e-4),d=t.dcf(e,f,null,null,r),c=t.dcf(e,u,null,null,r),h=1e4*(c-d)/(c+d),p=function(e){var r=new t.simple_fixed_income(e);return d=r.present_value(f),1e4*((c=r.present_value(u))-d)/(c+d)},m=Math.abs(l)<1e-8?h:-Math.log(1-h*l)/l,v=t.add_days(t.valuation_date,Math.round(365*m)),g={maturity:v,effective_date:r,settlement_date:r,notional:o,fixed_rate:l,tenor:n,calendar:_,bdc:s,dcc:"act/365"},y=p(g),w=20;Math.abs(y-h)>1/512&&w>0;)m=m*h/y,v=t.add_days(t.valuation_date,Math.round(365*m)),g.maturity=v,y=p(g),w--;return{is_payer:!1,maturity:v,expiry:r,notional:o,fixed_rate:l,fixed_tenor:n,float_spread:0,float_tenor:6,float_current_rate:0,calendar:_,fixed_bdc:s,float_bdc:s,fixed_dcc:"act/365",float_dcc:"act/365"}}}(this.JsonRisk||module.exports),function(t){var e=1/864e5;function r(t){return t%4==0&&(2e3===t||t%100!=0)}function a(t,e){return 1===e?r(t)?29:28:3===e||5===e||8===e||10===e?30:31}function i(t,r){return Math.round((r-t)*e)}function n(t,e){return i(t,e)/365}function s(t,e){return i(t,e)/360}function _(t,e){return(360*(e.getFullYear()-t.getFullYear())+30*(e.getMonth()-t.getMonth())+(Math.min(e.getDate(),30)-Math.min(t.getDate(),30)))/360}function o(t,e){if(t-e==0)return 0;if(t>e)return-o(e,t);var a=t.getFullYear(),n=e.getFullYear();if(a===n)return i(e,t)/(r(a)?366:365);var s=n-a-1;return s+=i(t,new Date(a+1,0,1))/(r(a)?366:365),s+=i(new Date(n,0,1),e)/(r(n)?366:365)}function l(t){return wd=t.getDay(),0===wd||6===wd}function f(e){if(l(e))return!0;var r=e.getDate(),a=e.getMonth();if(1===r&&0===a)return!0;if(25===r&&11===a)return!0;var i=e.getFullYear();if((1998===i||1999===i||2001===i)&&31===r&&11===a)return!0;if(i>2e3){if(1===r&&4===a||26===r&&11===a)return!0;var n=function(t){var e=Math.floor,r=e(t/100),a=t-19*e(t/19),i=e((r-17)/25),n=r-e(r/4)-e((r-i)/3)+19*a+15;n-=30*e(n/30),n-=e(n/28)*(1-e(n/28)*e(29/(n+1))*e((21-a)/11));var s=t+e(t/4)+n+2-r+e(r/4),_=n-(s-=7*e(s/7)),o=3+e((_+40)/44),l=_+28-31*e(o/4);return new Date(t,o-1,l)}(i);if(e.getTime()===t.add_days(n,-2).getTime())return!0;if(e.getTime()===t.add_days(n,1).getTime())return!0}return!1}t.period_str_to_time=function(t){var e=parseInt(t,10),r=t.charAt(t.length-1);if("Y"===r||"y"===r)return e;if("M"===r||"m"===r)return e/12;if("W"===r||"w"===r)return e/52;if("D"===r||"d"===r)return e/365;throw new Error("period_str_to_time(str) - Invalid time period string: "+t)},t.date_str_to_date=function(t){var e,r,i,n=null;if(null!==(n=/^([1-2][0-9]{3})[\/-]([0-9]{1,2})[\/-]([0-9]{1,2})/.exec(t))?(i=parseInt(n[1],10),r=parseInt(n[2],10)-1,e=parseInt(n[3],10)):null!==(n=/^([0-9]{1,2})\.([0-9]{1,2})\.([1-2][0-9]{3})/.exec(t))&&(i=parseInt(n[3],10),r=parseInt(n[2],10)-1,e=parseInt(n[1],10)),null===n)throw new Error("date_str_to_time(str) - Invalid date string: "+t);if(r<0||r>11)throw new Error("date_str_to_time(str) - Invalid month in date string: "+t);if(e<0||e>a(i,r))throw new Error("date_str_to_time(str) - Invalid day in date string: "+t);return new Date(i,r,e)},t.get_safe_date=function(e){if(!e)return null;if(e instanceof Date)return e;if(e instanceof String||"string"==typeof e)return t.date_str_to_date(e);throw new Error("get_safe_date: invalid input.")},t.year_fraction_factory=function(t){if(!(t instanceof String)&&"string"!=typeof t)return n;var e=t.toLowerCase();if("a"===e.charAt(0)){if("actual/365"===e||"act/365"===e||"a/365"===e||"act/365 (fixed)"===e||"actual/365 (fixed)"===e)return n;if("act/360"===e||"a/360"===e)return s;if("act/act"===e||"a/a"===e)return o}return"3"===e.charAt(0)&&"30e/360"===e?_:n},t.add_days=function(t,e){var r=new Date(t.valueOf());return r.setDate(r.getDate()+e),r},t.add_months=function(t,e,r){for(y=t.getFullYear(),m=t.getMonth()+e;m>=12;)m-=12,y+=1;for(;m<0;)m+=12,y-=1;return d=void 0===r?t.getDate():r,new Date(y,m,Math.min(d,a(y,m)))};var u={};t.add_calendar=function(r,a){if(!(r instanceof String||"string"==typeof r))throw new Error("add_calendar: invalid input.");if(!Array.isArray(a))throw new Error("add_calendar: invalid input.");var i,n,s,_=a.length,o=[];for(i=0;i<_;i++)(s=t.get_safe_date(a[i]))&&(l(s)||o.push(s));for(_=o.length,i=1;i<41&&!((n=i*i-i+41)>=_/10);)i++;var f=new Array(n);for(i=0;i<n;i++)f[i]=[];for(i=0;i<_;i++)f[Math.floor(o[i].getTime()*e)%n].push(o[i].getTime());return u[r.toLowerCase()]=f,n},t.is_holiday_factory=function(t){var r=t.toLowerCase();if("target"===r)return f;if(Array.isArray(u[r])){var a=u[r];return function(t){if(l(t))return!0;for(var r=t.getTime(),i=Math.floor(r*e)%a.length,n=0;n<a[i].length;n++)if(r===a[i][n])return!0;return!1}}return l},t.adjust=function(e,r,a){var i,n=(r||"u").charAt(0).toLowerCase(),s=new Date(e);if("u"===n)return s;if("m"===n&&(i=s.getMonth()),"m"===n||"f"===n)for(;a(s);)s=t.add_days(s,1);if("f"===n)return s;if("m"===n&&i===s.getMonth())return s;for("m"===n&&(s=t.add_days(s,-1));a(s);)s=t.add_days(s,-1);return s}}(this.JsonRisk||module.exports),function(t){var e=null,r=function(t){if(1!==t)if(1!==e.vector_length){if(t!==e.vector_length)throw new Error("vector_pricing: parameters need to have the same length or length one")}else e.vector_length=t};t.store_params=function(a){var i,n,s,_,o,l,f,u;if((e={vector_length:1}).valuation_date=a.valuation_date||null,"object"==typeof a.scalars)for(e.scalars={},i=Object.keys(a.scalars),n=0;n<i.length;n++)e.scalars[i[n]]=(s=a.scalars[i[n]],Array.isArray(s.value)?{value:s.value}:{value:[s.value]}),r(e.scalars[i[n]].value.length);if("object"==typeof a.curves)for(e.curves={},i=Object.keys(a.curves),n=0;n<i.length;n++)l=a.curves[i[n]],_={times:t.get_curve_times(l),dfs:l.dfs?Array.isArray(l.dfs[0])?l.dfs:[l.dfs]:null,zcs:l.zcs?Array.isArray(l.zcs[0])?l.zcs:[l.zcs]:null},e.curves[i[n]]=_,o=_.dfs?_.dfs.length:_.zcs.length,r(o);if("object"==typeof a.surfaces)for(e.surfaces={},i=Object.keys(a.surfaces),n=0;n<i.length;n++)e.surfaces[i[n]]=(f=a.surfaces[i[n]],void 0,{expiries:(u=t.get_safe_surface(f)).expiries,terms:u.terms,values:Array.isArray(f.values[0][0])?f.values:[f.values]}),r(e.surfaces[i[n]].values.length)},t.get_params=function(){return e};t.vector_pricer=function(r){for(var a,i,n,s=e.curves[r.disc_curve],_=new t.simple_fixed_income(r),o=new Array(e.vector_length),l=0;l<e.vector_length;l++)n=l,a={times:(i=s).times,dfs:i.dfs?i.dfs[i.dfs.length>1?n:0]:null,zcs:i.zcs?i.zcs[i.zcs.length>1?n:0]:null},o[l]=_.present_value(a,null,null);return o}}(this.JsonRisk||module.exports);