/*! json_risk 01-02-2020 */

!function(t,e){"object"==typeof module&&"undefined"!=typeof exports?module.exports=e():t.JsonRisk=e()}(this,function(){var t={valuation_date:null,require_vd:function(){if(!(t.valuation_date instanceof Date))throw new Error("JsonRisk: valuation_date must be set")}};return t}),function(t){t.callable_fixed_income=function(e){if("number"!=typeof e.fixed_rate)throw new Error("callable_fixed_income: must provide valid fixed_rate.");var r,a=t.get_safe_date(e.first_call_date);if(null===a)throw new Error("callable_fixed_income: must provide first call date");for(this.base=new t.fixed_income(e),this.call_schedule=t.schedule(a,t.get_safe_date(e.maturity),e.call_tenor||0,this.base.adj),this.call_schedule.pop(),this.opportunity_spread="number"==typeof e.opportunity_spread?e.opportunity_spread:0,this.basket=new Array(this.call_schedule.length),r=0;r<this.call_schedule.length;r++)this.basket[r]=new t.swaption({is_payer:!1,maturity:e.maturity,expiry:this.call_schedule[r],notional:e.notional,fixed_rate:e.fixed_rate-this.opportunity_spread,tenor:e.tenor,float_spread:0,float_tenor:6,float_current_rate:0,calendar:e.calendar,bdc:e.bdc,float_bdc:e.bdc,dcc:e.dcc,float_dcc:e.dcc})},t.callable_fixed_income.prototype.present_value=function(e,r,a,n){var i,s=0;t.require_vd();var o,_=[];for(i=0;i<this.call_schedule.length;i++)(o=t.time_from_now(this.call_schedule[i]))>1/512&&_.push(o);if("object"!=typeof a||null===a)throw new Error("callable_fixed_income.present_value: must provide forward curve for calibration");if("object"!=typeof n||null===n)throw new Error("callable_fixed_income.present_value: must provide valid surface");var l=t.lgm_calibrate(this.basket,e,a,n);return 1===l.length?s=-t.lgm_european_call_on_cf(this.base.get_cash_flows(),_[0],e,l[0],r,this.base.residual_spread,this.opportunity_spread):1<l.length&&(s=-t.lgm_bermudan_call_on_cf(this.base.get_cash_flows(),_,e,l,r,this.base.residual_spread,this.opportunity_spread)),s+=this.base.present_value(e,r,null)},t.pricer_callable_bond=function(e,r,a,n,i){return new t.callable_fixed_income(e).present_value(r,a,n,i)}}(this.JsonRisk||module.exports),function(t){var e=null;function r(r,a){if(!r.times){if(r.days)return r.days[a]/365;if(r.dates)return(e=e||t.year_fraction_factory("a/365"))(t.get_safe_date(r.dates[0]),t.get_safe_date(r.dates[a]));if(r.labels)return t.period_str_to_time(r.labels[a]);throw new Error("get_time_at: invalid curve, cannot derive times")}return r.times[a]}function a(t,e){if(Array.isArray(t.dfs))return t.dfs[e];if(Array.isArray(t.zcs))return Math.pow(1+t.zcs[e],-r(t,e));throw new Error("get_df: invalid curve, must provide dfs or zcs")}t.get_const_curve=function(t){if("number"!=typeof t)throw new Error("get_const_curve: input must be number.");if(t<=-1)throw new Error("get_const_curve: invalid input.");return{type:"yield",times:[1],dfs:[1/(1+t)]}},t.get_curve_times=function(t){var e=(t.times||t.days||t.dates||t.labels||[]).length;if(!e)throw new Error("get_curve_times: invalid curve, need to provide valid times, days, dates, or labels");for(var a=new Array(e);e>0;)a[--e]=r(t,e);return a},t.get_safe_curve=function(e){return e?{type:"yield",times:t.get_curve_times(e),dfs:function(t){var e=(t.times||t.days||t.dates||t.labels||[]).length;if(!e)throw new Error("get_curve_dfs: invalid curve, need to provide valid times, days, dates, or labels");if(t.dfs){if(t.dfs.length!==e)throw new Error("get_curve_dfs: invalid curve, dfs length must match times length")}else if(t.zcs.length!==e)throw new Error("get_curve_dfs: invalid curve, zcs length must match times length");for(var r=new Array(e);e>0;)if(r[--e]=t.dfs?t.dfs[e]:a(t,e),"number"!=typeof r[e])throw new Error("get_curve_dfs: invalid curve, must provide numeric zcs or dfs");return r}(e)}:t.get_const_curve(0)},t.get_df=function(e,n,i,s){if(void 0===i&&(i=0),void 0===s&&(s=(e.times||e.days||e.dates||e.labels).length-1),n<1/512)return 1;if(i===s)return n===r(e,i)?a(e,i):Math.pow(a(e,i),n/r(e,i));if(n<r(e,i))return Math.pow(a(e,i),n/r(e,i));if(n>r(e,s))return Math.pow(a(e,s),n/r(e,s));if(i+1===s){if(r(e,s)-r(e,i)<1/512)throw new Error("get_df_internal: invalid curve, support points must be increasing and differ at least one day");return a(e,i)*(r(e,s)-n)/(r(e,s)-r(e,i))+a(e,s)*(n-r(e,i))/(r(e,s)-r(e,i))}return imed=Math.ceil((i+s)/2),n>r(e,imed)?t.get_df(e,n,imed,s):t.get_df(e,n,i,imed)},t.get_rate=function(e,r){return r<1/512?0:Math.pow(t.get_df(e,r),-1/r)-1},t.get_fwd_rate=function(e,r,a){return a-r<1/512?0:Math.pow(t.get_df(e,a)/t.get_df(e,r),-1/(a-r))-1},t.add_curves=function(e,r){for(var a,n=t.get_curve_times(e),i=t.get_curve_times(r),s=[],o=0,_=0,l=[];a=Number.POSITIVE_INFINITY,o<n.length&&(a=Math.min(n[o],a)),_<i.length&&(a=Math.min(i[_],a)),s.push(a),l.push(t.get_rate(e,a)+t.get_rate(r,a)),a===n[o]&&o<n.length&&o++,a===i[_]&&_<i.length&&_++,o!==n.length||_!==i.length;);return{times:s,zcs:l}}}(this.JsonRisk||module.exports),function(t){t.dcf=function(e,r,a,n,i){var s=r||t.get_safe_curve(null),o=a||t.get_safe_curve(null);t.require_vd(),"number"!=typeof n&&(n=0);var _=t.get_safe_date(i);if(_||(_=t.valuation_date),void 0===e.t_pmt||void 0===e.pmt_total)throw new Error("dcf: invalid cashflow object");if(e.t_pmt.length!==e.pmt_total.length)throw new Error("dcf: invalid cashflow object");for(var l,u,f,d=0,c=0;e.date_pmt[c]<=_;)c++;for(;c<e.t_pmt.length;)l=t.get_df(s,e.t_pmt[c]),u=t.get_df(o,e.t_pmt[c]),f=Math.pow(1+n,-e.t_pmt[c]),d+=e.pmt_total[c]*l*u*f,c++;return d},t.irr=function(e,r,a){t.require_vd(),a||(a=0);var n=t.time_from_now(r);return t.find_root_secant(function(i){return t.dcf(e,null,null,i,r)+a*Math.pow(1+i,-n)},0,1e-4)}}(this.JsonRisk||module.exports),function(t){t.fixed_income=function(e){var r=t.get_safe_date(e.maturity);if(!r)throw new Error("fixed_income: must provide maturity date.");var a=t.get_safe_date(e.effective_date);if("number"!=typeof e.notional)throw new Error("fixed_income: must provide valid notional.");this.notional=e.notional,this.notional_exchange=!1!==e.notional_exchange;var n=t.get_safe_natural(e.tenor);if(null===n)throw new Error("fixed_income: must provide valid tenor.");var i=t.get_safe_date(e.first_date),s=t.get_safe_date(e.next_to_last_date),o=e.stub_end||!1,_=e.stub_long||!1;this.current_accrued_interest=e.current_accrued_interest||0,this.type="string"==typeof e.type?e.type:"unknown",this.is_holiday_func=t.is_holiday_factory(e.calendar||""),this.year_fraction_func=t.year_fraction_factory(e.dcc||""),this.bdc=e.bdc||"",this.adjust_accrual_periods=e.adjust_accrual_periods||!1,this.adj=function(e){return t.adjust(e,this.bdc,this.is_holiday_func)};var l=t.get_safe_natural(e.repay_tenor);null===l&&(l=n);var u=e.linear_amortization||!1;this.repay_amount="number"==typeof e.repay_amount?e.repay_amount:0,this.interest_capitalization=!0===e.interest_capitalization;var f,d=t.get_safe_date(e.repay_first_date)||this.first_date,c=t.get_safe_date(e.repay_next_to_last_date)||this.next_to_last_date,h=e.stub_end||!1,p=e.stub_long||!1;if(Array.isArray(e.conditions_valid_until)){for(this.conditions_valid_until=new Array(e.conditions_valid_until.length-1),f=0;f<this.conditions_valid_until.length;f++)if(this.conditions_valid_until[f]=t.get_safe_date(e.conditions_valid_until[f]),!this.conditions_valid_until[f])throw new Error("fixed_income: invalid set of dates provided under conditions_valid_until.");if(this.conditions_valid_until[f-1].getTime()!==r.getTime())throw new Error("fixed_income: last date provided under conditions_valid_until must match maturity")}else this.conditions_valid_until=[r];var m=t.get_safe_natural(e.settlement_days)||0;this.settlement_date=t.add_business_days(t.valuation_date,m,this.is_holiday_func),this.residual_spread="number"==typeof e.residual_spread?e.residual_spread:0;e.currency;if(this.schedule=t.schedule(a,r,n,this.adj,i,s,o,_),"number"==typeof e.fixed_rate)this.is_float=!1,this.fixed_rate=e.fixed_rate,this.float_spread=0,this.cap_rate=0,this.floor_rate=0,this.fixing_schedule=[this.schedule[0],r];else{if(this.is_float=!0,this.fixed_rate=null,this.float_spread="number"==typeof e.float_spread?e.float_spread:0,"number"!=typeof e.float_current_rate)throw new Error("fixed_income: must provide valid float_current_rate.");this.float_current_rate=e.float_current_rate;var g=t.get_safe_natural(e.fixing_tenor);null===g&&(g=n);var v=t.get_safe_date(e.fixing_first_date)||this.first_date,w=t.get_safe_date(e.fixing_next_to_last_date)||this.next_to_last_date;e.fixing_stub_end,e.fixing_stub_long;this.cap_rate="number"==typeof e.cap_rate?e.cap_rate:Number.POSITIVE_INFINITY,this.floor_rate="number"==typeof e.floor_rate?e.floor_rate:Number.POSITIVE_INFINITY,this.fixing_schedule=t.schedule(this.schedule[0],r,g,this.adj,v,w)}0!==this.repay_amount||this.interest_capitalization||u?this.repay_schedule=t.schedule(this.schedule[0],r,l,this.adj,d,c,h,p):this.repay_schedule=[this.schedule[0],r],u&&(this.repay_amount=this.notional/(this.repay_schedule.length-1)),this.cash_flows=this.initialize_cash_flows(),this.is_float||(this.cash_flows=this.finalize_cash_flows(null))},t.fixed_income.prototype.initialize_cash_flows=function(){t.require_vd();for(var e=new Array(this.schedule.length-1),r=new Array(this.schedule.length-1),a=new Array(this.schedule.length-1),n=new Array(this.schedule.length-1),i=new Array(this.schedule.length-1),s=new Array(this.schedule.length-1),o=0,_=1,l=1,u=1,f=0;e[o]=o>0?r[o-1]:this.schedule[0],r[o]=new Date(Math.min(this.schedule[_],this.repay_schedule[l],this.fixing_schedule[u],this.conditions_valid_until[f])),_<this.schedule.length&&r[o].getTime()===this.schedule[_].getTime()?(a[o]=!0,_++):a[o]=!1,l<this.repay_schedule.length&&r[o].getTime()===this.repay_schedule[l].getTime()?(n[o]=!0,l++):n[o]=!1,u<this.fixing_schedule.length&&r[o].getTime()===this.fixing_schedule[u].getTime()?(i[o]=!0,u++):i[o]=!1,f<this.conditions_valid_until.length&&r[o].getTime()===this.conditions_valid_until[f].getTime()?(s[o]=!0,f++):s[o]=!1,_!==this.schedule.length||l!==this.repay_schedule.length||u!==this.fixing_schedule.length;)o++;var d=new Array(e.length),c=new Array(e.length),h=new Array(e.length),p=new Array(e.length),m=new Array(e.length),g=new Array(e.length),v=new Array(e.length),w=new Array(e.length),y=new Array(e.length),b=new Array(e.length),x=new Array(e.length);for(o=0;o<e.length;o++)this.adjust_accrual_periods&&(e[o]=this.adj(e[o]),r[o]=this.adj(r[o])),d[o]=this.adj(r[o]),p[o]=t.time_from_now(d[o]),c[o]=t.time_from_now(e[o]),h[o]=t.time_from_now(r[o]),g[o]=this.year_fraction_func(e[o],r[o]);return{date_accrual_start:e,date_accrual_end:r,date_pmt:d,t_accrual_start:c,t_accrual_end:h,t_pmt:p,is_interest_date:a,is_repay_date:n,is_fixing_date:i,is_condition_date:s,accrual_factor:g,current_principal:m,interest_current_period:v,accrued_interest:w,pmt_principal:y,pmt_interest:b,pmt_total:x}},t.fixed_income.prototype.finalize_cash_flows=function(e,r){t.require_vd();t.year_fraction_factory(null);for(var a=this.cash_flows,n=a.date_accrual_start.length,i=new Array(n),s=new Array(n),o=new Array(n),_=new Array(n),l=new Array(n),u=new Array(n),f=this.notional>=0?1:-1,d=0;this.conditions_valid_until[d]<a.date_accrual_start[0];)d++;var c,h,p,m,g="number"==typeof this.repay_amount?this.repay_amount:this.repay_amount[d],v="boolean"==typeof this.interest_capitalization?this.interest_capitalization:this.interest_capitalization[d];"number"==typeof this.cap_rate?this.cap_rate:this.cap_rate[d],"number"==typeof this.floor_rate?this.floor_rate:this.floor_rate[d];if(this.is_float){var w=this.float_spread;h="number"==typeof w?function(){return w}:function(){return w[d]}}else{var y=this.fixed_rate;h="number"==typeof y?function(){return y}:function(){return y[d]}}if("number"==typeof r&&(h=function(){return r}),this.is_float)if(a.date_accrual_start[0]<=t.valuation_date)c=this.float_current_rate;else{for(p=0;!a.is_fixing_date[p]&&p<a.is_fixing_date.length;)p++;c=t.get_fwd_rate(e,a.t_accrual_start[0],a.t_accrual_end[p])+h()}else c=h();for(m=0;m<n;m++)if(i[m]=m>0?i[m-1]-_[m-1]:this.notional,a.is_repay_date[m]?_[m]=g*f:_[m]=0,s[m]=i[m]*c*a.accrual_factor[m],o[m]=(m>0?o[m-1]:0)+s[m],a.is_interest_date[m]?(l[m]=o[m],o[m]=0,v&&(_[m]=_[m]-l[m])):l[m]=0,(m<n-1&&_[m]*f>i[m]*f||m===n-1)&&(_[m]=i[m]),u[m]=l[m],!0===this.notional_exchange&&(u[m]+=_[m]),a.is_condition_date[m]&&(d++,g="number"==typeof this.repay_amount?this.repay_ampount:this.repay_amount[d],v="boolean"==typeof this.interest_capitalization?this.interest_capitalization:this.interest_capitalization[d],"number"==typeof this.cap_rate?this.cap_rate:this.cap_rate[d],"number"==typeof this.floor_rate?this.floor_rate:this.floor_rate[d]),this.is_float){if(a.date_accrual_start[m]<=t.valuation_date)c=this.float_current_rate;else if(a.is_fixing_date[m]){for(p=0;!a.is_fixing_date[m+p]&&m+p<a.is_fixing_date.length;)p++;c=t.get_fwd_rate(e,a.t_accrual_start[m],a.t_accrual_end[m+p])+h()}}else c=h();return{date_accrual_start:a.date_accrual_start,date_accrual_end:a.date_accrual_end,date_pmt:a.date_pmt,t_accrual_start:a.t_accrual_start,t_accrual_end:a.t_accrual_end,t_pmt:a.t_pmt,is_interest_date:a.is_interest_date,is_repay_date:a.is_repay_date,is_fixing_date:a.is_fixing_date,is_condition_date:a.is_condition_date,accrual_factor:a.accrual_factor,current_principal:i,interest_current_period:s,accrued_interest:o,pmt_principal:_,pmt_interest:l,pmt_total:u}},t.fixed_income.prototype.get_cash_flows=function(t){if(this.is_float){if("object"!=typeof t||null===t)throw new Error("fixed_income.get_cash_flows: Must provide forward curve when evaluating floating rate interest stream");return this.finalize_cash_flows(t)}return this.cash_flows},t.fixed_income.prototype.present_value=function(e,r,a){return t.dcf(this.get_cash_flows(t.get_safe_curve(a)||null),t.get_safe_curve(e),t.get_safe_curve(r),this.residual_spread,this.settlement_date)},t.fixed_income.prototype.fair_rate_or_spread=function(e,r,a){t.require_vd();for(var n,i=t.get_safe_curve(a)||t.get_const_curve(0),s=this.get_cash_flows(i),o=0;s.date_pmt[o]<=t.valuation_date;)o++;return n=s.current_principal[o]-t.dcf(s,e,r,this.residual_spread,this.settlement_date),n/=this.annuity(e,r,i),n+=this.is_float?this.float_spread:this.fixed_rate},t.fixed_income.prototype.annuity=function(e,r,a){var n,i=this.get_cash_flows(t.get_safe_curve(a)||t.get_const_curve(0)),s=new Array(i.pmt_total.length),o=0;for(n=0;n<s.length;n++)s[n]=0,o+=i.current_principal[n]*i.accrual_factor[n],i.is_interest_date[n]&&(s[n]+=o,o=0);return t.dcf({date_pmt:i.date_pmt,t_pmt:i.t_pmt,pmt_total:s},t.get_safe_curve(e),t.get_safe_curve(r),this.residual_spread,this.settlement_date)},t.pricer_irregular_bond=function(e,r,a,n){return new t.fixed_income(e).present_value(r,a,n)},t.pricer_bond=function(e,r,a){return new t.fixed_income(e).present_value(r,a,null)},t.pricer_floater=function(e,r,a,n){return new t.fixed_income(e).present_value(r,a,n)}}(this.JsonRisk||module.exports),function(t){t.fxterm=function(e){this.near_leg=new t.fixed_income({notional:e.notional,maturity:e.maturity,fixed_rate:0,tenor:0}),"number"==typeof e.notional_2&&t.get_safe_date(e.maturity_2)?this.far_leg=new t.fixed_income({notional:e.notional_2,maturity:e.maturity_2,fixed_rate:0,tenor:0}):this.far_leg=null},t.fxterm.prototype.present_value=function(t){var e=0;return e+=this.near_leg.present_value(t,null,null),this.far_leg&&(e+=this.far_leg.present_value(t,null,null)),e},t.pricer_fxterm=function(e,r){return new t.fxterm(e).present_value(r)}}(this.JsonRisk||module.exports),function(t){"use strict";function e(t){return t}var r=function(e,r,a,n){if(!n)return 0;for(var i,s=0,o=0;e.t_pmt[s]<=r;)s++;for(;s<e.t_pmt.length;)i=t.get_df(a,e.t_pmt[s]),spread_curve&&(i*=t.get_df(spread_curve,-e.t_pmt[s])),residual_spread&&(i*=Math.pow(1+residual_spread,-e.t_pmt[s])),o+=e.current_principal[s]*i*n*(e.t_pmt[s]-Math.max(e.t_pmt[s-1],r)),s++;return i=t.get_df(a,r),spread_curve&&(i*=t.get_df(spread_curve,r)),residual_spread&&(i*=Math.pow(1+residual_spread,-r)),o/=i};t.lgm_dcf=function(a,n,i,s,o,_,l,u){if(!Array.isArray(o))throw new Error("lgm_dcf: state variable must be an array of numbers");for(var f,d,c,h=0,p=new Array(o.length);a.t_pmt[h]<=n;)h++;var m=0;a.pmt_interest&&(m=0===h?0:a.pmt_interest[h]*(n-a.t_pmt[h-1])/(a.t_pmt[h]-a.t_pmt[h-1])),d=t.get_df(i,n),_&&(d*=t.get_df(_,n)),l&&(d*=Math.pow(1+l,-n));var g=r(a,n,i,u);for(f=0;f<o.length;f++)p[f]=-(a.current_principal[h]+m+g)*d;for(;h<a.t_pmt.length;){for(d=t.get_df(i,a.t_pmt[h]),_&&(d*=t.get_df(_,a.t_pmt[h])),l&&(d*=Math.pow(1+l,-a.t_pmt[h])),c=e(a.t_pmt[h])-e(n),f=0;f<o.length;f++)p[f]+=a.pmt_total[h]*d*Math.exp(-c*o[f]-c*c*s*.5);h++}return p},t.lgm_european_call_on_cf=function(a,n,i,s,o,_,l){if(n<0)return 0;if(n<1/512||s<1e-15)return Math.max(0,t.lgm_dcf(a,n,i,0,[0],o,_,l)[0]);function u(e){return t.lgm_dcf(a,n,i,s,[e],o,_,l)[0]}var f,d,c,h,p,m=Math.sqrt(s),g=1/m,v=a.t_pmt[a.t_pmt.length-1];if(d=e(a.t_pmt[a.t_pmt.length-1])-e(n),c=-.5*s*d,c-=Math.log(t.get_df(i,n))/d,c+=Math.log(t.get_df(i,v))/d,o&&(c-=Math.log(t.get_df(o,n))/d,c+=Math.log(t.get_df(o,v))/d),_&&(c+=n*_,c-=v*_),c>-1e-10&&(c=-m),u(c)>0)for(p=c,h=.9*c;u(h)>0;)h=p-2*h;else for(h=c,p=2*c;u(h)<0;)p*=2;f=t.find_root_ridders(u,p,h,100);for(var w,y=0;a.t_pmt[y]<=n;)y++;var b=0;a.pmt_interest&&(b=0===y?0:a.pmt_interest[y]*(n-a.t_pmt[y-1])/(a.t_pmt[y]-a.t_pmt[y-1])),w=t.get_df(i,n),o&&(w*=t.get_df(o,n)),_&&(w*=Math.pow(1+_,-n));for(var x=r(a,n,i,l),M=-(a.current_principal[y]+b+x)*w*t.cndf(f*g);y<a.t_pmt.length;)w=t.get_df(i,a.t_pmt[y]),o&&(w*=t.get_df(o,a.t_pmt[y])),_&&(w*=Math.pow(1+_,-a.t_pmt[y])),d=e(a.t_pmt[y])-e(n),M+=a.pmt_total[y]*w*t.cndf(f*g+d*m),y++;return M},t.lgm_european_swaption_adjusted_cashflow=function(t,e,r,a){var n,i=t.swap.fair_rate(e,e);if(a)n=i;else{var s=t.swap.fair_rate(e,r);n=t.swap.fixed_rate-s+i}var o=t.swap.fixed_leg.finalize_cash_flows(null,n);return o.pmt_total[o.pmt_total.length-1]+=o.current_principal[o.pmt_total.length-1],o},t.lgm_european_swaption=function(e,r,a,n,i){var s=t.lgm_european_swaption_adjusted_cashflow(e,a,i);return t.lgm_european_call_on_cf(s,r,a,n,null,null,null)},t.lgm_calibrate=function(r,a,n,i){t.require_vd();var s,o,_,l,u,f,d,c,h,p,m,g,v=[],w=function(e){return t.lgm_european_call_on_cf(o,l,a,e*e,null,null,null)-d};for(h=0;h<r.length;h++)if(t.time_from_now(r[h].expiry)>1/512){for(l=t.time_from_now(r[h].expiry),u=t.time_from_now(r[h].maturity),o=t.lgm_european_swaption_adjusted_cashflow(r[h],a,n,!1),f=0,p=0;p<o.t_pmt.length;p++)f+=o.pmt_total[p]*t.get_df(a,o.t_pmt[p])*(e(o.t_pmt[p])-e(l));_=t.get_surface_rate(i,l,u-l)*Math.sqrt(l),s=Math.pow(_*r[h].swap.annuity(a)/f,2),g=(m=t.lgm_dcf(o,l,a,0,[0],null,null,null)[0])+r[h].swap.fixed_leg.notional*t.get_df(a,l),m<0&&(m=0),(d=r[h].present_value(a,n,i))<m&&(d=m),d>g&&(d=g);try{s=(c=t.find_root_secant(w,Math.sqrt(s),Math.sqrt(.9*s),100))*c}catch(t){}v.length>0&&v[v.length-1]>s&&(s=v[v.length-1]),v.push(s)}return v};var a=4;t.lgm_bermudan_call_on_cf=function(e,r,n,i,s,o,_){if(r[r.length-1]<0)return 0;if(r[r.length-1]<1/512)return Math.max(0,t.lgm_dcf(e,r[r.length-1],n,0,[0],s,o,_)[0]);function l(){var t=new Array(b);for(t[0]=-a*m,c=1;c<b;c++)t[c]=t[0]+c*g;return t}function u(){var t=0;for(c=0;c<b;c++)M[c]=Math.max(E[c],y[c]),!t&&c>0&&(y[c]-E[c])*(y[c-1]-E[c-1])<0&&(t=c);if(t){var e=M[t-1],r=M[t],a=Math.min(y[t-1],E[t-1]),n=Math.min(y[t],E[t]),i=(e-a)/(r-n+e-a),s=.25*(i*(r-n)+(1-i)*(e-a));M[t]-=i*s,M[t-1]-=(1-i)*s}}function f(e){if(x-p<1e-15)return M[e];var r,a=0,n=0,i=1/Math.sqrt(x-p);for(c=0;c<b;c++)r=c===b-1?1:t.cndf((w[c]-v[e]+.5*g)*i),a+=M[c]*(r-n),n=r;return a}var d,c,h,p,m,g,v,w,y,b=2*a*15+1,x=0,M=new Array(b),E=new Array(b);for(h=i.length-1;h>=0;){if(p=i[h],m=Math.sqrt(p),g=m/15,v=l(),y=t.lgm_dcf(e,r[h],n,p,v,s,o,_),h<i.length-1)for(d=0;d<b;d++)E[d]=f(d);else for(d=0;d<b;d++)E[d]=0;u(),x=p,w=v,g,h--}return v=[0],p=0,E=f(0)}}(this.JsonRisk||module.exports),function(t){"use strict";var e=Math.sqrt(4*Math.acos(0));t.get_safe_positive=function(t){return"number"!=typeof t?null:t<=0?null:t},t.get_safe_natural=function(t){return"number"!=typeof t?null:t<0||t!==Math.floor(t)?null:t},t.ndf=function(t){return Math.exp(-t*t/2)/e},t.cndf=function(t){var r,a=Math.abs(t);if(a<=37){var n=Math.exp(-a*a/2);if(a<7.07106781186547)r=n*((((((.0352624965998911*a+.700383064443688)*a+6.37396220353165)*a+33.912866078383)*a+112.079291497871)*a+221.213596169931)*a+220.206867912376)/(((((((.0883883476483184*a+1.75566716318264)*a+16.064177579207)*a+86.7807322029461)*a+296.564248779674)*a+637.333633378831)*a+793.826512519948)*a+440.413735824752);else r=n/(e*(a+1/(a+2/(a+3/(a+4/(a+.65))))))}else{if(!(a>37))throw new Error("cndf: invalid input.");r=0}return t<=0?r:1-r},t.find_root_secant=function(t,e,r,a,n){var i=e,s=r,o=0,_=a||20,l=n||1e-8,u=t(i),f=t(s);for(Math.abs(f)>Math.abs(u)&&(o=i,i=s,s=o,o=u,u=f,f=o);Math.abs(f)>l&&_>0;)o=(i-s)*f/(f-u),u=f,f=t(s=(i=s)+o),_--;if(_<=0)throw new Error("find_root_secant: failed, too many iterations");if(isNaN(s))throw new Error("find_root_secant: failed, invalid result");return s},t.find_root_ridders=function(t,e,r,a,n){var i,s,o,_=e,l=r,u=0,f=0,d=0,c=a||20,h=n||1e-8,p=t(_),m=t(l);if(p*m>0)throw new Error("find_root_ridders: start values do not bracket the root");if(Math.abs(p)<h)return _;if(Math.abs(m)<h)return l;for(;c>0;){if(c--,i=t(u=.5*(_+l)),Math.abs(i)<h)return u;if(0===(d=Math.sqrt(i*i-m*p)))return u;if(f=(u-_)*((o=p-m)>0?1:o<0?-1:0)*i/d+u,isNaN(f)&&(f=u),s=t(f),Math.abs(s)<h)return f;i*s<0?(_=f,p=s,l=u,m=i):p*s<0?(l=f,m=s):m*s<0&&(_=f,p=s)}if(c<=0)throw new Error("find_root_ridders: failed, too many iterations")}}(this.JsonRisk||module.exports),function(t){"use strict";var e=function(e,r,a,n){for(var i=[e],s=1,o=t.add_months(e,a);o.getTime()<r.getTime();)i.push(o),s++,o=t.add_months(e,s*a);return n(r).getTime()<=n(i[i.length-1]).getTime()&&i.pop(),i},r=function(e,r,a,n){for(var i=[r],s=1,o=t.add_months(r,-a);o.getTime()>e.getTime();)i.unshift(o),s++,o=t.add_months(r,-s*a);return n(e).getTime()>=n(i[0]).getTime()&&i.shift(),i};t.schedule=function(a,n,i,s,o,_,l,u){if(!(n instanceof Date))throw new Error("schedule: maturity must be provided");if(!(a instanceof Date)){if(null===t.valuation_date)throw new Error("schedule: if valuation_date is unset, effective date must be provided");if(o instanceof Date)throw new Error("schedule: if first date is provided, effective date must be provided");if(!(_ instanceof Date)&&l)throw new Error("schedule: if next to last date is not provided and stub in the end is specified, effective date must be provided")}if(a instanceof Date&&n<a||t.valuation_date instanceof Date&&n<t.valuation_date)throw new Error("schedule: maturity is before valution or effective date.");if("number"!=typeof i)throw new Error("schedule: tenor must be a nonnegative integer, e.g., 6 for semiannual schedule, 0 for zerobond/iam schedule");if(i<0||Math.floor(i)!==i)throw new Error("schedule: tenor must be a nonnegative integer, e.g., 6 for semiannual schedule, 0 for zerobond/iam schedule");return 0===i?[a instanceof Date?a:t.valuation_date,n]:(o instanceof Date&&!(_ instanceof Date)?((f=e(o,n,i,s)).push(n),a.getTime()!==o.getTime()&&f.unshift(a)):_ instanceof Date&&!(o instanceof Date)?(f=r(a instanceof Date?a:t.valuation_date,_,i,s),n.getTime()!==_.getTime()&&f.push(n),a instanceof Date&&f.unshift(a),a instanceof Date||f.unshift(t.add_months(f[0],-i))):o instanceof Date&&_ instanceof Date?(f=r(o,_,i,s),n.getTime()!==_.getTime()&&f.push(n),f.unshift(o),f.unshift(a)):l?(f=e(a,n,i,s),u&&f.length>1&&f.pop(),f.push(n)):(f=r(a instanceof Date?a:t.valuation_date,n,i,s),u&&f.length>1&&f.shift(),a instanceof Date&&f.unshift(a),a instanceof Date||f.unshift(t.add_months(f[0],-i))),f);var f}}(this.JsonRisk||module.exports),function(t){function e(e,r){if(e.terms)return e.terms[r];if(e.labels_term)return t.period_str_to_time(e.labels_term[r]);throw new Error("get_term_at: invalid surface, cannot derive terms")}function r(e,r){if(e.expiries)return e.expiries[r];if(e.labels_expiry)return t.period_str_to_time(e.labels_expiry[r]);throw new Error("get_expiry_at: invalid surface, cannot derive expiries")}function a(t,r,n,i,s){i=i||0,s=s||(t.terms||t.labels_term||[]).length-1;var o=t.values[r];if(!Array.isArray(o))throw new Error("get_slice_rate: invalid surface, values property must be an array of arrays");return i===s?o[i]:n<e(t,i)?o[i]:n>e(t,s)?o[s]:i+1===s?o[i]*(e(t,s)-n)/(e(t,s)-e(t,i))+o[s]*(n-e(t,i))/(e(t,s)-e(t,i)):(imed=Math.ceil((i+s)/2),n>e(t,imed)?a(t,r,n,imed,s):a(t,r,n,i,imed))}t.get_const_surface=function(t,e){if("number"!=typeof t)throw new Error("get_const_surface: input must be number.");return{type:e||"",expiries:[1],terms:[1],values:[[t]]}},t.get_safe_surface=function(a){return a?{type:a.type||"",expiries:function(t){var e=(t.expiries||t.labels_expiry||[]).length;if(!e)throw new Error("get_surface_terms: invalid surface, need to provide valid expiries or labels_expiry");for(var a=new Array(e);e>0;)a[--e]=r(t,e);return a}(a),terms:function(t){var r=(t.terms||t.labels_term||[]).length;if(!r)throw new Error("get_surface_terms: invalid surface, need to provide valid terms or labels_term");for(var a=new Array(r);r>0;)a[--r]=e(t,r);return a}(a),values:a.values}:t.get_const_surface(0)},t.get_surface_rate=function(e,n,i,s,o){return(s=s||0)===(o=o||(e.expiries||e.labels_expiry||[]).length-1)?a(e,s,i):n<r(e,s)?a(e,s,i):n>r(e,o)?a(e,o,i):s+1===o?a(e,s,i)*(r(e,o)-n)/(r(e,o)-r(e,s))+a(e,o,i)*(n-r(e,s))/(r(e,o)-r(e,s)):(imed=Math.ceil((s+o)/2),n>r(e,imed)?t.get_surface_rate(e,n,i,imed,o):t.get_surface_rate(e,n,i,s,imed))}}(this.JsonRisk||module.exports),function(t){t.swap=function(e){this.phi=e.is_payer?-1:1,this.fixed_rate=e.fixed_rate,this.fixed_leg=new t.fixed_income({notional:e.notional*this.phi,notional_exchange:!1,maturity:e.maturity,fixed_rate:e.fixed_rate,tenor:e.tenor,effective_date:e.effective_date,calendar:e.calendar,bdc:e.bdc,dcc:e.dcc}),this.float_leg=new t.fixed_income({notional:-e.notional*this.phi,notional_exchange:!1,maturity:e.maturity,float_spread:e.float_spread,tenor:e.float_tenor,effective_date:e.effective_date,calendar:e.calendar,bdc:e.float_bdc,dcc:e.float_dcc,float_current_rate:e.float_current_rate})},t.swap.prototype.fair_rate=function(t,e){var r=this.float_leg.present_value(t,null,e);return-this.phi*r/this.annuity(t)},t.swap.prototype.annuity=function(t){return this.fixed_leg.annuity(t)*this.phi},t.swap.prototype.present_value=function(t,e){var r=0;return r+=this.fixed_leg.present_value(t,null,null),r+=this.float_leg.present_value(t,null,e)},t.swap.prototype.get_cash_flows=function(t){return{fixed_leg:this.fixed_leg.get_cash_flows(),float_leg:this.float_leg.get_cash_flows(t)}},t.pricer_swap=function(e,r,a){return new t.swap(e).present_value(r,a)}}(this.JsonRisk||module.exports),function(t){t.swaption=function(e){if(this.sign=e.is_short?-1:1,this.maturity=t.get_safe_date(e.maturity),!this.maturity)throw new Error("swaption: must provide valid maturity date.");if(this.expiry=t.get_safe_date(e.expiry),!this.expiry)throw new Error("swaption: must provide valid expiry date.");this.swap=new t.swap({is_payer:e.is_payer,notional:e.notional,effective_date:this.expiry,settlement_date:this.expiry,maturity:e.maturity,fixed_rate:e.fixed_rate,tenor:e.tenor,calendar:e.calendar,bdc:e.bdc,dcc:e.dcc,float_spread:e.float_spread,float_tenor:e.float_tenor,float_bdc:e.float_bdc,float_dcc:e.float_dcc,float_current_rate:e.float_current_rate})},t.swaption.prototype.present_value=function(e,r,a){t.require_vd();var n=t.time_from_now(this.maturity),i=t.time_from_now(this.expiry),s=n-i;if(s<1/512)return 0;var o=this.swap.fair_rate(e,r);if("object"!=typeof a||null===a)throw new Error("swaption.present_value: must provide valid surface");var _,l=t.get_surface_rate(a,i,s)*Math.sqrt(i);if(i<0)return 0;if(i<1/512||l<1e-4)_=Math.max(this.swap.phi*(this.swap.fixed_rate-o),0);else{var u=(this.swap.fixed_rate-o)/l;_=this.swap.phi*(this.swap.fixed_rate-o)*t.cndf(this.swap.phi*u)+l*t.ndf(u)}return _*=this.swap.annuity(e),_*=this.sign},t.pricer_swaption=function(e,r,a,n){return new t.swaption(e).present_value(r,a,n)},t.create_equivalent_regular_swaption=function(e,r,a){if(void 0===e.date_pmt||void 0===e.pmt_total||void 0===e.current_principal)throw new Error("create_equivalent_regular_swaption: invalid cashflow object");if(e.t_pmt.length!==e.pmt_total.length||e.t_pmt.length!==e.current_principal.length)throw new Error("create_equivalent_regular_swaption: invalid cashflow object");t.require_vd(),a||(a={});for(var n,i=a.tenor||6,s=a.bdc||"unadjusted",o=a.calendar||"",_=0;e.date_pmt[_]<=r;)_++;if(0===(n=e.current_principal[_]))throw new Error("create_equivalent_regular_swaption: invalid cashflow object or expiry, zero outstanding principal");var l=t.irr(e,r,-n);l=12/i*(Math.pow(1+l,i/12)-1);for(var u=t.get_const_curve(l+1e-4),f=t.get_const_curve(l-1e-4),d=t.dcf(e,u,null,null,r),c=t.dcf(e,f,null,null,r),h=1e4*(c-d)/(c+d),p=function(e){var r=new t.fixed_income(e);return d=r.present_value(u),1e4*((c=r.present_value(f))-d)/(c+d)},m=Math.abs(l)<1e-8?h:-Math.log(1-h*l)/l,g=t.add_days(t.valuation_date,Math.round(365*m)),v={maturity:g,effective_date:r,settlement_date:r,notional:n,fixed_rate:l,tenor:i,calendar:o,bdc:s,dcc:"act/365"},w=p(v),y=10;Math.abs(w-h)>1/512&&y>0;)m=m*h/w,g=t.add_days(t.valuation_date,Math.round(365*m)),v.maturity=g,w=p(v),y--;return{is_payer:!1,maturity:g,expiry:r,effective_date:r,settlement_date:r,notional:n,fixed_rate:l,tenor:i,float_spread:0,float_tenor:6,float_current_rate:0,calendar:o,bdc:s,float_bdc:s,dcc:"act/365",float_dcc:"act/365"}}}(this.JsonRisk||module.exports),function(t){"use strict";var e=1/864e5;function r(t){return t%4==0&&(2e3===t||t%100!=0)}function a(t,e){return new Date(t,e+1,0).getDate()}function n(t,r){return Math.round((r-t)*e)}function i(t,e){return n(t,e)/365}function s(t,e){return n(t,e)/360}function o(t,e){return(360*(e.getFullYear()-t.getFullYear())+30*(e.getMonth()-t.getMonth())+(Math.min(e.getDate(),30)-Math.min(t.getDate(),30)))/360}function _(t,e){if(t-e==0)return 0;if(t>e)return-_(e,t);var a=t.getFullYear(),i=e.getFullYear();if(a===i)return n(t,e)/(r(a)?366:365);var s=i-a-1;return s+=n(t,new Date(a+1,0,1))/(r(a)?366:365),s+=n(new Date(i,0,1),e)/(r(i)?366:365)}function l(t){var e=t.getDay();return 0===e||6===e}function u(e){if(l(e))return!0;var r=e.getDate(),a=e.getMonth();if(1===r&&0===a)return!0;if(25===r&&11===a)return!0;var n=e.getFullYear();if((1998===n||1999===n||2001===n)&&31===r&&11===a)return!0;if(n>2e3){if(1===r&&4===a||26===r&&11===a)return!0;var i=function(t){var e=Math.floor,r=e(t/100),a=t-19*e(t/19),n=e((r-17)/25),i=r-e(r/4)-e((r-n)/3)+19*a+15;i-=30*e(i/30),i-=e(i/28)*(1-e(i/28)*e(29/(i+1))*e((21-a)/11));var s=t+e(t/4)+i+2-r+e(r/4),o=i-(s-=7*e(s/7)),_=3+e((o+40)/44),l=o+28-31*e(_/4);return new Date(t,_-1,l)}(n);if(e.getTime()===t.add_days(i,-2).getTime())return!0;if(e.getTime()===t.add_days(i,1).getTime())return!0}return!1}t.period_str_to_time=function(t){var e=parseInt(t,10);if(isNaN(e))throw new Error("period_str_to_time(str) - Invalid time period string: "+t);var r=t.charAt(t.length-1);if("Y"===r||"y"===r)return e;if("M"===r||"m"===r)return e/12;if("W"===r||"w"===r)return e/52;if("D"===r||"d"===r)return e/365;throw new Error("period_str_to_time(str) - Invalid time period string: "+t)},t.date_str_to_date=function(t){var e,r,n,i=null;if(null!==(i=/^([1-2][0-9]{3})[\/-]([0-9]{1,2})[\/-]([0-9]{1,2})/.exec(t))?(n=parseInt(i[1],10),r=parseInt(i[2],10)-1,e=parseInt(i[3],10)):null!==(i=/^([0-9]{1,2})\.([0-9]{1,2})\.([1-2][0-9]{3})/.exec(t))&&(n=parseInt(i[3],10),r=parseInt(i[2],10)-1,e=parseInt(i[1],10)),null===i)throw new Error("date_str_to_time(str) - Invalid date string: "+t);if(r<0||r>11)throw new Error("date_str_to_time(str) - Invalid month in date string: "+t);if(e<0||e>a(n,r))throw new Error("date_str_to_time(str) - Invalid day in date string: "+t);return new Date(n,r,e)},t.get_safe_date=function(e){if(!e)return null;if(e instanceof Date)return e;if(e instanceof String||"string"==typeof e)return t.date_str_to_date(e);throw new Error("get_safe_date: invalid input.")},t.year_fraction_factory=function(t){if(!(t instanceof String)&&"string"!=typeof t)return i;var e=t.toLowerCase();if("a"===e.charAt(0)){if("actual/365"===e||"act/365"===e||"a/365"===e||"act/365 (fixed)"===e||"actual/365 (fixed)"===e)return i;if("act/360"===e||"a/360"===e)return s;if("act/act"===e||"a/a"===e)return _}return"3"===e.charAt(0)&&"30e/360"===e?o:i},t.time_from_now=function(e){return t.require_vd(),i(t.valuation_date,e)},t.add_days=function(t,e){return new Date(t.getFullYear(),t.getMonth(),t.getDate()+e)},t.add_months=function(t,e,r){for(var n,i=t.getFullYear(),s=t.getMonth()+e;s>=12;)s-=12,i+=1;for(;s<0;)s+=12,i-=1;return n=r||t.getDate(),new Date(i,s,Math.min(n,a(i,s)))},t.add_period=function(e,r){var a=parseInt(r,10);if(isNaN(a))throw new Error("period_str_to_time(str) - Invalid time period string: "+r);var n=r.charAt(r.length-1);if("Y"===n||"y"===n)return t.add_months(e,12*a);if("M"===n||"m"===n)return t.add_months(e,a);if("W"===n||"w"===n)return t.add_days(e,7*a);if("D"===n||"d"===n)return t.add_days(e,a);throw new Error("period_str_to_time(str) - Invalid time period string: "+r)};var f={};t.add_calendar=function(r,a){if(!(r instanceof String||"string"==typeof r))throw new Error("add_calendar: invalid input.");if(!Array.isArray(a))throw new Error("add_calendar: invalid input.");var n,i,s,o=a.length,_=[];for(n=0;n<o;n++)(s=t.get_safe_date(a[n]))&&(l(s)||_.push(s));for(o=_.length,n=1;n<41&&!((i=n*n-n+41)>=o/10);)n++;var u=new Array(i);for(n=0;n<i;n++)u[n]=[];for(n=0;n<o;n++)u[Math.floor(_[n].getTime()*e)%i].push(_[n].getTime());return f[r.toLowerCase()]=u,i},t.is_holiday_factory=function(t){var r=t.toLowerCase();if("target"===r)return u;if(Array.isArray(f[r])){var a=f[r];return function(t){if(l(t))return!0;for(var r=t.getTime(),n=Math.floor(r*e)%a.length,i=0;i<a[n].length;i++)if(r===a[n][i])return!0;return!1}}return l},t.adjust=function(e,r,a){var n,i=(r||"u").charAt(0).toLowerCase(),s=new Date(e);if("u"===i)return s;if("m"===i&&(n=s.getMonth()),"m"===i||"f"===i)for(;a(s);)s=t.add_days(s,1);if("f"===i)return s;if("m"===i&&n===s.getMonth())return s;for("m"===i&&(s=t.add_days(s,-1));a(s);)s=t.add_days(s,-1);return s},t.add_business_days=function(e,r,a){for(var n=e,i=r;i>0;)n=t.adjust(t.add_days(n,1),"f",a),i--;return n}}(this.JsonRisk||module.exports),function(t){var e=null,r=function(t){if(1!==t)if(1!==e.vector_length){if(t!==e.vector_length)throw new Error("vector_pricing: parameters need to have the same length or length one")}else e.vector_length=t};t.store_params=function(a){var n,i,s,o,_,l,u,f;if((e={vector_length:1,scalars:{},curves:{},surfaces:{}}).valuation_date=t.get_safe_date(a.valuation_date),"object"==typeof a.scalars)for(n=Object.keys(a.scalars),i=0;i<n.length;i++)e.scalars[n[i]]=(s=a.scalars[n[i]],Array.isArray(s.value)?{value:s.value}:{value:[s.value]}),r(e.scalars[n[i]].value.length);if("object"==typeof a.curves)for(n=Object.keys(a.curves),i=0;i<n.length;i++)l=a.curves[n[i]],o={times:t.get_curve_times(l),dfs:l.dfs?Array.isArray(l.dfs[0])?l.dfs:[l.dfs]:null,zcs:l.zcs?Array.isArray(l.zcs[0])?l.zcs:[l.zcs]:null},e.curves[n[i]]=o,_=o.dfs?o.dfs.length:o.zcs.length,r(_);if("object"==typeof a.surfaces)for(n=Object.keys(a.surfaces),i=0;i<n.length;i++)e.surfaces[n[i]]=(u=a.surfaces[n[i]],void 0,{expiries:(f=t.get_safe_surface(u)).expiries,terms:f.terms,values:Array.isArray(u.values[0][0])?u.values:[u.values]}),r(e.surfaces[n[i]].values.length)},t.get_params=function(){return e};var a=function(t,e){return t?{times:t.times,dfs:t.dfs?t.dfs[t.dfs.length>1?e:0]:null,zcs:t.zcs?t.zcs[t.zcs.length>1?e:0]:null}:null};t.vector_pricer=function(r){if("string"!=typeof r.type)throw new Error("vector_pricer: instrument object must contain valid type");t.valuation_date=e.valuation_date;for(var n,i,s,o,_,l,u=function(e){switch(e.type.toLowerCase()){case"bond":case"floater":case"irregular_bond":return new t.fixed_income(e);case"swap":return new t.swap(e);case"swaption":return new t.swaption(e);case"fxterm":return new t.fxterm(e);case"callable_bond":return new t.callable_fixed_income(e);default:throw new Error("vector_pricer: invalid instrument type")}}(r),f=e.curves[r.disc_curve||""]||null,d=e.curves[r.spread_curve||""]||null,c=e.curves[r.fwd_curve||""]||null,h=e.surfaces[r.surface||""]||null,p=e.scalars[r.currency||""]||null,m=new Array(e.vector_length),g=0;g<e.vector_length;g++){switch(n=a(f,g),i=a(d,g),s=a(c,g),l=g,o=(_=h)?{expiries:_.expiries,terms:_.terms,values:_.values[_.values.length>1?l:0]}:null,r.type.toLowerCase()){case"bond":case"floater":case"fxterm":case"irregular_bond":m[g]=u.present_value(n,i,s);break;case"swap":case"swaption":m[g]=u.present_value(n,s,o);break;case"callable_bond":m[g]=u.present_value(n,i,s,o)}p&&(m[g]/=p.value[p.value.length>1?g:0])}return m}}(this.JsonRisk||module.exports);