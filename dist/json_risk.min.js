/*! json_risk 26-06-2020 */

!function(e,t){"object"==typeof module&&"undefined"!=typeof exports?module.exports=t():e.JsonRisk=t()}(this,function(){var e={valuation_date:null,require_vd:function(){if(!(e.valuation_date instanceof Date))throw new Error("JsonRisk: valuation_date must be set")}};return e}),function(e){e.callable_fixed_income=function(t){if(!e.get_safe_number_vector(t.fixed_rate))throw new Error("callable_fixed_income: must provide valid fixed_rate.");var r,a=e.get_safe_date(t.first_exercise_date);if(null===a)throw new Error("callable_fixed_income: must provide first call date");if(this.base=new e.fixed_income(t),a.getTime()<=this.base.schedule[0].getTime())throw new Error("callable_fixed_income: first call date before issue date");if(!this.base.notional_exchange)throw new Error("callable_fixed_income: callable instruments must exchange notionals");for(this.call_schedule=e.schedule(a,e.get_safe_date(t.maturity),t.call_tenor||0,this.base.adj),this.call_schedule.pop(),this.opportunity_spread="number"==typeof t.opportunity_spread?t.opportunity_spread:0,this.exclude_base=e.get_safe_bool(t.exclude_base),this.basket=new Array(this.call_schedule.length),r=0;r<this.call_schedule.length;r++)this.base.is_amortizing?this.basket[r]=new e.swaption(e.create_equivalent_regular_swaption(this.base.get_cash_flows(),this.call_schedule[r],{tenor:t.tenor,float_spread:0,float_tenor:t.float_tenor||6,calendar:t.calendar,bdc:t.bdc})):this.basket[r]=new e.swaption({is_payer:!1,maturity:t.maturity,first_exercise_date:this.call_schedule[r],notional:t.notional,fixed_rate:t.fixed_rate-this.opportunity_spread,tenor:t.tenor,float_spread:0,float_tenor:t.float_tenor||6,float_current_rate:0,calendar:t.calendar,bdc:t.bdc,float_bdc:t.bdc,dcc:t.dcc,float_dcc:t.dcc})},e.callable_fixed_income.prototype.present_value=function(t,r,a,n){var i,s=0;e.require_vd();var o,_=[];for(i=0;i<this.call_schedule.length;i++)(o=e.time_from_now(this.call_schedule[i]))>1/512&&_.push(o);if("object"!=typeof a||null===a)throw new Error("callable_fixed_income.present_value: must provide forward curve for calibration");if("object"!=typeof n||null===n)throw new Error("callable_fixed_income.present_value: must provide valid surface");var l=e.lgm_calibrate(this.basket,t,a,n);return 1===l.length?s=-e.lgm_european_call_on_cf(this.base.get_cash_flows(),_[0],t,l[0],r,this.base.residual_spread,this.opportunity_spread):1<l.length&&(s=-e.lgm_bermudan_call_on_cf(this.base.get_cash_flows(),_,t,l,r,this.base.residual_spread,this.opportunity_spread)),this.exclude_base||(s+=this.base.present_value(t,r,null)),s},e.pricer_callable_bond=function(t,r,a,n,i){return new e.callable_fixed_income(t).present_value(r,a,n,i)}}(this.JsonRisk||module.exports),function(e){var t=null;function r(r,a){if(!r.times){if(r.days)return r.days[a]/365;if(r.dates)return(t=t||e.year_fraction_factory("a/365"))(e.get_safe_date(r.dates[0]),e.get_safe_date(r.dates[a]));if(r.labels)return e.period_str_to_time(r.labels[a]);throw new Error("get_time_at: invalid curve, cannot derive times")}return r.times[a]}function a(e,t){if(Array.isArray(e.dfs))return e.dfs[t];if(Array.isArray(e.zcs))return Math.pow(1+e.zcs[t],-r(e,t));throw new Error("get_df: invalid curve, must provide dfs or zcs")}e.get_const_curve=function(e,t){if("number"!=typeof e)throw new Error("get_const_curve: input must be number.");if(e<=-1)throw new Error("get_const_curve: invalid input.");return{type:t||"yield",times:[1],dfs:[1/(1+e)]}},e.get_curve_times=function(e){var t=(e.times||e.days||e.dates||e.labels||[]).length;if(!t)throw new Error("get_curve_times: invalid curve, need to provide valid times, days, dates, or labels");for(var a=new Array(t);t>0;)a[--t]=r(e,t);return a},e.get_safe_curve=function(t){return t?{type:"yield",times:e.get_curve_times(t),dfs:function(e){var t=(e.times||e.days||e.dates||e.labels||[]).length;if(!t)throw new Error("get_curve_dfs: invalid curve, need to provide valid times, days, dates, or labels");if(e.dfs){if(e.dfs.length!==t)throw new Error("get_curve_dfs: invalid curve, dfs length must match times length")}else if(e.zcs.length!==t)throw new Error("get_curve_dfs: invalid curve, zcs length must match times length");for(var r=new Array(t);t>0;)if(r[--t]=e.dfs?e.dfs[t]:a(e,t),"number"!=typeof r[t])throw new Error("get_curve_dfs: invalid curve, must provide numeric zcs or dfs");return r}(t)}:e.get_const_curve(0)},e.get_df=function(t,n,i,s){if(void 0===i&&(i=0),void 0===s&&(s=(t.times||t.days||t.dates||t.labels).length-1),n<1/512)return 1;if(i===s)return n===r(t,i)?a(t,i):Math.pow(a(t,i),n/r(t,i));if(n<r(t,i))return Math.pow(a(t,i),n/r(t,i));if(n>r(t,s))return Math.pow(a(t,s),n/r(t,s));if(i+1===s){if(r(t,s)-r(t,i)<1/512)throw new Error("get_df_internal: invalid curve, support points must be increasing and differ at least one day");return a(t,i)*(r(t,s)-n)/(r(t,s)-r(t,i))+a(t,s)*(n-r(t,i))/(r(t,s)-r(t,i))}return imed=Math.ceil((i+s)/2),n>r(t,imed)?e.get_df(t,n,imed,s):e.get_df(t,n,i,imed)},e.get_rate=function(t,r){return r<1/512?0:Math.pow(e.get_df(t,r),-1/r)-1},e.get_fwd_rate=function(t,r,a){return a-r<1/512?0:Math.pow(e.get_df(t,a)/e.get_df(t,r),-1/(a-r))-1},e.add_curves=function(t,r){for(var a,n=e.get_curve_times(t),i=e.get_curve_times(r),s=[],o=0,_=0,l=[];a=Number.POSITIVE_INFINITY,o<n.length&&(a=Math.min(n[o],a)),_<i.length&&(a=Math.min(i[_],a)),s.push(a),l.push(e.get_rate(t,a)+e.get_rate(r,a)),a===n[o]&&o<n.length&&o++,a===i[_]&&_<i.length&&_++,o!==n.length||_!==i.length;);return{times:s,zcs:l}}}(this.JsonRisk||module.exports),function(e){e.dcf=function(t,r,a,n,i){var s=r||e.get_safe_curve(null),o=a||e.get_safe_curve(null);e.require_vd(),"number"!=typeof n&&(n=0);var _=e.get_safe_date(i);if(_||(_=e.valuation_date),void 0===t.t_pmt||void 0===t.pmt_total)throw new Error("dcf: invalid cashflow object");if(t.t_pmt.length!==t.pmt_total.length)throw new Error("dcf: invalid cashflow object");for(var l,u,f,c=0,d=0;t.date_pmt[d]<=_;)d++;for(;d<t.t_pmt.length;)l=e.get_df(s,t.t_pmt[d]),u=e.get_df(o,t.t_pmt[d]),f=Math.pow(1+n,-t.t_pmt[d]),c+=t.pmt_total[d]*l*u*f,d++;return c},e.irr=function(t,r,a){e.require_vd(),a||(a=0);var n=e.time_from_now(r);return e.find_root_secant(function(i){return e.dcf(t,null,null,i,r)+a*Math.pow(1+i,-n)},0,1e-4)}}(this.JsonRisk||module.exports),function(e){e.fixed_income=function(t){var r=e.get_safe_date(t.maturity);if(!r)throw new Error("fixed_income: must provide maturity date.");var a=e.get_safe_date(t.effective_date);if("number"!=typeof t.notional)throw new Error("fixed_income: must provide valid notional.");this.notional=t.notional,this.notional_exchange=!1!==t.notional_exchange;var n=e.get_safe_natural(t.tenor);if(null===n)throw new Error("fixed_income: must provide valid tenor.");var i=e.get_safe_date(t.first_date),s=e.get_safe_date(t.next_to_last_date),o=t.stub_end||!1,_=t.stub_long||!1;this.current_accrued_interest=t.current_accrued_interest||0,this.type="string"==typeof t.type?t.type:"unknown",this.is_holiday_func=e.is_holiday_factory(t.calendar||""),this.year_fraction_func=e.year_fraction_factory(t.dcc||""),this.bdc=t.bdc||"",this.adjust_accrual_periods=t.adjust_accrual_periods||!1,this.adj=function(t){return e.adjust(t,this.bdc,this.is_holiday_func)};var l=e.get_safe_natural(t.repay_tenor);null===l&&(l=n);var u=t.linear_amortization||!1;this.repay_amount=e.get_safe_number_vector(t.repay_amount)||[0],this.interest_capitalization=e.get_safe_bool_vector(t.interest_capitalization);var f=e.get_safe_date(t.repay_first_date)||this.first_date,c=e.get_safe_date(t.repay_next_to_last_date)||this.next_to_last_date,d=t.stub_end||!1,h=t.stub_long||!1;if(this.conditions_valid_until=e.get_safe_date_vector(t.conditions_valid_until),this.conditions_valid_until){if(this.conditions_valid_until[this.conditions_valid_until.length-1].getTime()!==r.getTime())throw new Error("fixed_income: last date provided under conditions_valid_until must match maturity")}else this.conditions_valid_until=[r];var p=e.get_safe_natural(t.settlement_days)||0;this.settlement_date=e.get_safe_date(t.settlement_date)||e.add_business_days(e.valuation_date,p,this.is_holiday_func),this.residual_spread="number"==typeof t.residual_spread?t.residual_spread:0;t.currency;if(this.schedule=e.schedule(a,r,n,this.adj,i,s,o,_),t.fixed_rate||0===t.fixed_rate)this.is_float=!1,this.fixed_rate=e.get_safe_number_vector(t.fixed_rate),this.float_spread=0,this.cap_rate=0,this.floor_rate=0,this.fixing_schedule=[this.schedule[0],r];else{if(this.is_float=!0,this.fixed_rate=null,this.float_spread=e.get_safe_number_vector(t.float_spread)||[0],this.float_current_rate=e.get_safe_number(t.float_current_rate),null===this.float_current_rate)throw new Error("fixed_income: must provide valid float_current_rate.");var m=e.get_safe_natural(t.fixing_tenor);null===m&&(m=n);var g=e.get_safe_date(t.fixing_first_date)||this.first_date,v=e.get_safe_date(t.fixing_next_to_last_date)||this.next_to_last_date;t.fixing_stub_end,t.fixing_stub_long;this.cap_rate="number"==typeof t.cap_rate?t.cap_rate:Number.POSITIVE_INFINITY,this.floor_rate="number"==typeof t.floor_rate?t.floor_rate:Number.POSITIVE_INFINITY,this.fixing_schedule=e.schedule(this.schedule[0],r,m,this.adj,g,v)}this.is_amortizing=this.repay_amount.reduce(function(e,t){return Math.max(e*e,t*t)},0)>0||this.interest_capitalization.reduce(function(e,t){return e||t},!1)||u,this.is_amortizing?this.repay_schedule=e.schedule(this.schedule[0],r,l,this.adj,f,c,d,h):this.repay_schedule=[this.schedule[0],r],u&&(this.repay_amount=[this.notional/(this.repay_schedule.length-1)]),this.cash_flows=this.initialize_cash_flows(),this.is_float||(this.cash_flows=this.finalize_cash_flows(null))},e.fixed_income.prototype.initialize_cash_flows=function(){e.require_vd();var t=new Array(this.schedule.length),r=new Array(this.schedule.length),a=new Array(this.schedule.length),n=new Array(this.schedule.length),i=new Array(this.schedule.length),s=new Array(this.schedule.length);t[0]=this.schedule[0],r[0]=this.schedule[0],a[0]=!1,n[0]=!1,i[0]=!1,s[0]=!1;for(var o=1,_=1,l=1,u=1,f=0;t[o]=r[o-1],r[o]=new Date(Math.min(this.schedule[_],this.repay_schedule[l],this.fixing_schedule[u],this.conditions_valid_until[f])),_<this.schedule.length&&r[o].getTime()===this.schedule[_].getTime()?(a[o]=!0,_++):a[o]=!1,l<this.repay_schedule.length&&r[o].getTime()===this.repay_schedule[l].getTime()?(n[o]=!0,l++):n[o]=!1,u<this.fixing_schedule.length&&r[o].getTime()===this.fixing_schedule[u].getTime()?(i[o]=!0,u++):i[o]=!1,f<this.conditions_valid_until.length&&r[o].getTime()===this.conditions_valid_until[f].getTime()?(s[o]=!0,f++):s[o]=!1,_!==this.schedule.length||l!==this.repay_schedule.length||u!==this.fixing_schedule.length;)o++;var c=new Array(t.length),d=new Array(t.length),h=new Array(t.length),p=new Array(t.length),m=new Array(t.length),g=new Array(t.length),v=new Array(t.length),w=new Array(t.length),y=new Array(t.length),b=new Array(t.length),x=new Array(t.length);for(o=0;o<t.length;o++)this.adjust_accrual_periods&&(t[o]=this.adj(t[o]),r[o]=this.adj(r[o])),c[o]=this.adj(r[o]),p[o]=e.time_from_now(c[o]),d[o]=e.time_from_now(t[o]),h[o]=e.time_from_now(r[o]),g[o]=0===o?0:this.year_fraction_func(t[o],r[o]);return{date_accrual_start:t,date_accrual_end:r,date_pmt:c,t_accrual_start:d,t_accrual_end:h,t_pmt:p,is_interest_date:a,is_repay_date:n,is_fixing_date:i,is_condition_date:s,accrual_factor:g,current_principal:m,interest_current_period:v,accrued_interest:w,pmt_principal:y,pmt_interest:b,pmt_total:x}},e.fixed_income.prototype.finalize_cash_flows=function(t,r){e.require_vd();e.year_fraction_factory(null);for(var a=this.cash_flows,n=a.date_accrual_start.length,i=new Array(n),s=new Array(n),o=new Array(n),_=new Array(n),l=new Array(n),u=new Array(n),f=this.notional>=0?1:-1,c=0;this.conditions_valid_until[c]<a.date_accrual_start[0];)c++;var d,h,p,m,g=this.repay_amount[Math.min(c,this.repay_amount.length-1)],v=this.interest_capitalization[Math.min(c,this.interest_capitalization.length-1)],w=(this.cap_rate[Math.min(c,this.cap_rate.length-1)],this.floor_rate[Math.min(c,this.floor_rate.length-1)],this.is_float?this.float_spread:this.fixed_rate);if(p="number"==typeof r?function(){return r}:function(){return w[Math.min(c,w.length-1)]},this.is_float)if(a.date_accrual_start[0]<=e.valuation_date)d=this.float_current_rate;else{for(h=0;!a.is_fixing_date[h]&&h<a.is_fixing_date.length;)h++;d=e.get_fwd_rate(t,a.t_accrual_start[0],a.t_accrual_end[h])+p()}else d=p();for(i[0]=0,s[0]=0,o[0]=0,_[0]=-this.notional,l[0]=0,u[0]=this.notional_exchange?-this.notional:0,m=1;m<n;m++)if(i[m]=i[m-1]-_[m-1],a.is_repay_date[m]?_[m]=g*f:_[m]=0,s[m]=i[m]*d*a.accrual_factor[m],o[m]=(m>0?o[m-1]:0)+s[m],a.is_interest_date[m]?(l[m]=o[m],o[m]=0,v&&(_[m]=_[m]-l[m])):l[m]=0,(m<n-1&&_[m]*f>i[m]*f||m===n-1)&&(_[m]=i[m]),u[m]=l[m],this.notional_exchange&&(u[m]+=_[m]),a.is_condition_date[m]&&(c++,g=this.repay_amount[Math.min(c,this.repay_amount.length-1)],v=this.interest_capitalization[Math.min(c,this.interest_capitalization.length-1)],this.cap_rate[Math.min(c,this.cap_rate.length-1)],this.floor_rate[Math.min(c,this.floor_rate.length-1)]),this.is_float){if(a.date_accrual_start[m]<=e.valuation_date)d=this.float_current_rate;else if(a.is_fixing_date[m]){for(h=0;!a.is_fixing_date[m+h]&&m+h<a.is_fixing_date.length;)h++;d=e.get_fwd_rate(t,a.t_accrual_start[m],a.t_accrual_end[m+h])+p()}}else d=p();return{date_accrual_start:a.date_accrual_start,date_accrual_end:a.date_accrual_end,date_pmt:a.date_pmt,t_accrual_start:a.t_accrual_start,t_accrual_end:a.t_accrual_end,t_pmt:a.t_pmt,is_interest_date:a.is_interest_date,is_repay_date:a.is_repay_date,is_fixing_date:a.is_fixing_date,is_condition_date:a.is_condition_date,accrual_factor:a.accrual_factor,current_principal:i,interest_current_period:s,accrued_interest:o,pmt_principal:_,pmt_interest:l,pmt_total:u}},e.fixed_income.prototype.get_cash_flows=function(e){if(this.is_float){if("object"!=typeof e||null===e)throw new Error("fixed_income.get_cash_flows: Must provide forward curve when evaluating floating rate interest stream");return this.finalize_cash_flows(e)}return this.cash_flows},e.fixed_income.prototype.present_value=function(t,r,a){if(this.is_float&&("object"!=typeof a||null===a))throw new Error("fixed_income.present value: Must provide forward curve when evaluating floating rate interest stream");return e.dcf(this.get_cash_flows(e.get_safe_curve(a)||null),e.get_safe_curve(t),e.get_safe_curve(r),this.residual_spread,this.settlement_date)},e.fixed_income.prototype.fair_rate_or_spread=function(t,r,a){e.require_vd();for(var n,i=e.get_safe_curve(a)||e.get_const_curve(0),s=this.get_cash_flows(i),o=0;s.date_pmt[o]<=e.valuation_date;)o++;return n=s.current_principal[o]-e.dcf(this.finalize_cash_flows(i,0),t,r,this.residual_spread,this.settlement_date),n/=this.annuity(t,r,i)},e.fixed_income.prototype.annuity=function(t,r,a){var n,i=this.get_cash_flows(e.get_safe_curve(a)||e.get_const_curve(0)),s=new Array(i.pmt_total.length),o=0;for(n=0;n<s.length;n++)s[n]=0,o+=i.current_principal[n]*i.accrual_factor[n],i.is_interest_date[n]&&(s[n]+=o,o=0);return e.dcf({date_pmt:i.date_pmt,t_pmt:i.t_pmt,pmt_total:s},e.get_safe_curve(t),e.get_safe_curve(r),this.residual_spread,this.settlement_date)},e.pricer_bond=function(t,r,a){return new e.fixed_income(t).present_value(r,a,null)},e.pricer_floater=function(t,r,a,n){return new e.fixed_income(t).present_value(r,a,n)}}(this.JsonRisk||module.exports),function(e){e.fxterm=function(t){this.near_leg=new e.fixed_income({notional:t.notional,maturity:t.maturity,fixed_rate:0,tenor:0}),"number"==typeof t.notional_2&&e.get_safe_date(t.maturity_2)?this.far_leg=new e.fixed_income({notional:t.notional_2,maturity:t.maturity_2,fixed_rate:0,tenor:0}):this.far_leg=null},e.fxterm.prototype.present_value=function(e){var t=0;return t+=this.near_leg.present_value(e,null,null),this.far_leg&&(t+=this.far_leg.present_value(e,null,null)),t},e.pricer_fxterm=function(t,r){return new e.fxterm(t).present_value(r)}}(this.JsonRisk||module.exports),function(e){"use strict";function t(e){return e}function r(t,r,a,n,i){for(var s,o=new Array(t.t_pmt.length+1),_=0;t.t_pmt[_]<=0;)_++;for(;_<t.t_pmt.length;)s=e.get_df(a,t.t_pmt[_]),n&&(s*=e.get_df(n,t.t_pmt[_])),i&&(s*=Math.pow(1+i,-t.t_pmt[_])),o[_]=s,_++;return s=e.get_df(a,r),n&&(s*=e.get_df(n,r)),i&&(s*=Math.pow(1+i,-r)),o[_]=s,o}function a(e,t,r,a){if(!a)return 0;for(var n=0,i=0;e.t_pmt[n]<=t;)n++;for(;n<e.t_pmt.length;)i+=e.current_principal[n]*r[n]*a*(e.t_pmt[n]-Math.max(e.t_pmt[n-1],t)),n++;return i/=r[r.length-1]}e.lgm_dcf=function(e,r,n,i,s,o){if(!Array.isArray(s))throw new Error("lgm_dcf: state variable must be an array of numbers");for(var _,l,u=0,f=new Array(s.length);e.t_pmt[u]<=r;)u++;var c=0;e.pmt_interest&&(c=0===u?0:e.pmt_interest[u]*(r-e.t_pmt[u-1])/(e.t_pmt[u]-e.t_pmt[u-1]));var d=a(e,r,n,o);for(_=0;_<s.length;_++)f[_]=-(e.current_principal[u]+c+d)*n[n.length-1];for(;u<e.t_pmt.length;){for(l=t(e.t_pmt[u])-t(r),_=0;_<s.length;_++)f[_]+=e.pmt_total[u]*n[u]*Math.exp(-l*s[_]-l*l*i*.5);u++}return f},e.lgm_european_call_on_cf=function(i,s,o,_,l,u,f,c){var d=c||r(i,s,o,l,u);if(s<0)return 0;if(s<1/512||_<1e-10)return Math.max(0,e.lgm_dcf(i,s,d,0,[0],f)[0]);var h,p=Math.sqrt(_),m=t(s+1/365)-t(s);function g(t){return e.lgm_dcf(i,s,d,_,[t],f)[0]}if(p>20/m)h=-10*(p=20/m);else{var v,w;if(g(0)>=0){if(v=0,g(w=p*n)>0)return e.lgm_dcf(i,s,d,0,[0],f)[0]}else if(w=0,g(v=-p*n)<0)return 0;try{h=e.find_root_ridders(g,w,v,20)}catch(t){return e.lgm_bermudan_call_on_cf(i,[s],o,[_],l,u,f)}}for(var y=0,b=1/p;i.t_pmt[y]<=s;)y++;var x=0;i.pmt_interest&&(x=0===y?0:i.pmt_interest[y]*(s-i.t_pmt[y-1])/(i.t_pmt[y]-i.t_pmt[y-1]));for(var M=a(i,s,d,f),E=-(i.current_principal[y]+x+M)*d[d.length-1]*e.cndf(h*b);y<i.t_pmt.length;)m=t(i.t_pmt[y])-t(s),E+=i.pmt_total[y]*d[y]*e.cndf(h*b+m*p),y++;return E},e.lgm_european_swaption_adjusted_cashflow=function(e,t,r,a){var n,i=e.swap.fair_rate(t,t);if(a)n=i;else{var s=e.swap.fair_rate(t,r);n=e.swap.fixed_rate-s+i}var o=e.swap.fixed_leg.finalize_cash_flows(null,n);return o.pmt_total[0]-=o.current_principal[1],o.pmt_total[o.pmt_total.length-1]+=o.current_principal[o.pmt_total.length-1],o},e.lgm_european_swaption=function(t,r,a,n,i){var s=e.lgm_european_swaption_adjusted_cashflow(t,a,i);return e.lgm_european_call_on_cf(s,r,a,n,null,null,null)},e.lgm_calibrate=function(a,n,i,s){e.require_vd();var o,_,l,u,f,c,d,h,p,m,g,v,w,y,b=[],x=function(t){return e.lgm_european_call_on_cf(_,f,n,t,null,null,null,l)-h};for(m=0;m<a.length;m++)if(e.time_from_now(a[m].first_exercise_date)>1/512){for(f=e.time_from_now(a[m].first_exercise_date),c=e.time_from_now(a[m].maturity),_=e.lgm_european_swaption_adjusted_cashflow(a[m],n,i,!1),l=r(_,f,n,null,null),d=0,g=0;g<_.t_pmt.length;g++)d+=_.pmt_total[g]*l[g]*(t(_.t_pmt[g])-t(f));if(u=e.get_surface_rate(s,f,c-f)*Math.sqrt(f),o=Math.pow(u*a[m].swap.annuity(n)/d,2),w=(v=e.lgm_dcf(_,f,l,0,[0],null)[0])+a[m].swap.fixed_leg.notional*l[l.length-1],v<0&&(v=0),(h=a[m].present_value(n,i,s))<=v+(y=1e-7*h+1e-7)||0===o)o=0;else{for(h>w&&(h=w),p=x(o),g=10;p<0&&g>0;)g--,p=x(o*=2);try{o=e.find_root_ridders(x,0,o,20,y)}catch(e){Math.abs(h-v)<Math.abs(p)&&(o=0)}}b.length>0&&b[b.length-1]>o&&(o=b[b.length-1]),b.push(o)}return b};var n=4;e.lgm_bermudan_call_on_cf=function(t,a,i,s,o,_,l){if(a[a.length-1]<0)return 0;if(a[a.length-1]<1/512)return e.lgm_european_call_on_cf(t,a[a.length-1],i,0,o,_,l);function u(){var e=new Array(M);for(e[0]=-n*g,h=1;h<M;h++)e[h]=e[0]+h*v;return e}function f(){var e=0;for(h=0;h<M;h++)A[h]=Math.max(j[h],b[h]),!e&&h>0&&(b[h]-j[h])*(b[h-1]-j[h-1])<0&&(e=h);if(e){var t=A[e-1],r=A[e],a=Math.min(b[e-1],j[e-1]),n=Math.min(b[e],j[e]),i=(t-a)/(r-n+t-a),s=.25*(i*(r-n)+(1-i)*(t-a));A[e]-=i*s,A[e-1]-=(1-i)*s}}function c(t){if(E-m<1e-15)return A[t];var r,a=0,n=0,i=1/Math.sqrt(E-m);for(h=0;h<M;h++)r=h===M-1?1:e.fast_cndf((y[h]-w[t]+.5*v)*i),a+=A[h]*(r-n),n=r;return a}var d,h,p,m,g,v,w,y,b,x,M=2*n*15+1,E=0,A=new Array(M),j=new Array(M);for(p=s.length-1;p>=0;){if(m=s[p],g=Math.sqrt(m),v=g/15,w=u(),x=r(t,a[p],i,o,_),b=e.lgm_dcf(t,a[p],x,m,w,l),p<s.length-1)for(d=0;d<M;d++)j[d]=c(d);else for(d=0;d<M;d++)j[d]=0;f(),E=m,y=w,v,p--}return w=[0],m=0,j=c(0)}}(this.JsonRisk||module.exports),function(e){"use strict";var t=Math.sqrt(4*Math.acos(0));e.get_safe_number=function(e){if("number"==typeof e)return e;if("string"==typeof e){e=e.trim();var t=parseFloat(e);return isNaN(t)?null:("%"===e.charAt(e.length-1)&&(t*=.01),t)}return null},e.get_safe_positive=function(t){var r=e.get_safe_number(t);return r<=0?null:r},e.get_safe_natural=function(t){var r=e.get_safe_number(t);return r<0||r!==Math.floor(r)?null:r},e.get_safe_number_vector=function(t){if("number"==typeof t)return[t];var r;if("string"==typeof t)r=t.split(/\s+/);else{if(!Array.isArray(t))return null;r=t.slice()}for(var a=0;a<r.length;a++)if(r[a]=e.get_safe_number(r[a]),null===r[a])throw new Error("get_safe_number_vector: invalid input");return r},e.get_safe_bool=function(e){if("boolean"==typeof e)return e;if("number"==typeof e)return 0!==e;if("string"==typeof e){var t=e.trim().toLowerCase();return"true"===t||"yes"===t||"y"===t}return!1},e.get_safe_bool_vector=function(t){if("boolean"==typeof t)return[t];if("number"==typeof t)return[0!==t];var r;if("string"==typeof t)r=t.split(/\s+/);else{if(!Array.isArray(t))return[!1];r=t.slice()}for(var a=0;a<r.length;a++)r[a]=e.get_safe_bool(r[a]);return r},e.ndf=function(e){return Math.exp(-e*e/2)/t},e.cndf=function(e){var r,a=Math.abs(e);if(a<=37){var n=Math.exp(-a*a/2);if(a<7.07106781186547)r=n*((((((.0352624965998911*a+.700383064443688)*a+6.37396220353165)*a+33.912866078383)*a+112.079291497871)*a+221.213596169931)*a+220.206867912376)/(((((((.0883883476483184*a+1.75566716318264)*a+16.064177579207)*a+86.7807322029461)*a+296.564248779674)*a+637.333633378831)*a+793.826512519948)*a+440.413735824752);else r=n/(t*(a+1/(a+2/(a+3/(a+4/(a+.65))))))}else{if(!(a>37))throw new Error("cndf: invalid input.");r=0}return e<=0?r:1-r};e.fast_cndf=function(e){var t=Math.abs(e),r=1+t*(.049867347+t*(.0211410061+t*(.0032776263+t*(380036e-10+t*(488906e-10+5383e-9*t)))));return r*=r,r*=r,r*=r,r=.5/(r*=r),e>=0?1-r:r},e.find_root_secant=function(e,t,r,a,n){var i=t,s=r,o=0,_=a||20,l=n||1e-8,u=e(i),f=e(s);for(Math.abs(f)>Math.abs(u)&&(o=i,i=s,s=o,o=u,u=f,f=o);Math.abs(f)>l&&_>0;)o=(i-s)*f/(f-u),u=f,f=e(s=(i=s)+o),_--;if(_<=0)throw new Error("find_root_secant: failed, too many iterations");if(isNaN(s))throw new Error("find_root_secant: failed, invalid result");return s},e.find_root_ridders=function(e,t,r,a,n){var i,s,o,_=t,l=r,u=0,f=0,c=0,d=a||20,h=n||1e-8,p=e(_),m=e(l);if(p*m>0)throw new Error("find_root_ridders: start values do not bracket the root");if(Math.abs(p)<h)return _;if(Math.abs(m)<h)return l;for(;d>0;){if(d--,u=.5*(_+l),Math.abs(_-l)<1e-15)return u;if(i=e(u),Math.abs(i)<h)return u;if(0===(c=Math.sqrt(i*i-m*p)))return u;if(f=(u-_)*((o=p-m)>0?1:o<0?-1:0)*i/c+u,isNaN(f)&&(f=u),s=e(f),Math.abs(s)<h)return f;i*s<0?(_=f,p=s,l=u,m=i):p*s<0?(l=f,m=s):m*s<0&&(_=f,p=s)}if(d<=0)throw new Error("find_root_ridders: failed, too many iterations")}}(this.JsonRisk||module.exports),function(e){"use strict";var t=function(t,r,a,n){for(var i=[t],s=1,o=e.add_months(t,a);o.getTime()<r.getTime();)i.push(o),s++,o=e.add_months(t,s*a);return n(r).getTime()<=n(i[i.length-1]).getTime()&&i.pop(),i},r=function(t,r,a,n){for(var i=[r],s=1,o=e.add_months(r,-a);o.getTime()>t.getTime();)i.unshift(o),s++,o=e.add_months(r,-s*a);return n(t).getTime()>=n(i[0]).getTime()&&i.shift(),i};e.schedule=function(a,n,i,s,o,_,l,u){if(!(n instanceof Date))throw new Error("schedule: maturity must be provided");if(!(a instanceof Date)){if(null===e.valuation_date)throw new Error("schedule: if valuation_date is unset, effective date must be provided");if(o instanceof Date)throw new Error("schedule: if first date is provided, effective date must be provided");if(!(_ instanceof Date)&&l)throw new Error("schedule: if next to last date is not provided and stub in the end is specified, effective date must be provided")}if(a instanceof Date&&n<a||e.valuation_date instanceof Date&&n<e.valuation_date)throw new Error("schedule: maturity is before valuation date or effective date.");if("number"!=typeof i)throw new Error("schedule: tenor must be a nonnegative integer, e.g., 6 for semiannual schedule, 0 for zerobond/iam schedule");if(i<0||Math.floor(i)!==i)throw new Error("schedule: tenor must be a nonnegative integer, e.g., 6 for semiannual schedule, 0 for zerobond/iam schedule");return 0===i?[a instanceof Date?a:e.valuation_date,n]:(o instanceof Date&&!(_ instanceof Date)?((f=t(o,n,i,s)).push(n),a.getTime()!==o.getTime()&&f.unshift(a)):_ instanceof Date&&!(o instanceof Date)?(f=r(a instanceof Date?a:e.valuation_date,_,i,s),n.getTime()!==_.getTime()&&f.push(n),a instanceof Date&&f.unshift(a),a instanceof Date||f.unshift(e.add_months(f[0],-i))):o instanceof Date&&_ instanceof Date?(f=r(o,_,i,s),n.getTime()!==_.getTime()&&f.push(n),f.unshift(o),f.unshift(a)):l?(f=t(a,n,i,s),u&&f.length>1&&f.pop(),f.push(n)):(f=r(a instanceof Date?a:e.valuation_date,n,i,s),u&&f.length>1&&f.shift(),a instanceof Date&&f.unshift(a),a instanceof Date||f.unshift(e.add_months(f[0],-i))),f);var f}}(this.JsonRisk||module.exports),function(e){function t(t,r){if(t.terms)return t.terms[r];if(t.labels_term)return e.period_str_to_time(t.labels_term[r]);throw new Error("get_term_at: invalid surface, cannot derive terms")}function r(t,r){if(t.expiries)return t.expiries[r];if(t.labels_expiry)return e.period_str_to_time(t.labels_expiry[r]);throw new Error("get_expiry_at: invalid surface, cannot derive expiries")}function a(e,r,n,i,s){i=i||0,s=s||(e.terms||e.labels_term||[]).length-1;var o=e.values[r];if(!Array.isArray(o))throw new Error("get_slice_rate: invalid surface, values property must be an array of arrays");return i===s?o[i]:n<t(e,i)?o[i]:n>t(e,s)?o[s]:i+1===s?o[i]*(t(e,s)-n)/(t(e,s)-t(e,i))+o[s]*(n-t(e,i))/(t(e,s)-t(e,i)):(imed=Math.ceil((i+s)/2),n>t(e,imed)?a(e,r,n,imed,s):a(e,r,n,i,imed))}e.get_const_surface=function(e,t){if("number"!=typeof e)throw new Error("get_const_surface: input must be number.");return{type:t||"",expiries:[1],terms:[1],values:[[e]]}},e.get_safe_surface=function(a){return a?{type:a.type||"",expiries:function(e){var t=(e.expiries||e.labels_expiry||[]).length;if(!t)throw new Error("get_surface_terms: invalid surface, need to provide valid expiries or labels_expiry");for(var a=new Array(t);t>0;)a[--t]=r(e,t);return a}(a),terms:function(e){var r=(e.terms||e.labels_term||[]).length;if(!r)throw new Error("get_surface_terms: invalid surface, need to provide valid terms or labels_term");for(var a=new Array(r);r>0;)a[--r]=t(e,r);return a}(a),values:a.values}:e.get_const_surface(0)},e.get_surface_rate=function(t,n,i,s,o){return(s=s||0)===(o=o||(t.expiries||t.labels_expiry||[]).length-1)?a(t,s,i):n<r(t,s)?a(t,s,i):n>r(t,o)?a(t,o,i):s+1===o?a(t,s,i)*(r(t,o)-n)/(r(t,o)-r(t,s))+a(t,o,i)*(n-r(t,s))/(r(t,o)-r(t,s)):(imed=Math.ceil((s+o)/2),n>r(t,imed)?e.get_surface_rate(t,n,i,imed,o):e.get_surface_rate(t,n,i,s,imed))}}(this.JsonRisk||module.exports),function(e){e.swap=function(t){this.phi=t.is_payer?-1:1,this.fixed_rate=t.fixed_rate,this.fixed_leg=new e.fixed_income({notional:t.notional*this.phi,notional_exchange:!1,maturity:t.maturity,fixed_rate:t.fixed_rate,tenor:t.tenor,effective_date:t.effective_date,calendar:t.calendar,bdc:t.bdc,dcc:t.dcc}),this.float_leg=new e.fixed_income({notional:-t.notional*this.phi,notional_exchange:!1,maturity:t.maturity,float_spread:t.float_spread,tenor:t.float_tenor,effective_date:t.effective_date,calendar:t.calendar,bdc:t.float_bdc,dcc:t.float_dcc,float_current_rate:t.float_current_rate})},e.swap.prototype.fair_rate=function(e,t){var r=this.float_leg.present_value(e,null,t);return-this.phi*r/this.annuity(e)},e.swap.prototype.annuity=function(e){return this.fixed_leg.annuity(e)*this.phi},e.swap.prototype.present_value=function(e,t){var r=0;return r+=this.fixed_leg.present_value(e,null,null),r+=this.float_leg.present_value(e,null,t)},e.swap.prototype.get_cash_flows=function(e){return{fixed_leg:this.fixed_leg.get_cash_flows(),float_leg:this.float_leg.get_cash_flows(e)}},e.pricer_swap=function(t,r,a){return new e.swap(t).present_value(r,a)}}(this.JsonRisk||module.exports),function(e){e.swaption=function(t){if(this.sign=t.is_short?-1:1,this.maturity=e.get_safe_date(t.maturity),!this.maturity)throw new Error("swaption: must provide valid maturity date.");if(this.first_exercise_date=e.get_safe_date(t.first_exercise_date),!this.first_exercise_date)throw new Error("swaption: must provide valid first_exercise_date date.");this.swap=new e.swap({is_payer:t.is_payer,notional:t.notional,effective_date:this.first_exercise_date,maturity:t.maturity,fixed_rate:t.fixed_rate,tenor:t.tenor,calendar:t.calendar,bdc:t.bdc,dcc:t.dcc,float_spread:t.float_spread,float_tenor:t.float_tenor,float_bdc:t.float_bdc,float_dcc:t.float_dcc,float_current_rate:t.float_current_rate})},e.swaption.prototype.present_value=function(t,r,a){e.require_vd();var n=e.time_from_now(this.maturity),i=e.time_from_now(this.first_exercise_date),s=n-i;if(s<1/512)return 0;var o=this.swap.fair_rate(t,r);if("object"!=typeof a||null===a)throw new Error("swaption.present_value: must provide valid surface");var _,l=e.get_surface_rate(a,i,s)*Math.sqrt(i);if(i<0)return 0;if(i<1/512||l<1e-4)_=Math.max(this.swap.phi*(this.swap.fixed_rate-o),0);else{var u=(this.swap.fixed_rate-o)/l;_=this.swap.phi*(this.swap.fixed_rate-o)*e.cndf(this.swap.phi*u)+l*e.ndf(u)}return _*=this.swap.annuity(t),_*=this.sign},e.pricer_swaption=function(t,r,a,n){return new e.swaption(t).present_value(r,a,n)},e.create_equivalent_regular_swaption=function(t,r,a){if(void 0===t.date_pmt||void 0===t.pmt_total||void 0===t.current_principal)throw new Error("create_equivalent_regular_swaption: invalid cashflow object");if(t.t_pmt.length!==t.pmt_total.length||t.t_pmt.length!==t.current_principal.length)throw new Error("create_equivalent_regular_swaption: invalid cashflow object");e.require_vd(),a||(a={});for(var n,i=a.tenor||6,s=a.bdc||"unadjusted",o=a.calendar||"",_=0;t.date_pmt[_]<=r;)_++;if(0===(n=t.current_principal[_]))throw new Error("create_equivalent_regular_swaption: invalid cashflow object or first_exercise_date, zero outstanding principal");var l=e.irr(t,r,-n);l=12/i*(Math.pow(1+l,i/12)-1);var u=e.time_from_now(r),f=e.get_const_curve(l+1e-4),c=e.get_const_curve(l-1e-4),d=e.dcf(t,f,null,null,r);d/=e.get_df(f,u);for(var h=e.dcf(t,c,null,null,r),p=1e4*((h/=e.get_df(c,u))-d)/(h+d),m=function(t){var r=new e.fixed_income(t);return d=r.present_value(f),d/=e.get_df(f,u),h=r.present_value(c),1e4*((h/=e.get_df(c,u))-d)/(h+d)},g=Math.abs(l)<1e-8?p:-Math.log(1-p*l)/l,v=e.add_days(r,Math.round(365*g)),w={maturity:v,effective_date:r,settlement_date:e.adjust(r,s,e.is_holiday_factory(o)),notional:n,fixed_rate:l,tenor:i,calendar:o,bdc:s},y=m(w),b=10;Math.abs(y-p)>1/512&&b>0;)g=g*p/y,v=e.add_days(r,Math.round(365*g)),w.maturity=v,y=m(w),b--;return{is_payer:!1,maturity:v,first_exercise_date:r,effective_date:r,settlement_date:r,notional:n,fixed_rate:l,tenor:i,float_spread:0,float_tenor:a.float_tenor||6,float_current_rate:0,calendar:o,bdc:s,float_bdc:s}}}(this.JsonRisk||module.exports),function(e){"use strict";var t=1/864e5;function r(e){return e%4==0&&(2e3===e||e%100!=0)}function a(e,t){return new Date(e,t+1,0).getDate()}function n(e,r){return Math.round((r-e)*t)}function i(e,t){return n(e,t)/365}function s(e,t){return n(e,t)/360}function o(e,t){return(360*(t.getFullYear()-e.getFullYear())+30*(t.getMonth()-e.getMonth())+(Math.min(t.getDate(),30)-Math.min(e.getDate(),30)))/360}function _(e,t){if(e-t==0)return 0;if(e>t)return-_(t,e);var a=e.getFullYear(),i=t.getFullYear();if(a===i)return n(e,t)/(r(a)?366:365);var s=i-a-1;return s+=n(e,new Date(a+1,0,1))/(r(a)?366:365),s+=n(new Date(i,0,1),t)/(r(i)?366:365)}function l(e){var t=e.getDay();return 0===t||6===t}function u(t){if(l(t))return!0;var r=t.getDate(),a=t.getMonth();if(1===r&&0===a)return!0;if(25===r&&11===a)return!0;var n=t.getFullYear();if((1998===n||1999===n||2001===n)&&31===r&&11===a)return!0;if(n>2e3){if(1===r&&4===a||26===r&&11===a)return!0;var i=function(e){var t=Math.floor,r=t(e/100),a=e-19*t(e/19),n=t((r-17)/25),i=r-t(r/4)-t((r-n)/3)+19*a+15;i-=30*t(i/30),i-=t(i/28)*(1-t(i/28)*t(29/(i+1))*t((21-a)/11));var s=e+t(e/4)+i+2-r+t(r/4),o=i-(s-=7*t(s/7)),_=3+t((o+40)/44),l=o+28-31*t(_/4);return new Date(e,_-1,l)}(n);if(t.getTime()===e.add_days(i,-2).getTime())return!0;if(t.getTime()===e.add_days(i,1).getTime())return!0}return!1}e.period_str_to_time=function(e){var t=parseInt(e,10);if(isNaN(t))throw new Error("period_str_to_time(str) - Invalid time period string: "+e);var r=e.charAt(e.length-1);if("Y"===r||"y"===r)return t;if("M"===r||"m"===r)return t/12;if("W"===r||"w"===r)return t/52;if("D"===r||"d"===r)return t/365;throw new Error("period_str_to_time(str) - Invalid time period string: "+e)},e.date_str_to_date=function(e){var t,r,n,i=null;if(null!==(i=/^([1-2][0-9]{3})[\/-]([0-9]{1,2})[\/-]([0-9]{1,2})/.exec(e))?(n=parseInt(i[1],10),r=parseInt(i[2],10)-1,t=parseInt(i[3],10)):null!==(i=/^([0-9]{1,2})\.([0-9]{1,2})\.([1-2][0-9]{3})/.exec(e))&&(n=parseInt(i[3],10),r=parseInt(i[2],10)-1,t=parseInt(i[1],10)),null===i)throw new Error("date_str_to_time(str) - Invalid date string: "+e);if(r<0||r>11)throw new Error("date_str_to_time(str) - Invalid month in date string: "+e);if(t<0||t>a(n,r))throw new Error("date_str_to_time(str) - Invalid day in date string: "+e);return new Date(n,r,t)},e.get_safe_date=function(t){if(!t)return null;if(t instanceof Date)return t;if(t instanceof String||"string"==typeof t)return e.date_str_to_date(t);throw new Error("get_safe_date: invalid input.")},e.get_safe_date_vector=function(t){if(t instanceof Date)return[t];var r;if("string"==typeof t)r=t.split(/\s+/);else{if(!Array.isArray(t))return null;r=t.slice()}for(var a=0;a<r.length;a++)if(r[a]=e.get_safe_date(r[a]),null===r[a])throw new Error("get_safe_date_vector: invalid input");return r},e.year_fraction_factory=function(e){if(!(e instanceof String)&&"string"!=typeof e)return i;var t=e.toLowerCase();if("a"===t.charAt(0)){if("actual/365"===t||"act/365"===t||"a/365"===t||"act/365 (fixed)"===t||"actual/365 (fixed)"===t)return i;if("act/360"===t||"a/360"===t)return s;if("act/act"===t||"a/a"===t)return _}return"3"===t.charAt(0)&&"30e/360"===t?o:i},e.time_from_now=function(t){return e.require_vd(),i(e.valuation_date,t)},e.add_days=function(e,t){return new Date(e.getFullYear(),e.getMonth(),e.getDate()+t)},e.add_months=function(e,t,r){for(var n,i=e.getFullYear(),s=e.getMonth()+t;s>=12;)s-=12,i+=1;for(;s<0;)s+=12,i-=1;return n=r||e.getDate(),new Date(i,s,Math.min(n,a(i,s)))},e.add_period=function(t,r){var a=parseInt(r,10);if(isNaN(a))throw new Error("period_str_to_time(str) - Invalid time period string: "+r);var n=r.charAt(r.length-1);if("Y"===n||"y"===n)return e.add_months(t,12*a);if("M"===n||"m"===n)return e.add_months(t,a);if("W"===n||"w"===n)return e.add_days(t,7*a);if("D"===n||"d"===n)return e.add_days(t,a);throw new Error("period_str_to_time(str) - Invalid time period string: "+r)};var f={};e.add_calendar=function(r,a){if(!(r instanceof String||"string"==typeof r))throw new Error("add_calendar: invalid input.");if(!Array.isArray(a))throw new Error("add_calendar: invalid input.");var n,i,s,o=a.length,_=[];for(n=0;n<o;n++)(s=e.get_safe_date(a[n]))&&(l(s)||_.push(s));for(o=_.length,n=1;n<41&&!((i=n*n-n+41)>=o/10);)n++;var u=new Array(i);for(n=0;n<i;n++)u[n]=[];for(n=0;n<o;n++)u[Math.floor(_[n].getTime()*t)%i].push(_[n].getTime());return f[r.toLowerCase()]=u,i},e.is_holiday_factory=function(e){var r=e.toLowerCase();if("target"===r)return u;if(Array.isArray(f[r])){var a=f[r];return function(e){if(l(e))return!0;for(var r=e.getTime(),n=Math.floor(r*t)%a.length,i=0;i<a[n].length;i++)if(r===a[n][i])return!0;return!1}}return l},e.adjust=function(t,r,a){var n,i=(r||"u").charAt(0).toLowerCase(),s=new Date(t);if("u"===i)return s;if("m"===i&&(n=s.getMonth()),"m"===i||"f"===i)for(;a(s);)s=e.add_days(s,1);if("f"===i)return s;if("m"===i&&n===s.getMonth())return s;for("m"===i&&(s=e.add_days(s,-1));a(s);)s=e.add_days(s,-1);return s},e.add_business_days=function(t,r,a){for(var n=t,i=r;i>0;)n=e.adjust(e.add_days(n,1),"f",a),i--;return n}}(this.JsonRisk||module.exports),function(e){var t=null,r=function(e){if(1!==e)if(1!==t.vector_length){if(e!==t.vector_length)throw new Error("vector_pricing: parameters need to have the same length or length one")}else t.vector_length=e};e.store_params=function(a){var n,i,s,o,_,l,u,f;if((t={vector_length:1,scalars:{},curves:{},surfaces:{}}).valuation_date=e.get_safe_date(a.valuation_date),"object"==typeof a.scalars)for(n=Object.keys(a.scalars),i=0;i<n.length;i++)t.scalars[n[i]]=(s=a.scalars[n[i]],Array.isArray(s.value)?{value:s.value}:{value:[s.value]}),r(t.scalars[n[i]].value.length);if("object"==typeof a.curves)for(n=Object.keys(a.curves),i=0;i<n.length;i++)l=a.curves[n[i]],o={times:e.get_curve_times(l),dfs:l.dfs?Array.isArray(l.dfs[0])?l.dfs:[l.dfs]:null,zcs:l.zcs?Array.isArray(l.zcs[0])?l.zcs:[l.zcs]:null},t.curves[n[i]]=o,_=o.dfs?o.dfs.length:o.zcs.length,r(_);if("object"==typeof a.surfaces)for(n=Object.keys(a.surfaces),i=0;i<n.length;i++)t.surfaces[n[i]]=(u=a.surfaces[n[i]],void 0,{expiries:(f=e.get_safe_surface(u)).expiries,terms:f.terms,values:Array.isArray(u.values[0][0])?u.values:[u.values]}),r(t.surfaces[n[i]].values.length)},e.get_params=function(){return t},e.set_params=function(e){if("object"!=typeof e)throw new Error("vector_pricing: try to hard set invalid parameters. Use store_params to normalize and store params.");if("number"!=typeof e.vector_length)throw new Error("vector_pricing: try to hard set invalid parameters. Use store_params to normalize and store params.");t=e};var a=function(e,t){return e?{times:e.times,dfs:e.dfs?e.dfs[e.dfs.length>1?t:0]:null,zcs:e.zcs?e.zcs[e.zcs.length>1?t:0]:null}:null};e.get_internal_object=function(t){switch(t.type.toLowerCase()){case"bond":case"floater":return new e.fixed_income(t);case"swap":return new e.swap(t);case"swaption":return new e.swaption(t);case"fxterm":return new e.fxterm(t);case"callable_bond":return new e.callable_fixed_income(t);default:throw new Error("get_internal_object: invalid instrument type")}},e.vector_pricer=function(r){if("string"!=typeof r.type)throw new Error("vector_pricer: instrument object must contain valid type");e.valuation_date=t.valuation_date;for(var n,i,s,o,_,l,u=e.get_internal_object(r),f=t.curves[r.disc_curve||""]||null,c=t.curves[r.spread_curve||""]||null,d=t.curves[r.fwd_curve||""]||null,h=t.surfaces[r.surface||""]||null,p=t.scalars[r.currency||""]||null,m=new Array(t.vector_length),g=0;g<t.vector_length;g++){switch(n=a(f,g),i=a(c,g),s=a(d,g),l=g,o=(_=h)?{expiries:_.expiries,terms:_.terms,values:_.values[_.values.length>1?l:0]}:null,r.type.toLowerCase()){case"bond":case"floater":case"fxterm":case"irregular_bond":m[g]=u.present_value(n,i,s);break;case"swap":case"swaption":m[g]=u.present_value(n,s,o);break;case"callable_bond":m[g]=u.present_value(n,i,s,o)}p&&(m[g]/=p.value[p.value.length>1?g:0])}return m}}(this.JsonRisk||module.exports);