/*! json_risk 29-09-2019 */

!function(t,e){"object"==typeof module&&"undefined"!=typeof exports?module.exports=e():t.JsonRisk=e()}(this,function(){var t={valuation_date:null,require_vd:function(){if(!(t.valuation_date instanceof Date))throw new Error("JsonRisk: valuation_date must be set")}};return t}),function(t){t.callable_fixed_income=function(e){if("number"!=typeof e.fixed_rate)throw new Error("callable_fixed_income: must provide valid fixed_rate.");var r,a=t.get_safe_date(e.first_call_date);if(null===a)throw new Error("callable_fixed_income: must provide first call date");for(this.base=new t.simple_fixed_income(e),this.call_schedule=t.schedule(a,t.get_safe_date(e.maturity),e.call_tenor||0,this.base.adj),this.call_schedule.pop(),this.basket=new Array(this.call_schedule.length),r=0;r<this.call_schedule.length;r++)this.basket[r]=new t.swaption({is_payer:!1,maturity:e.maturity,expiry:this.call_schedule[r],notional:e.notional,fixed_rate:e.fixed_rate,tenor:12,float_spread:0,float_tenor:6,float_current_rate:0,calendar:"TARGET",bdc:"u",float_bdc:"u",dcc:"act/365",float_dcc:"act/365"})},t.callable_fixed_income.prototype.present_value=function(e,r,a,i){var n,s=0;t.require_vd();var o,_=[];for(n=0;n<this.call_schedule.length;n++)(o=t.time_from_now(this.call_schedule[n]))>1/512&&_.push(o);if("object"!=typeof i||null===i)throw new Error("callable_fixed_income.present_value: must provide valid surface");var l=t.lgm_calibrate(this.basket,e,a,i);return 1===l.length?s=-t.lgm_european_call_on_cf(this.base.get_cash_flows(),_[0],e,l[0],r,null):1<l.length&&(s=-t.lgm_bermudan_call_on_cf(this.base.get_cash_flows(),_,e,l,r,null)),s+=this.base.present_value(e,r,null)},t.pricer_callable_bond=function(e,r,a,i,n){return new t.callable_fixed_income(e).present_value(r,a,i,n)}}(this.JsonRisk||module.exports),function(t){var e=null;function r(r,a){if(!r.times){if(r.days)return r.days[a]/365;if(r.dates)return(e=e||t.year_fraction_factory("a/365"))(t.get_safe_date(r.dates[0]),t.get_safe_date(r.dates[a]));if(r.labels)return t.period_str_to_time(r.labels[a]);throw new Error("get_time_at: invalid curve, cannot derive times")}return r.times[a]}function a(t,e){if(Array.isArray(t.dfs))return t.dfs[e];if(Array.isArray(t.zcs))return Math.pow(1+t.zcs[e],-r(t,e));throw new Error("get_df: invalid curve, must provide dfs or zcs")}t.get_const_curve=function(t){if("number"!=typeof t)throw new Error("get_const_curve: input must be number.");if(t<=-1)throw new Error("get_const_curve: invalid input.");return{type:"yield",times:[1],dfs:[1/(1+t)]}},t.get_curve_times=function(t){var e=(t.times||t.days||t.dates||t.labels||[]).length;if(!e)throw new Error("get_curve_times: invalid curve, need to provide valid times, days, dates, or labels");for(var a=new Array(e);e>0;)a[--e]=r(t,e);return a},t.get_safe_curve=function(e){return e?{type:"yield",times:t.get_curve_times(e),dfs:function(t){var e=(t.times||t.days||t.dates||t.labels||[]).length;if(!e)throw new Error("get_curve_dfs: invalid curve, need to provide valid times, days, dates, or labels");if(t.dfs){if(t.dfs.length!==e)throw new Error("get_curve_dfs: invalid curve, dfs length must match times length")}else if(t.zcs.length!==e)throw new Error("get_curve_dfs: invalid curve, zcs length must match times length");for(var r=new Array(e);e>0;)if(r[--e]=t.dfs?t.dfs[e]:a(t,e),"number"!=typeof r[e])throw new Error("get_curve_dfs: invalid curve, must provide numeric zcs or dfs");return r}(e)}:t.get_const_curve(0)},t.get_df=function(e,i,n,s){if(void 0===n&&(n=0),void 0===s&&(s=(e.times||e.days||e.dates||e.labels).length-1),i<1/512)return 1;if(n===s)return i===r(e,n)?a(e,n):Math.pow(a(e,n),i/r(e,n));if(i<r(e,n))return Math.pow(a(e,n),i/r(e,n));if(i>r(e,s))return Math.pow(a(e,s),i/r(e,s));if(n+1===s){if(r(e,s)-r(e,n)<1/512)throw new Error("get_df_internal: invalid curve, support points must be increasing and differ at least one day");return a(e,n)*(r(e,s)-i)/(r(e,s)-r(e,n))+a(e,s)*(i-r(e,n))/(r(e,s)-r(e,n))}return imed=Math.ceil((n+s)/2),i>r(e,imed)?t.get_df(e,i,imed,s):t.get_df(e,i,n,imed)},t.get_rate=function(e,r){return r<1/512?0:Math.pow(t.get_df(e,r),-1/r)-1},t.get_fwd_rate=function(e,r,a){return a-r<1/512?0:Math.pow(t.get_df(e,a)/t.get_df(e,r),-1/(a-r))-1}}(this.JsonRisk||module.exports),function(t){t.fxterm=function(e){this.near_leg=new t.simple_fixed_income({notional:e.notional,maturity:e.maturity,fixed_rate:0,tenor:0}),"number"==typeof e.notional_2&&t.get_safe_date(e.maturity_2)?this.far_leg=new t.simple_fixed_income({notional:e.notional_2,maturity:e.maturity_2,fixed_rate:0,tenor:0}):this.far_leg=null},t.fxterm.prototype.present_value=function(t){var e=0;return e+=this.near_leg.present_value(t,null,null),this.far_leg&&(e+=this.far_leg.present_value(t,null,null)),e},t.pricer_fxterm=function(e,r){return new t.fxterm(e).present_value(r)}}(this.JsonRisk||module.exports),function(t){t.irregular_fixed_income=function(e,r){var a=t.get_safe_date(e.maturity);if(!a)throw new Error("irregular_fixed_income: must provide maturity date.");var i=t.get_safe_date(e.effective_date);if(!i)throw new Error("irregular_fixed_income: must provide effective date.");if("number"!=typeof e.notional)throw new Error("irregular_fixed_income: must provide valid notional.");this.notional=e.notional;var n=t.get_safe_natural(e.tenor);if(null===n)throw new Error("irregular_fixed_income: must provide valid tenor.");var s=t.get_safe_date(e.first_date),o=t.get_safe_date(e.next_to_last_date);this.current_accrued_interest=e.current_accrued_interest||0,this.type="string"==typeof e.type?e.type:"unknown",this.is_holiday_func=t.is_holiday_factory(e.calendar||""),this.year_fraction_func=t.year_fraction_factory(e.dcc||""),this.bdc=e.bdc||"",this.adj=function(e){return t.adjust(e,this.bdc,this.is_holiday_func)};var _=t.get_safe_natural(e.repay_tenor);if(null===_&&(_=n),this.linear_amortization=e.linear_amortization||!1,this.repay_amount="number"==typeof e.repay_amount?e.repay_amount:0,this.repay_amount<0)throw new Error("irregular_fixed_income: invalid negative repay_amount");this.interest_capitalization=e.interest_capitalization||!1;var l,f=t.get_safe_date(e.repay_first_date)||this.first_date,u=t.get_safe_date(e.repay_next_to_last_date)||this.next_to_last_date;if(Array.isArray(e.conditions_valid_until)){for(this.conditions_valid_until=new Array(e.conditions_valid_until.length-1),l=0;l<this.conditions_valid_until.length;l++)if(this.conditions_valid_until[l]=t.get_safe_date(e.conditions_valid_until[l]),!this.conditions_valid_until[l])throw new Error("irregular_fixed_income: invalid set of dates provided under conditions_valid_until.");if(this.conditions_valid_until[l-1].getTime()!==a.getTime())throw new Error("irregular_fixed_income: last date provided under conditions_valid_until must match maturity")}else this.conditions_valid_until=[a];var c=t.get_safe_natural(e.settlement_days)||0;this.settlement_date=t.add_business_days(t.valuation_date,c,this.is_holiday_func);"number"==typeof e.residual_spread&&e.residual_spread,e.currency;if("number"==typeof e.fixed_rate)this.is_float=!1,this.fixed_rate=e.fixed_rate,this.float_spread=0,this.cap_rate=0,this.floor_rate=0,this.fixing_schedule=[i,a];else{if(this.is_float=!0,this.fixed_rate=null,this.float_spread="number"==typeof e.float_spread?e.float_spread:0,"number"!=typeof e.current_rate)throw new Error("irregular_fixed_income: must provide valid current_rate.");this.current_rate=e.current_rate;var d=t.get_safe_natural(e.fixing_tenor);null===d&&(d=n);var h=t.get_safe_date(e.fixing_first_date)||this.first_date,p=t.get_safe_date(e.fixing_next_to_last_date)||this.next_to_last_date;this.cap_rate="number"==typeof e.cap_rate?e.cap_rate:Number.POSITIVE_INFINITY,this.floor_rate="number"==typeof e.floor_rate?e.floor_rate:Number.POSITIVE_INFINITY,this.fixing_schedule=t.schedule(i,a,d,this.adj,h,p)}this.schedule=t.schedule(i,a,n,this.adj,s,o),this.repay_schedule=t.schedule(i,a,_,this.adj,f,u),this.cash_flows=this.initialize_cash_flows(),this.is_float||this.update_cash_flows(null)},t.irregular_fixed_income.prototype.update_cash_flows=function(e){t.require_vd();t.year_fraction_factory(null);for(var r=this.cash_flows,a=this.notional>=0?1:-1,i=0;this.conditions_valid_until[i]<r.date_accrual_start[0];)i++;var n=0;this.is_float||(n="number"==typeof this.fixed_rate?this.fixed_rate:this.fixed_rate[i]);var s,o="number"==typeof this.repay_amount?this.repay_amount:this.repay_amount[i],_="boolean"==typeof this.interest_capitalization?this.interest_capitalization:this.interest_capitalization[i],l="number"==typeof this.float_spread?this.float_spread:this.float_spread[i];"number"==typeof this.cap_rate?this.cap_rate:this.cap_rate[i],"number"==typeof this.floor_rate?this.floor_rate:this.floor_rate[i];if(this.is_float)if(r.date_accrual_start[0]<=t.valuation_date)n=this.current_rate;else{for(s=0;!r.is_fixing_date[s]&&s<r.is_fixing_date.length;)s++;n=t.get_fwd_rate(e,r.t_accrual_start[0],r.t_accrual_end[s])+l}var f,u=r.date_accrual_start.length;for(f=0;f<u;f++)if(r.current_principal[f]=f>0?r.current_principal[f-1]-r.pmt_principal[f-1]:this.notional,r.is_repay_date[f]?r.pmt_principal[f]=o*a:r.pmt_principal[f]=0,r.interest_current_period[f]=r.current_principal[f]*n*this.year_fraction_func(r.date_accrual_start[f],r.date_accrual_end[f]),r.accrued_interest[f]=(f>0?r.accrued_interest[f-1]:0)+r.interest_current_period[f],r.is_interest_date[f]?(r.pmt_interest[f]=r.accrued_interest[f],r.accrued_interest[f]=0,_&&(r.pmt_principal[f]=r.pmt_principal[f]-r.pmt_interest[f])):r.pmt_interest[f]=0,(f<u-1&&r.pmt_principal[f]*a>r.current_principal[f]*a||f===u-1)&&(r.pmt_principal[f]=r.current_principal[f]),r.pmt_total[f]=r.pmt_principal[f]+r.pmt_interest[f],r.is_condition_date[f]&&(i++,this.is_float||(n="number"==typeof this.fixed_rate?this.fixed_rate:this.fixed_rate[i]),o="number"==typeof this.repay_amount?this.repay_ampount:this.repay_amount[i],_="boolean"==typeof this.interest_capitalization?this.interest_capitalization:this.interest_capitalization[i],l="number"==typeof this.float_spread?this.float_spread:this.float_spread[i],"number"==typeof this.cap_rate?this.cap_rate:this.cap_rate[i],"number"==typeof this.floor_rate?this.floor_rate:this.floor_rate[i]),this.is_float)if(r.date_accrual_start[f]<=t.valuation_date)n=this.current_rate;else if(r.is_fixing_date[f]){for(s=0;!r.is_fixing_date[f+s]&&f+s<r.is_fixing_date.length;)s++;n=t.get_fwd_rate(e,r.t_accrual_start[f],r.t_accrual_end[f+s])+l}},t.irregular_fixed_income.prototype.initialize_cash_flows=function(){t.require_vd();for(var e=new Array(this.schedule.length-1),r=new Array(this.schedule.length-1),a=new Array(this.schedule.length-1),i=new Array(this.schedule.length-1),n=new Array(this.schedule.length-1),s=new Array(this.schedule.length-1),o=0,_=1,l=1,f=1,u=0;e[o]=o>0?r[o-1]:this.schedule[0],r[o]=new Date(Math.min(this.schedule[_],this.repay_schedule[l],this.fixing_schedule[f],this.conditions_valid_until[u])),_<this.schedule.length&&r[o].getTime()===this.schedule[_].getTime()?(a[o]=!0,_++):a[o]=!1,l<this.repay_schedule.length&&r[o].getTime()===this.repay_schedule[l].getTime()?(i[o]=!0,l++):i[o]=!1,f<this.fixing_schedule.length&&r[o].getTime()===this.fixing_schedule[f].getTime()?(n[o]=!0,f++):n[o]=!1,u<this.conditions_valid_until.length&&r[o].getTime()===this.conditions_valid_until[u].getTime()?(s[o]=!0,u++):s[o]=!1,_!==this.schedule.length||l!==this.repay_schedule.length||f!==this.fixing_schedule.length;)o++;var c=new Array(e.length),d=new Array(e.length),h=new Array(e.length),p=new Array(e.length),m=new Array(e.length),g=new Array(e.length),v=new Array(e.length),w=new Array(e.length),y=new Array(e.length),x=new Array(e.length);for(o=0;o<e.length;o++)c[o]=this.adj(r[o]),p[o]=t.time_from_now(c[o]),d[o]=t.time_from_now(e[o]),h[o]=t.time_from_now(r[o]);return{date_accrual_start:e,date_accrual_end:r,date_pmt:c,t_accrual_start:d,t_accrual_end:h,t_pmt:p,is_interest_date:a,is_repay_date:i,is_fixing_date:n,is_condition_date:s,current_principal:m,interest_current_period:g,accrued_interest:v,pmt_principal:w,pmt_interest:y,pmt_total:x}},t.irregular_fixed_income.prototype.present_value=function(e,r,a){return this.is_float&&this.update_cash_flows(a),t.dcf(this.cash_flows,e,r,this.residual_spread,this.settlement_date)},t.pricer_irregular_bond=function(e,r,a,i){return new t.irregular_fixed_income(e).present_value(r,a,i)}}(this.JsonRisk||module.exports),function(t){"use strict";function e(t){return t}t.lgm_dcf=function(r,a,i,n,s,o,_){if(!Array.isArray(s))throw new Error("lgm_dcf: state variable must be an array of numbers");for(var l,f,u,c=0,d=new Array(s.length);r.t_pmt[c]<=a;)c++;var h=0;for(r.pmt_interest&&(h=0===c?0:r.pmt_interest[c]*(a-r.t_pmt[c-1])/(r.t_pmt[c]-r.t_pmt[c-1])),f=t.get_df(i,a),o&&(f*=t.get_df(o,a)),_&&(f*=Math.pow(1+_,-a)),l=0;l<s.length;l++)d[l]=-(r.current_principal[c]+h)*f;for(;c<r.t_pmt.length;){for(f=t.get_df(i,r.t_pmt[c]),o&&(f*=t.get_df(o,r.t_pmt[c])),_&&(f*=Math.pow(1+_,-r.t_pmt[c])),u=e(r.t_pmt[c])-e(a),l=0;l<s.length;l++)d[l]+=r.pmt_total[c]*f*Math.exp(-u*s[l]-u*u*n*.5);c++}return d},t.lgm_european_call_on_cf=function(r,a,i,n,s,o){if(a<0)return 0;if(a<1/512||n<1e-15)return Math.max(0,t.lgm_dcf(r,a,i,0,[0],s,o)[0]);function _(e){return t.lgm_dcf(r,a,i,n,[e],s,o)[0]}var l,f,u,c,d,h=Math.sqrt(n),p=1/h,m=r.t_pmt[r.t_pmt.length-1];if(f=e(r.t_pmt[r.t_pmt.length-1])-e(a),u=-.5*n*f,u-=Math.log(t.get_df(i,a))/f,u+=Math.log(t.get_df(i,m))/f,s&&(u-=Math.log(t.get_df(s,a))/f,u+=Math.log(t.get_df(s,m))/f),o&&(u+=a*o,u-=m*o),u>-1e-10&&(u=-h),_(u)>0)for(d=u,c=.9*u;_(c)>0;)c=d-2*c;else for(c=u,d=2*u;_(c)<0;)d*=2;l=t.find_root_ridders(_,d,c,100);for(var g,v=0;r.t_pmt[v]<=a;)v++;var w=0;r.pmt_interest&&(w=0===v?0:r.pmt_interest[v]*(a-r.t_pmt[v-1])/(r.t_pmt[v]-r.t_pmt[v-1])),g=t.get_df(i,a),s&&(g*=t.get_df(s,a)),o&&(g*=Math.pow(1+o,-a));for(var y=-(r.current_principal[v]+w)*g*t.cndf(l*p);v<r.t_pmt.length;)g=t.get_df(i,r.t_pmt[v]),s&&(g*=t.get_df(s,r.t_pmt[v])),o&&(g*=Math.pow(1+o,-r.t_pmt[v])),f=e(r.t_pmt[v])-e(a),y+=r.pmt_total[v]*g*t.cndf(l*p+f*h),v++;return y},t.lgm_european_swaption_adjusted_cashflow=function(t,e,r,a){var i,n=t.swap.fair_rate(e,e);if(a)i=n;else{var s=t.swap.fair_rate(e,r);i=t.swap.fixed_rate-s+n}for(var o=t.swap.fixed_leg_1bp.get_cash_flows(),_=new Array(o.pmt_total.length),l=new Array(o.pmt_interest.length),f=0;f<o.pmt_total.length;f++)l[f]=o.pmt_interest[f]*i*1e4,_[f]=l[f];return _[f-1]+=o.current_principal[f-1],{current_principal:o.current_principal,t_pmt:o.t_pmt,date_pmt:o.date_pmt,pmt_interest:l,pmt_total:_}},t.lgm_european_swaption=function(e,r,a,i,n){var s=t.lgm_european_swaption_adjusted_cashflow(e,a,n);return t.lgm_european_call_on_cf(s,r,a,i,null,null)},t.lgm_calibrate=function(r,a,i,n){t.require_vd();var s,o,_,l,f,u,c,d,h,p,m,g,v=[],w=function(e){return t.lgm_european_call_on_cf(o,l,a,e*e,null,null)-c};for(h=0;h<r.length;h++)if(t.time_from_now(r[h].expiry)>1/512){for(l=t.time_from_now(r[h].expiry),f=t.time_from_now(r[h].maturity),o=t.lgm_european_swaption_adjusted_cashflow(r[h],a,i,!1),u=0,p=0;p<o.t_pmt.length;p++)u+=o.pmt_total[p]*t.get_df(a,o.t_pmt[p])*(e(o.t_pmt[p])-e(l));_=t.get_surface_rate(n,l,f-l)*Math.sqrt(l),s=Math.pow(_*r[h].swap.annuity(a)/u,2),g=(m=t.lgm_dcf(o,l,a,0,[0],null,null)[0])+r[h].swap.fixed_leg.notional*t.get_df(a,l),m<0&&(m=0),(c=r[h].present_value(a,i,n))<m&&(c=m),c>g&&(c=g);try{s=(d=t.find_root_secant(w,Math.sqrt(s),Math.sqrt(.9*s),100))*d}catch(t){}v.length>0&&v[v.length-1]>s&&(s=v[v.length-1]),v.push(s)}return v};var r=4;t.lgm_bermudan_call_on_cf=function(e,a,i,n,s,o){if(a[a.length-1]<0)return 0;if(a[a.length-1]<1/512||n[n.length-1]<1e-15)return Math.max(0,t.lgm_dcf(e,a[a.length-1],i,0,[0],s,o)[0]);function _(){var t=new Array(y);for(t[0]=-r*p,c=1;c<y;c++)t[c]=t[0]+c*m;return t}function l(){var t=0;for(c=0;c<y;c++)b[c]=Math.max(A[c],w[c]),!t&&c>0&&(w[c]-A[c])*(w[c-1]-A[c-1])<0&&(t=c);if(t){var e=b[t-1],r=b[t],a=Math.min(w[t-1],A[t-1]),i=Math.min(w[t],A[t]),n=(e-a)/(r-i+e-a),s=.25*(n*(r-i)+(1-n)*(e-a));b[t]-=n*s,b[t-1]-=(1-n)*s}}function f(e){if(x-h<1e-15)return b[e];var r,a=0,i=0,n=1/Math.sqrt(x-h);for(c=0;c<y;c++)r=c===y-1?1:t.cndf((v[c]-g[e]+.5*m)*n),a+=b[c]*(r-i),i=r;return a}var u,c,d,h,p,m,g,v,w,y=2*r*15+1,x=0,b=new Array(y),A=new Array(y);for(d=n.length-1;d>=0;){if(h=n[d],p=Math.sqrt(h),m=p/15,g=_(),w=t.lgm_dcf(e,a[d],i,h,g,s,o),d<n.length-1)for(u=0;u<y;u++)A[u]=f(u);else for(u=0;u<y;u++)A[u]=0;l(),x=h,v=g,m,d--}return g=[0],h=0,A=f(0)}}(this.JsonRisk||module.exports),function(t){"use strict";var e=Math.sqrt(4*Math.acos(0));t.get_safe_positive=function(t){return"number"!=typeof t?null:t<=0?null:t},t.get_safe_natural=function(t){return"number"!=typeof t?null:t<0||t!==Math.floor(t)?null:t},t.ndf=function(t){return Math.exp(-t*t/2)/e},t.cndf=function(t){var r,a=Math.abs(t);if(a<=37){var i=Math.exp(-a*a/2);if(a<7.07106781186547)r=i*((((((.0352624965998911*a+.700383064443688)*a+6.37396220353165)*a+33.912866078383)*a+112.079291497871)*a+221.213596169931)*a+220.206867912376)/(((((((.0883883476483184*a+1.75566716318264)*a+16.064177579207)*a+86.7807322029461)*a+296.564248779674)*a+637.333633378831)*a+793.826512519948)*a+440.413735824752);else r=i/(e*(a+1/(a+2/(a+3/(a+4/(a+.65))))))}else{if(!(a>37))throw new Error("cndf: invalid input.");r=0}return t<=0?r:1-r},t.find_root_secant=function(t,e,r,a,i){var n=e,s=r,o=0,_=a||20,l=i||1e-8,f=t(n),u=t(s);for(Math.abs(u)>Math.abs(f)&&(o=n,n=s,s=o,o=f,f=u,u=o);Math.abs(u)>l&&_>0;)o=(n-s)*u/(u-f),f=u,u=t(s=(n=s)+o),_--;if(_<=0)throw new Error("find_root_secant: failed, too many iterations");if(isNaN(s))throw new Error("find_root_secant: failed, invalid result");return s},t.find_root_ridders=function(t,e,r,a,i){var n,s,o,_=e,l=r,f=0,u=0,c=0,d=a||20,h=i||1e-8,p=t(_),m=t(l);if(p*m>0)throw new Error("find_root_ridders: start values do not bracket the root");if(Math.abs(p)<h)return _;if(Math.abs(m)<h)return l;for(;d>0;){if(d--,n=t(f=.5*(_+l)),Math.abs(n)<h)return f;if(0===(c=Math.sqrt(n*n-m*p)))return f;if(u=(f-_)*((o=p-m)>0?1:o<0?-1:0)*n/c+f,isNaN(u)&&(u=f),s=t(u),Math.abs(s)<h)return u;n*s<0?(_=u,p=s,l=f,m=n):p*s<0?(l=u,m=s):m*s<0&&(_=u,p=s)}if(d<=0)throw new Error("find_root_ridders: failed, too many iterations")}}(this.JsonRisk||module.exports),function(t){var e=function(e,r,a,i){for(var n=[e],s=1,o=t.add_months(e,a);o.getTime()<r.getTime();)n.push(o),s++,o=t.add_months(e,s*a);return i(r).getTime()<=i(n[n.length-1]).getTime()&&n.pop(),n},r=function(e,r,a,i){for(var n=[r],s=1,o=t.add_months(r,-a);o.getTime()>e.getTime();)n.unshift(o),s++,o=t.add_months(r,-s*a);return i(e).getTime()>=i(n[0]).getTime()&&n.shift(),n};t.schedule=function(a,i,n,s,o,_,l,f){if(!(i instanceof Date))throw new Error("schedule: maturity must be provided");if(!(a instanceof Date)){if(null===t.valuation_date)throw new Error("schedule: if valuation_date is unset, effective date must be provided");if(o instanceof Date)throw new Error("schedule: if first date is provided, effective date must be provided");if(!(_ instanceof Date)&&l)throw new Error("schedule: if next to last date is not provided and stub in the end is specified, effective date must be provided")}if(a instanceof Date&&i<a||t.valuation_date instanceof Date&&i<t.valuation_date)throw new Error("schedule: maturity is before valution or effective date.");if("number"!=typeof n)throw new Error("schedule: tenor must be a nonnegative integer, e.g., 6 for semiannual schedule, 0 for zerobond/iam schedule");if(n<0||Math.floor(n)!==n)throw new Error("schedule: tenor must be a nonnegative integer, e.g., 6 for semiannual schedule, 0 for zerobond/iam schedule");return 0===n?[a instanceof Date?a:t.valuation_date,i]:(o instanceof Date&&!(_ instanceof Date)?((u=e(o,i,n,s)).push(i),a.getTime()!==o.getTime()&&u.unshift(a)):_ instanceof Date&&!(o instanceof Date)?(u=r(a instanceof Date?a:t.valuation_date,_,n,s),i.getTime()!==_.getTime()&&u.push(i),a instanceof Date&&u.unshift(a),a instanceof Date||u.unshift(t.add_months(u[0],-n))):o instanceof Date&&_ instanceof Date?(u=r(o,_,n,s),i.getTime()!==_.getTime()&&u.push(i),u.unshift(o),u.unshift(a)):l?(u=e(a,i,n,s),f&&u.length>1&&u.pop(),u.push(i)):(u=r(a instanceof Date?a:t.valuation_date,i,n,s),f&&u.length>1&&u.shift(),a instanceof Date&&u.unshift(a),a instanceof Date||u.unshift(t.add_months(u[0],-n))),u);var u}}(this.JsonRisk||module.exports),function(t){t.dcf=function(e,r,a,i,n){var s=r||t.get_safe_curve(null),o=a||t.get_safe_curve(null);t.require_vd(),"number"!=typeof i&&(i=0);var _=t.get_safe_date(n);if(_||(_=t.valuation_date),void 0===e.t_pmt||void 0===e.pmt_total)throw new Error("dcf: invalid cashflow object");if(e.t_pmt.length!==e.pmt_total.length)throw new Error("dcf: invalid cashflow object");for(var l,f,u,c=0,d=0;e.date_pmt[d]<=_;)d++;for(;d<e.t_pmt.length;)l=t.get_df(s,e.t_pmt[d]),f=t.get_df(o,e.t_pmt[d]),u=Math.pow(1+i,-e.t_pmt[d]),c+=e.pmt_total[d]*l*f*u,d++;return c},t.irr=function(e,r,a){t.require_vd(),a||(a=0);var i=t.time_from_now(r);return t.find_root_secant(function(n){return t.dcf(e,null,null,n,r)+a*Math.pow(1+n,-i)},0,1e-4)},t.simple_fixed_income=function(e,r){var a=t.get_safe_date(e.maturity);if(!a)throw new Error("simple_fixed_income: must provide maturity date.");if("number"!=typeof e.notional)throw new Error("simple_fixed_income: must provide valid notional.");this.notional=e.notional,this.include_notional_pmt=!1!==r;var i=t.get_safe_natural(e.tenor);if(null===i)throw new Error("simple_fixed_income: must provide valid tenor.");this.type="string"==typeof e.type?e.type:"unknown",this.is_holiday_func=t.is_holiday_factory(e.calendar||""),this.year_fraction_func=t.year_fraction_factory(e.dcc||""),this.bdc=e.bdc||"";var n=t.get_safe_date(e.effective_date),s=t.get_safe_date(e.first_date),o=t.get_safe_date(e.next_to_last_date),_=t.get_safe_natural(e.settlement_days)||0;this.settlement_date=t.add_business_days(t.valuation_date,_,this.is_holiday_func);"number"==typeof e.residual_spread&&e.residual_spread,e.currency;if("number"==typeof e.fixed_rate)this.is_float=!1,this.fixed_rate=e.fixed_rate;else{if(this.is_float=!0,this.float_spread="number"==typeof e.float_spread?e.float_spread:0,"number"!=typeof e.float_current_rate)throw new Error("simple_fixed_income: must provide valid float_current_rate.");this.current_rate=e.float_current_rate}this.adj=function(e){return t.adjust(e,this.bdc,this.is_holiday_func)},this.schedule=t.schedule(n,a,i,this.adj,s,o),this.cash_flows=this.fix_cash_flows(this.schedule,this.bdc,this.is_holiday_func,this.year_fraction_func,this.notional,this.is_float?this.current_rate:this.fixed_rate)},t.simple_fixed_income.prototype.fix_cash_flows=function(e,r,a,i,n,s){t.require_vd();var o,_=new Array(e.length-1),l=new Array(e.length-1),f=new Array(e.length-1),u=new Array(e.length-1),c=new Array(e.length-1),d=new Array(e.length-1),h=new Array(e.length-1),p=new Array(e.length-1),m=new Array(e.length-1),g=new Array(e.length-1),v=new Array(e.length-1),w=new Array(e.length-1),y=new Array(e.length-1),x=new Array(e.length-1),b=new Array(e.length-1),A=new Array(e.length-1);for(o=0;o<e.length-1;o++)_[o]=e[o],l[o]=e[o+1],f[o]=this.adj(e[o+1]),d[o]=t.time_from_now(f[o]),u[o]=t.time_from_now(e[o]),c[o]=t.time_from_now(e[o+1]),h[o]=!0,p[o]=!1,m[o]=!1,g[o]=!1,v[o]=n,w[o]=n*s*i(_[o],l[o]),y[o]=w[o],x[o]=0,b[o]=w[o],A[o]=b[o];return this.include_notional_pmt&&(A[e.length-2]+=n,x[e.length-2]+=n),p[e.length-2]=!0,{date_accrual_start:_,date_accrual_end:l,date_pmt:f,t_accrual_start:u,t_accrual_end:c,t_pmt:d,is_interest_date:h,is_repay_date:p,is_fixing_date:m,is_condition_date:g,current_principal:v,interest_current_period:w,accrued_interest:y,pmt_principal:x,pmt_interest:b,pmt_total:A}},t.simple_fixed_income.prototype.get_cash_flows=function(e){if(!this.is_float)return this.cash_flows;var r,a,i,n=this.cash_flows,s=n.t_pmt.length;for(r=0;r<s;r++)n.is_fixing_date[r]=!0,a=n.date_accrual_start[r]<t.valuation_date?this.current_rate:t.get_fwd_rate(e,n.t_accrual_start[r],n.t_accrual_end[r])+this.float_spread,i=this.notional*a*this.year_fraction_func(n.date_accrual_start[r],n.date_accrual_end[r]),n.interest_current_period[r]=i,n.accrued_interest[r]=i,n.pmt_interest[r]=i,n.pmt_total[r]=i;return this.include_notional_pmt&&(n.pmt_total[s-1]=n.pmt_interest[s-1]+this.notional),n},t.simple_fixed_income.prototype.present_value=function(e,r,a){return t.dcf(this.get_cash_flows(t.get_safe_curve(a)||null),t.get_safe_curve(e),t.get_safe_curve(r),this.residual_spread,this.settlement_date)},t.pricer_bond=function(e,r,a){return new t.simple_fixed_income(e).present_value(r,a,null)},t.pricer_floater=function(e,r,a,i){return new t.simple_fixed_income(e).present_value(r,a,i)}}(this.JsonRisk||module.exports),function(t){function e(e,r){if(e.terms)return e.terms[r];if(e.labels_term)return t.period_str_to_time(e.labels_term[r]);throw new Error("get_term_at: invalid surface, cannot derive terms")}function r(e,r){if(e.expiries)return e.expiries[r];if(e.labels_expiry)return t.period_str_to_time(e.labels_expiry[r]);throw new Error("get_expiry_at: invalid surface, cannot derive expiries")}function a(t,r,i,n,s){n=n||0,s=s||(t.terms||t.labels_term||[]).length-1;var o=t.values[r];if(!Array.isArray(o))throw new Error("get_slice_rate: invalid surface, values property must be an array of arrays");return n===s?o[n]:i<e(t,n)?o[n]:i>e(t,s)?o[s]:n+1===s?o[n]*(e(t,s)-i)/(e(t,s)-e(t,n))+o[s]*(i-e(t,n))/(e(t,s)-e(t,n)):(imed=Math.ceil((n+s)/2),i>e(t,imed)?a(t,r,i,imed,s):a(t,r,i,n,imed))}t.get_const_surface=function(t,e){if("number"!=typeof t)throw new Error("get_const_surface: input must be number.");return{type:e||"",expiries:[1],terms:[1],values:[[t]]}},t.get_safe_surface=function(a){return a?{type:a.type||"",expiries:function(t){var e=(t.expiries||t.labels_expiry||[]).length;if(!e)throw new Error("get_surface_terms: invalid surface, need to provide valid expiries or labels_expiry");for(var a=new Array(e);e>0;)a[--e]=r(t,e);return a}(a),terms:function(t){var r=(t.terms||t.labels_term||[]).length;if(!r)throw new Error("get_surface_terms: invalid surface, need to provide valid terms or labels_term");for(var a=new Array(r);r>0;)a[--r]=e(t,r);return a}(a),values:a.values}:t.get_const_surface(0)},t.get_surface_rate=function(e,i,n,s,o){return(s=s||0)===(o=o||(e.expiries||e.labels_expiry||[]).length-1)?a(e,s,n):i<r(e,s)?a(e,s,n):i>r(e,o)?a(e,o,n):s+1===o?a(e,s,n)*(r(e,o)-i)/(r(e,o)-r(e,s))+a(e,o,n)*(i-r(e,s))/(r(e,o)-r(e,s)):(imed=Math.ceil((s+o)/2),i>r(e,imed)?t.get_surface_rate(e,i,n,imed,o):t.get_surface_rate(e,i,n,s,imed))}}(this.JsonRisk||module.exports),function(t){t.swap=function(e){this.phi=e.is_payer?-1:1,this.fixed_rate=e.fixed_rate,this.fixed_leg=new t.simple_fixed_income({notional:e.notional*this.phi,maturity:e.maturity,fixed_rate:e.fixed_rate,tenor:e.tenor,effective_date:e.effective_date,calendar:e.calendar,bdc:e.bdc,dcc:e.dcc},!1),this.fixed_leg_1bp=new t.simple_fixed_income({notional:e.notional*this.phi,maturity:e.maturity,fixed_rate:1e-4,tenor:e.tenor,effective_date:e.effective_date,calendar:e.calendar,bdc:e.bdc,dcc:e.dcc},!1),this.float_leg=new t.simple_fixed_income({notional:-e.notional*this.phi,maturity:e.maturity,float_spread:e.float_spread,tenor:e.float_tenor,effective_date:e.effective_date,calendar:e.calendar,bdc:e.float_bdc,dcc:e.float_dcc,float_current_rate:e.float_current_rate},!1)},t.swap.prototype.fair_rate=function(t,e){var r=this.float_leg.present_value(t,null,e);return-this.phi*r/this.annuity(t)},t.swap.prototype.annuity=function(t){return this.fixed_leg_1bp.present_value(t)*this.phi*1e4},t.swap.prototype.present_value=function(t,e){var r=0;return r+=this.fixed_leg.present_value(t,null,null),r+=this.float_leg.present_value(t,null,e)},t.swap.prototype.get_cash_flows=function(t){return{fixed_leg:this.fixed_leg.get_cash_flows(),float_leg:this.float_leg.get_cash_flows(t)}},t.pricer_swap=function(e,r,a){return new t.swap(e).present_value(r,a)}}(this.JsonRisk||module.exports),function(t){t.swaption=function(e){if(this.sign=e.is_short?-1:1,this.maturity=t.get_safe_date(e.maturity),!this.maturity)throw new Error("swaption: must provide valid maturity date.");if(this.expiry=t.get_safe_date(e.expiry),!this.expiry)throw new Error("swaption: must provide valid expiry date.");this.swap=new t.swap({is_payer:e.is_payer,notional:e.notional,effective_date:this.expiry,settlement_date:this.expiry,maturity:e.maturity,fixed_rate:e.fixed_rate,tenor:e.tenor,calendar:e.calendar,bdc:e.bdc,dcc:e.dcc,float_spread:e.float_spread,float_tenor:e.float_tenor,float_bdc:e.float_bdc,float_dcc:e.float_dcc,float_current_rate:e.float_current_rate})},t.swaption.prototype.present_value=function(e,r,a){t.require_vd();var i=t.time_from_now(this.maturity),n=t.time_from_now(this.expiry),s=i-n;if(s<1/512)return 0;var o=this.swap.fair_rate(e,r);if("object"!=typeof a||null===a)throw new Error("swaption.present_value: must provide valid surface");var _,l=t.get_surface_rate(a,n,s)*Math.sqrt(n);if(n<0)return 0;if(n<1/512||l<1e-4)_=Math.max(this.swap.phi*(this.swap.fixed_rate-o),0);else{var f=(this.swap.fixed_rate-o)/l;_=this.swap.phi*(this.swap.fixed_rate-o)*t.cndf(this.swap.phi*f)+l*t.ndf(f)}return _*=this.swap.annuity(e),_*=this.sign},t.pricer_swaption=function(e,r,a,i){return new t.swaption(e).present_value(r,a,i)},t.create_equivalent_regular_swaption=function(e,r,a){if(void 0===e.date_pmt||void 0===e.pmt_total||void 0===e.current_principal)throw new Error("create_equivalent_regular_swaption: invalid cashflow object");if(e.t_pmt.length!==e.pmt_total.length||e.t_pmt.length!==e.current_principal.length)throw new Error("create_equivalent_regular_swaption: invalid cashflow object");t.require_vd(),a||(a={});for(var i,n=a.tenor||6,s=a.bdc||"unadjusted",o=a.calendar||"",_=0;e.date_pmt[_]<=r;)_++;if(0===(i=e.current_principal[_]))throw new Error("create_equivalent_regular_swaption: invalid cashflow object or expiry, zero outstanding principal");var l=t.irr(e,r,-i);l=12/n*(Math.pow(1+l,n/12)-1);for(var f=t.get_const_curve(l+1e-4),u=t.get_const_curve(l-1e-4),c=t.dcf(e,f,null,null,r),d=t.dcf(e,u,null,null,r),h=1e4*(d-c)/(d+c),p=function(e){var r=new t.simple_fixed_income(e);return c=r.present_value(f),1e4*((d=r.present_value(u))-c)/(d+c)},m=Math.abs(l)<1e-8?h:-Math.log(1-h*l)/l,g=t.add_days(t.valuation_date,Math.round(365*m)),v={maturity:g,effective_date:r,settlement_date:r,notional:i,fixed_rate:l,tenor:n,calendar:o,bdc:s,dcc:"act/365"},w=p(v),y=10;Math.abs(w-h)>1/512&&y>0;)m=m*h/w,g=t.add_days(t.valuation_date,Math.round(365*m)),v.maturity=g,w=p(v),y--;return{is_payer:!1,maturity:g,expiry:r,effective_date:r,settlement_date:r,notional:i,fixed_rate:l,tenor:n,float_spread:0,float_tenor:6,float_current_rate:0,calendar:o,bdc:s,float_bdc:s,dcc:"act/365",float_dcc:"act/365"}}}(this.JsonRisk||module.exports),function(t){"use strict";var e=1/864e5;function r(t){return t%4==0&&(2e3===t||t%100!=0)}function a(t,e){return new Date(t,e+1,0).getDate()}function i(t,r){return Math.round((r-t)*e)}function n(t,e){return i(t,e)/365}function s(t,e){return i(t,e)/360}function o(t,e){return(360*(e.getFullYear()-t.getFullYear())+30*(e.getMonth()-t.getMonth())+(Math.min(e.getDate(),30)-Math.min(t.getDate(),30)))/360}function _(t,e){if(t-e==0)return 0;if(t>e)return-_(e,t);var a=t.getFullYear(),n=e.getFullYear();if(a===n)return i(t,e)/(r(a)?366:365);var s=n-a-1;return s+=i(t,new Date(a+1,0,1))/(r(a)?366:365),s+=i(new Date(n,0,1),e)/(r(n)?366:365)}function l(t){var e=t.getDay();return 0===e||6===e}function f(e){if(l(e))return!0;var r=e.getDate(),a=e.getMonth();if(1===r&&0===a)return!0;if(25===r&&11===a)return!0;var i=e.getFullYear();if((1998===i||1999===i||2001===i)&&31===r&&11===a)return!0;if(i>2e3){if(1===r&&4===a||26===r&&11===a)return!0;var n=function(t){var e=Math.floor,r=e(t/100),a=t-19*e(t/19),i=e((r-17)/25),n=r-e(r/4)-e((r-i)/3)+19*a+15;n-=30*e(n/30),n-=e(n/28)*(1-e(n/28)*e(29/(n+1))*e((21-a)/11));var s=t+e(t/4)+n+2-r+e(r/4),o=n-(s-=7*e(s/7)),_=3+e((o+40)/44),l=o+28-31*e(_/4);return new Date(t,_-1,l)}(i);if(e.getTime()===t.add_days(n,-2).getTime())return!0;if(e.getTime()===t.add_days(n,1).getTime())return!0}return!1}t.period_str_to_time=function(t){var e=parseInt(t,10),r=t.charAt(t.length-1);if("Y"===r||"y"===r)return e;if("M"===r||"m"===r)return e/12;if("W"===r||"w"===r)return e/52;if("D"===r||"d"===r)return e/365;throw new Error("period_str_to_time(str) - Invalid time period string: "+t)},t.date_str_to_date=function(t){var e,r,i,n=null;if(null!==(n=/^([1-2][0-9]{3})[\/-]([0-9]{1,2})[\/-]([0-9]{1,2})/.exec(t))?(i=parseInt(n[1],10),r=parseInt(n[2],10)-1,e=parseInt(n[3],10)):null!==(n=/^([0-9]{1,2})\.([0-9]{1,2})\.([1-2][0-9]{3})/.exec(t))&&(i=parseInt(n[3],10),r=parseInt(n[2],10)-1,e=parseInt(n[1],10)),null===n)throw new Error("date_str_to_time(str) - Invalid date string: "+t);if(r<0||r>11)throw new Error("date_str_to_time(str) - Invalid month in date string: "+t);if(e<0||e>a(i,r))throw new Error("date_str_to_time(str) - Invalid day in date string: "+t);return new Date(i,r,e)},t.get_safe_date=function(e){if(!e)return null;if(e instanceof Date)return e;if(e instanceof String||"string"==typeof e)return t.date_str_to_date(e);throw new Error("get_safe_date: invalid input.")},t.year_fraction_factory=function(t){if(!(t instanceof String)&&"string"!=typeof t)return n;var e=t.toLowerCase();if("a"===e.charAt(0)){if("actual/365"===e||"act/365"===e||"a/365"===e||"act/365 (fixed)"===e||"actual/365 (fixed)"===e)return n;if("act/360"===e||"a/360"===e)return s;if("act/act"===e||"a/a"===e)return _}return"3"===e.charAt(0)&&"30e/360"===e?o:n},t.time_from_now=function(e){return t.require_vd(),n(t.valuation_date,e)},t.add_days=function(t,e){return new Date(t.getFullYear(),t.getMonth(),t.getDate()+e)},t.add_months=function(t,e,r){for(var i,n=t.getFullYear(),s=t.getMonth()+e;s>=12;)s-=12,n+=1;for(;s<0;)s+=12,n-=1;return i=r||t.getDate(),new Date(n,s,Math.min(i,a(n,s)))};var u={};t.add_calendar=function(r,a){if(!(r instanceof String||"string"==typeof r))throw new Error("add_calendar: invalid input.");if(!Array.isArray(a))throw new Error("add_calendar: invalid input.");var i,n,s,o=a.length,_=[];for(i=0;i<o;i++)(s=t.get_safe_date(a[i]))&&(l(s)||_.push(s));for(o=_.length,i=1;i<41&&!((n=i*i-i+41)>=o/10);)i++;var f=new Array(n);for(i=0;i<n;i++)f[i]=[];for(i=0;i<o;i++)f[Math.floor(_[i].getTime()*e)%n].push(_[i].getTime());return u[r.toLowerCase()]=f,n},t.is_holiday_factory=function(t){var r=t.toLowerCase();if("target"===r)return f;if(Array.isArray(u[r])){var a=u[r];return function(t){if(l(t))return!0;for(var r=t.getTime(),i=Math.floor(r*e)%a.length,n=0;n<a[i].length;n++)if(r===a[i][n])return!0;return!1}}return l},t.adjust=function(e,r,a){var i,n=(r||"u").charAt(0).toLowerCase(),s=new Date(e);if("u"===n)return s;if("m"===n&&(i=s.getMonth()),"m"===n||"f"===n)for(;a(s);)s=t.add_days(s,1);if("f"===n)return s;if("m"===n&&i===s.getMonth())return s;for("m"===n&&(s=t.add_days(s,-1));a(s);)s=t.add_days(s,-1);return s},t.add_business_days=function(e,r,a){for(var i=e,n=r;n>0;)i=t.adjust(t.add_days(i,1),"f",a),n--;return i}}(this.JsonRisk||module.exports),function(t){var e=null,r=function(t){if(1!==t)if(1!==e.vector_length){if(t!==e.vector_length)throw new Error("vector_pricing: parameters need to have the same length or length one")}else e.vector_length=t};t.store_params=function(a){var i,n,s,o,_,l,f,u;if((e={vector_length:1}).valuation_date=t.get_safe_date(a.valuation_date),"object"==typeof a.scalars)for(e.scalars={},i=Object.keys(a.scalars),n=0;n<i.length;n++)e.scalars[i[n]]=(s=a.scalars[i[n]],Array.isArray(s.value)?{value:s.value}:{value:[s.value]}),r(e.scalars[i[n]].value.length);if("object"==typeof a.curves)for(e.curves={},i=Object.keys(a.curves),n=0;n<i.length;n++)l=a.curves[i[n]],o={times:t.get_curve_times(l),dfs:l.dfs?Array.isArray(l.dfs[0])?l.dfs:[l.dfs]:null,zcs:l.zcs?Array.isArray(l.zcs[0])?l.zcs:[l.zcs]:null},e.curves[i[n]]=o,_=o.dfs?o.dfs.length:o.zcs.length,r(_);if("object"==typeof a.surfaces)for(e.surfaces={},i=Object.keys(a.surfaces),n=0;n<i.length;n++)e.surfaces[i[n]]=(f=a.surfaces[i[n]],void 0,{expiries:(u=t.get_safe_surface(f)).expiries,terms:u.terms,values:Array.isArray(f.values[0][0])?f.values:[f.values]}),r(e.surfaces[i[n]].values.length)},t.get_params=function(){return e};var a=function(t,e){return t?{times:t.times,dfs:t.dfs?t.dfs[t.dfs.length>1?e:0]:null,zcs:t.zcs?t.zcs[t.zcs.length>1?e:0]:null}:null};t.vector_pricer=function(r){if("string"!=typeof r.type)throw new Error("vector_pricer: instrument object must contain valid type");t.valuation_date=e.valuation_date;for(var i,n,s,o,_,l,f=function(e){switch(e.type.toLowerCase()){case"bond":case"floater":return new t.simple_fixed_income(e);case"swap":return new t.swap(e);case"swaption":return new t.swaption(e);case"fxterm":return new t.fxterm(e);case"callable_bond":return new t.callable_fixed_income(e);default:throw new Error("vector_pricer: invalid instrument type")}}(r),u=e.curves[r.disc_curve||""]||null,c=e.curves[r.spread_curve||""]||null,d=e.curves[r.fwd_curve||""]||null,h=e.surfaces[r.surface||""]||null,p=e.scalars[r.currency||""]||null,m=new Array(e.vector_length),g=0;g<e.vector_length;g++){switch(i=a(u,g),n=a(c,g),s=a(d,g),l=g,o=(_=h)?{expiries:_.expiries,terms:_.terms,values:_.values[_.values.length>1?l:0]}:null,r.type.toLowerCase()){case"bond":case"floater":case"fxterm":m[g]=f.present_value(i,n,s);break;case"swap":case"swaption":m[g]=f.present_value(i,s,o);break;case"callable_bond":m[g]=f.present_value(i,n,s,o)}p&&(m[g]/=p.value[p.value.length>1?g:0])}return m}}(this.JsonRisk||module.exports);