/*! json_risk 30-09-2018 */

!function(t,e){"object"==typeof module&&"undefined"!=typeof exports?module.exports=e():t.JsonRisk=e()}(this,function(){var t={valuation_date:null,pricer:function(t,e){return null}};return t}),function(t){t.validate_bond=function(t){return"number"==typeof t.notional&&(t.maturity instanceof Date&&void 0)},t.pricer_bond=function(t,e){return null},t.bond_dirty_value=function(e,n,r,a){if(null===t.valuation_date)throw new Error("dcf: valuation_date must be set");if(!(e.maturity instanceof String)&&"string"!=typeof e.maturity)throw new Error("bond_dirty_value: must provide maturity date.");if("number"!=typeof e.notional)throw new Error("bond_dirty_value: must provide notional.");var i,o=t.is_holiday_factory(e.calendar||""),s=t.year_fraction_factory(e.dcc||""),d=t.date_str_to_date(e.maturity),f=void 0===e.effective_date?null:t.date_str_to_date(e.effective_date),u=void 0===e.first_date?null:t.date_str_to_date(e.first_date),l=void 0===e.next_to_last_date?null:t.date_str_to_date(e.next_to_last_date),_=t.backward_schedule(f,d,e.freq,o,e.bdc||"",u,l);i="number"==typeof e.fixed_rate?t.fix_cash_flows(_,e.bdc,o,s,e.notional,e.fixed_rate):t.float_cash_flows(_,e.bdc,o,s,e.notional,e.current_rate,e.float_spread,a);var c=t.adjust(t.add_days(t.valuation_date,"number"==typeof e.settlement_days?e.settlement_days:0),"following",o);return t.dcf(i,n,r,e.residual_spread,c)}}(this.JsonRisk||module.exports),function(t){t.get_const_curve=function(t){return{type:"yield",labels:["1Y"],times:[1],zcs:[t]}},get_df_internal=function(t,e,n,r){if(e<1/365/2)return 1;if(n==r)return e===t.times[n]?t.dfs[n]:Math.pow(t.dfs[n],e/t.times[n]);if(n+1==r){if(t.times[r]-t.times[n]<1/365/2)throw new Error("get_df_internal: invalid curve, support points must be increasing and differ at least one day");return t.dfs[n]*(t.times[r]-e)/(t.times[r]-t.times[n])+t.dfs[r]*(e-t.times[n])/(t.times[r]-t.times[n])}return e<t.times[n]?Math.pow(t.dfs[n],e/t.times[n]):e>t.times[r]?Math.pow(t.dfs[r],e/t.times[r]):(imed=Math.ceil((n+r)/2),e>t.times[imed]?get_df_internal(t,e,imed,r):get_df_internal(t,e,n,imed))},t.get_df=function(e,n){return function(e){var n;if(void 0==e.times)if(void 0!==e.days)for(n=e.days.length,e.times=new Array(n);n>0;)n--,e.times[n]=e.days[n]/365;else if(void 0!==e.dates)for(n=e.dates.length,e.times=new Array(n),yf=t.year_fraction_factory("act/365"),ref_date=t.date_str_to_date(e.dates[0]);n>0;)n--,e.times[n]=yf(ref_date,t.date_str_to_date(e.dates[n]));else{if(void 0===e.labels)throw new Error("init_curve: invalid curve, cannot derive times");for(n=e.labels.length,e.times=new Array(n);n>0;)n--,e.times[n]=t.period_str_to_time(e.labels[n])}if(void 0==e.dfs){if(void 0===e.zcs)throw new Error("init_curve: invalid curve, dfs and zcs both undefined");if((n=e.zcs.length)!==e.times.length)throw new Error("init_curve: invalid curve, length of zcs does not match length of times");for(e.dfs=new Array(n);n>0;)n--,e.dfs[n]=Math.exp(-e.zcs[n]*e.times[n])}if(e.times.length!==e.dfs.length)throw new Error("init_curve: invalid curve, length of dfs does not match length of times")}(e),get_df_internal(e,n,0,e.times.length-1)},t.get_rate=function(e,n){return n<1/365/2?0:-Math.log(t.get_df(e,n))/n},t.get_fwd_amount=function(e,n,r){return t.get_df(e,n)/t.get_df(e,r)-1}}(this.JsonRisk||module.exports),function(t){t.fix_cash_flows=function(e,n,r,a,i,o){if(null===t.valuation_date)throw new Error("fix_cash_flows: valuation_date must be set");var s,d,f=new Array(e.length-1),u=new Array(e.length-1),l=new Array(e.length-1),_=t.year_fraction_factory(null);for(s=1;s<e.length;s++)f[s-1]=(d=e[s],t.adjust(d,n,r)),u[s-1]=_(t.valuation_date,f[s-1]),l[s-1]=i*o*a(e[s-1],e[s]);return l[l.length-1]+=i,{schedule:e,dates:f,amounts:l,times:u}},t.float_cash_flows=function(e,n,r,a,i,o,s,d){if(null===t.valuation_date)throw new Error("float_cash_flows: valuation_date must be set");var f,u,l=new Array(e.length-1),_=new Array(e.length-1),c=new Array(e.length-1),m=t.year_fraction_factory(null);for(f=1;f<e.length;f++)1==f&&(c[f-1]=i*o*a(e[f-1],e[f])),l[f-1]=(u=e[f],t.adjust(u,n,r)),_[f-1]=m(t.valuation_date,l[f-1]);return t.update_float_cash_flows({schedule:e,dates:l,amounts:c}),{schedule:e,dates:l,amounts:c,times:_}},t.update_float_cash_flows=function(e,n,r,a,i){var o;for(o=2;o<e.schedule.length;o++)e.amounts[o-1]=r*t.get_fwd_amount(i,e.schedule[o-1],e.schedule[o])*yf(e.schedule[o-1],e.schedule[o]);e.amounts[e.amounts.length]+=r},t.dcf=function(e,n,r,a,i){if(null===t.valuation_date)throw new Error("dcf: valuation_date must be set");null==n&&(n=t.get_const_curve(0)),null==r&&(r=t.get_const_curve(0)),"number"!=typeof a&&(a=0);var o=i instanceof Date?i:t.valuation_date;if(void 0===e.times||void 0===e.amounts)throw new Error("dcf: invalid cashflow object");if(e.times.length!==e.amounts.length)throw new Error("dcf: invalid cashflow object");for(var s,d,f,u=0,l=0;e.dates[l]<=o;)l++;for(;l<e.times.length;)s=t.get_rate(n,e.times[l]),d=t.get_rate(r,e.times[l]),f=Math.pow(1+s+d+a,-e.times[l]),u+=e.amounts[l]*f,l++;return u}}(this.JsonRisk||module.exports),function(t){t.backward_schedule=function(e,n,r,a,i,o,s){if(!(n instanceof Date))throw new Error("backward_schedule: maturity must be provided");if(!(e instanceof Date)){if(null===t.valuation_date)throw new Error("backward_schedule: if valuation_date is unset, effective date must be provided");if(o instanceof Date)throw new Error("backward_schedule: if first date is provided, effective date must be provided")}if(e instanceof Date&&n<e||t.valuation_date instanceof Date&&n<t.valuation_date)throw new Error("backward_schedule: maturity is before valution or effective date.");if("number"!=typeof r)throw new Error("backward_schedule: freq must be a nonnegative integer, e.g., 6 for semiannual schedule, 0 for zerobond/iam schedule");if(r<0||Math.floor(r)!==r)throw new Error("backward_schedule: freq must be a nonnegative integer, e.g., 6 for semiannual schedule, 0 for zerobond/iam schedule");if(0===r)return[e,n];var d=function(e){return t.adjust(e,i,a)},f=[n],u=n;s instanceof Date&&d(s)<d(n)&&(f.unshift(s),u=s);for(var l,_=0;;){if(_++,l=t.add_months(u,-r*_),o instanceof Date&&l<o)return d(f[0]).getTime()!==d(o).getTime()&&f.unshift(o),d(f[0]).getTime()!==d(e).getTime()&&f.unshift(e),f;if(e instanceof Date&&l<e)return d(f[0]).getTime()!=d(e).getTime()&&f.unshift(e),f;if(t.valuation_date instanceof Date&&l<t.valuation_date)return f.unshift(l),d(l)>t.valuation_date&&(_++,l=t.add_months(u,-r*_),o instanceof Date&&l<o?f.unshift(o):e instanceof Date&&l<e?f.unshift(e):f.unshift(l)),f;f.unshift(l)}}}(this.JsonRisk||module.exports),function(t){function e(t){return t%4==0&&(2e3===t||t%100!=0)}function n(t,n){return 1===n?e(t)?29:28:3===n||5===n||8===n||10===n?30:31}function r(t,e){return(e-t)/864e5}function a(t,e){return r(t,e)/365}function i(t,e){return r(t,e)/360}function o(t,e){return(360*(e.getFullYear()-t.getFullYear())+30*(e.getMonth()-t.getMonth())+(Math.min(e.getDate(),30)-Math.min(t.getDate(),30)))/360}function s(t,n){if(t-n==0)return 0;if(t>n)return-s(n,t);var a=t.getFullYear(),i=n.getFullYear();if(a===i)return r(n,t)/(e(a)?366:365);var o=i-a-1;return o+=r(t,new Date(a+1,0,1))/(e(a)?366:365),o+=r(new Date(i,0,1),n)/(e(i)?366:365)}function f(t){return d=t.getDay(),0===d||6===d}function u(e){var n=e.getDay();if(0===n)return!0;if(6===n)return!0;var r=e.getDate(),a=e.getMonth();if(1===r&&0===a)return!0;if(25===r&&11===a)return!0;var i,o=e.getFullYear();if((1998===o||1999===o||2001===o)&&31===r&&11===a)return!0;if(o>2e3){if(1===r&&4===a||26===r&&11===a)return!0;var s=(i=o,es_d_m=[[15,3],[7,3],[30,2],[12,3],[3,3],[23,3],[15,3],[31,2],[19,3],[11,3],[27,2],[16,3],[7,3],[23,2],[12,3],[4,3],[23,3],[8,3],[31,2],[20,3],[4,3],[27,2],[16,3],[1,3],[20,3],[12,3],[4,3],[17,3],[8,3],[31,2],[20,3],[5,3],[27,2],[16,3],[1,3],[21,3],[12,3],[28,2],[17,3],[9,3],[24,2],[13,3],[5,3],[25,3],[9,3],[1,3],[21,3],[6,3],[28,2],[17,3],[9,3],[25,2],[13,3],[5,3],[18,3],[10,3],[1,3],[21,3],[6,3],[29,2],[17,3],[2,3],[22,3],[14,3],[29,2],[18,3],[10,3],[26,2],[14,3],[6,3],[29,2],[11,3],[2,3],[22,3],[14,3],[30,2],[18,3],[10,3],[26,2],[15,3],[6,3],[19,3],[11,3],[3,3],[22,3],[7,3],[30,2],[19,3],[3,3],[26,2],[15,3],[31,2],[19,3],[11,3],[3,3],[16,3],[7,3],[30,2],[12,3],[4,3],[23,3],[15,3],[31,2],[20,3],[11,3],[27,2],[16,3],[8,3],[23,2],[12,3],[4,3],[24,3],[8,3],[31,2],[20,3],[5,3],[27,2],[16,3],[1,3],[21,3],[12,3],[4,3],[17,3],[9,3],[31,2],[20,3],[5,3],[28,2],[16,3],[1,3],[21,3],[13,3],[28,2],[17,3],[9,3],[25,2],[13,3],[5,3],[25,3],[10,3],[1,3],[21,3],[6,3],[29,2],[17,3],[9,3],[25,2],[14,3],[5,3],[18,3],[10,3],[2,3],[21,3],[6,3],[29,2],[18,3],[2,3],[22,3],[14,3],[30,2],[18,3],[10,3],[26,2],[15,3],[6,3],[29,2],[11,3],[3,3],[22,3],[14,3],[30,2],[19,3],[10,3],[26,2],[15,3],[7,3],[19,3],[11,3],[3,3],[23,3],[7,3],[30,2],[19,3],[4,3],[26,2],[15,3],[31,2],[20,3],[11,3],[3,3],[16,3],[8,3],[30,2],[12,3],[4,3],[24,3],[15,3],[31,2],[20,3],[12,3],[28,2],[17,3],[9,3],[25,2],[13,3],[5,3],[18,3],[10,3],[1,3],[21,3],[6,3],[29,2],[17,3],[2,3],[22,3],[14,3],[29,2],[18,3],[10,3],[26,2],[14,3],[6,3],[29,2],[11,3],[2,3],[22,3],[14,3],[30,2],[18,3],[10,3],[26,2],[15,3],[6,3],[19,3],[11,3],[3,3],[22,3],[7,3],[30,2],[19,3],[3,3],[26,2],[15,3],[31,2],[19,3],[11,3],[3,3],[16,3],[7,3],[30,2],[12,3],[4,3],[23,3],[15,3],[31,2],[20,3],[11,3],[27,2],[16,3],[8,3],[23,2],[12,3],[4,3],[24,3],[8,3],[31,2],[20,3],[5,3],[27,2],[16,3],[1,3],[21,3],[12,3],[4,3],[17,3],[9,3],[31,2],[20,3],[5,3],[28,2],[16,3],[1,3],[21,3],[13,3],[28,2],[17,3],[9,3],[25,2],[13,3],[5,3],[25,3],[10,3],[1,3],[21,3],[6,3],[29,2],[17,3],[9,3],[25,2],[14,3],[6,3]],index=i-1900,index<0&&(index=0),index>es_d_m.length&&(index=es_d_m.length),new Date(i,es_d_m[index][1],es_d_m[index][0]));if(e.getTime()===t.add_days(s,-2).getTime())return!0;if(e.getTime()===t.add_days(s,1).getTime())return!0}return!1}t.period_str_to_time=function(t){var e=parseInt(t),n=t.charAt(t.length-1);if("Y"===n||"y"===n)return e;if("M"===n||"m"===n)return e/12;if("W"===n||"w"===n)return e/52;if("D"===n||"d"===n)return e/365;throw new Error("period_str_to_time(str) - Invalid time period string: "+t)},t.date_str_to_date=function(t){var e,r,a,i=null;if(null!==(i=/^([1-2][0-9]{3})[\/-]([0-9]{1,2})[\/-]([0-9]{1,2})/.exec(t))?(a=parseInt(i[1]),r=parseInt(i[2])-1,e=parseInt(i[3])):null!==(i=/^([0-9]{1,2})\.([0-9]{1,2})\.([1-2][0-9]{3})/.exec(t))&&(a=parseInt(i[3]),r=parseInt(i[2])-1,e=parseInt(i[1])),null===i)throw new Error("date_str_to_time(str) - Invalid date string: "+t);if(r<0||r>11)throw new Error("date_str_to_time(str) - Invalid month in date string: "+t);if(e<0||e>n(a,r))throw new Error("date_str_to_time(str) - Invalid day in date string: "+t);return new Date(a,r,e)},t.year_fraction_factory=function(t){if(!(t instanceof String)&&"string"!=typeof t)return a;var e=t.toLowerCase();if("a"===e.charAt(0)){if("actual/365"===e||"act/365"===e||"a/365"===e||"act/365 (fixed)"===e||"actual/365 (fixed)"===e)return a;if("act/360"===e||"a/360"===e)return i;if("act/act"===e||"a/a"===e)return s}return"3"===e.charAt(0)&&"30e/360"===e?o:a},t.add_days=function(t,e){return new Date(t.valueOf()+864e5*e)},t.add_months=function(t,e,r){for(y=t.getFullYear(),m=t.getMonth()+e;m>=12;)m-=12,y+=1;for(;m<0;)m+=12,y-=1;return d=null==r?t.getDate():r,new Date(y,m,Math.min(d,n(y,m)))},t.is_holiday_factory=function(t){return"target"===t.toLowerCase()?u:f},t.adjust=function(e,n,r){var a,i=(n||"u").charAt(0).toLowerCase(),o=new Date(e);if("u"===i)return o;if("m"===i&&(a=o.getMonth()),"m"===i||"f"===i)for(;r(o);)o=t.add_days(o,1);if("f"===i)return o;if("m"===i&&a===o.getMonth())return o;for("m"===i&&(o=t.add_days(o,-1));r(o);)o=t.add_days(o,-1);return o}}(this.JsonRisk||module.exports);