/*! json_risk 26-05-2021 */

!function(e,t){"object"==typeof module&&"undefined"!=typeof exports?module.exports=t():e.JsonRisk=t()}(this,function(){var e={valuation_date:null,require_vd:function(){if(!(e.valuation_date instanceof Date))throw new Error("JsonRisk: valuation_date must be set")}};return e}),function(l){l.callable_fixed_income=function(e){if(!l.get_safe_number_vector(e.fixed_rate))throw new Error("callable_fixed_income: must provide valid fixed_rate.");var t=l.get_safe_date(e.first_exercise_date);if(null===t)throw new Error("callable_fixed_income: must provide first call date");if(this.base=new l.fixed_income(e),t.getTime()<=this.base.schedule[0].getTime())throw new Error("callable_fixed_income: first call date before issue date");if(!this.base.notional_exchange)throw new Error("callable_fixed_income: callable instruments must exchange notionals");var r=l.get_safe_natural(e.call_tenor);this.call_schedule=l.schedule(t,l.get_safe_date(e.maturity),r||0,this.base.adj),this.call_schedule.pop(),this.opportunity_spread=l.get_safe_number(e.opportunity_spread)||0,this.exclude_base=l.get_safe_bool(e.exclude_base),this.simple_calibration=l.get_safe_bool(e.simple_calibration);for(var a=this.base.get_cash_flows(),n=a.current_principal.length-1;0===a.current_principal[n];)n--;for(;this.call_schedule[this.call_schedule.length-1]>=a.date_pmt[n];)this.call_schedule.pop();for(this.basket=new Array(this.call_schedule.length),n=0;n<this.call_schedule.length;n++)!this.base.is_amortizing&&1===this.base.fixed_rate.length||this.simple_calibration?this.basket[n]=new l.swaption({is_payer:!1,maturity:e.maturity,first_exercise_date:this.call_schedule[n],notional:e.notional,fixed_rate:e.fixed_rate-this.opportunity_spread,tenor:12,float_spread:0,float_tenor:e.float_tenor||6,float_current_rate:0,calendar:e.calendar,bdc:e.bdc,float_bdc:e.bdc,dcc:e.dcc,float_dcc:e.dcc}):this.basket[n]=new l.swaption(l.create_equivalent_regular_swaption(this.base.get_cash_flows(),this.call_schedule[n],{tenor:12,float_spread:0,float_tenor:e.float_tenor||6,calendar:e.calendar,bdc:e.bdc}))},l.callable_fixed_income.prototype.present_value=function(e,t,r,a){var n,i=0;l.require_vd();var s,o=[];for(n=0;n<this.call_schedule.length;n++)1/512<(s=l.time_from_now(this.call_schedule[n]))&&o.push(s);if("object"!=typeof e||null===e)throw new Error("callable_fixed_income.present_value: must provide discount curve");if("object"!=typeof r||null===r)throw new Error("callable_fixed_income.present_value: must provide forward curve for calibration");if("object"!=typeof a||null===a)throw new Error("callable_fixed_income.present_value: must provide valid surface");var _=l.lgm_calibrate(this.basket,e,r,a);return 1===_.length?i=-l.lgm_european_call_on_cf(this.base.get_cash_flows(),o[0],e,_[0],t,this.base.residual_spread,this.opportunity_spread):1<_.length&&(i=-l.lgm_bermudan_call_on_cf(this.base.get_cash_flows(),o,e,_,t,this.base.residual_spread,this.opportunity_spread)),this.exclude_base||(i+=this.base.present_value(e,t,null)),i},l.pricer_callable_bond=function(e,t,r,a,n){return new l.callable_fixed_income(e).present_value(t,r,a,n)}}(this.JsonRisk||module.exports),function(l){var r=null;function s(e,t){if(e.times)return e.times[t];if(e.days)return e.days[t]/365;if(e.dates)return(r=r||l.year_fraction_factory("a/365"))(l.get_safe_date(e.dates[0]),l.get_safe_date(e.dates[t]));if(e.labels)return l.period_str_to_time(e.labels[t]);throw new Error("get_time_at: invalid curve, cannot derive times")}function o(e,t){if(Array.isArray(e.dfs))return e.dfs[t];if(Array.isArray(e.zcs))return Math.pow(1+e.zcs[t],-s(e,t));throw new Error("get_df: invalid curve, must provide dfs or zcs")}l.get_const_curve=function(e,t){if("number"!=typeof e)throw new Error("get_const_curve: input must be number.");if(e<=-1)throw new Error("get_const_curve: invalid input.");return{type:t||"yield",times:[1],dfs:[1/(1+e)]}},l.get_curve_times=function(e){var t=(e.times||e.days||e.dates||e.labels||[]).length;if(!t)throw new Error("get_curve_times: invalid curve, need to provide valid times, days, dates, or labels");for(var r=new Array(t);0<t;)r[--t]=s(e,t);return r},l.get_safe_curve=function(e){return e?{type:"yield",times:l.get_curve_times(e),dfs:function(e){var t=(e.times||e.days||e.dates||e.labels||[]).length;if(!t)throw new Error("get_curve_dfs: invalid curve, need to provide valid times, days, dates, or labels");if(e.dfs){if(e.dfs.length!==t)throw new Error("get_curve_dfs: invalid curve, dfs length must match times length")}else if(e.zcs.length!==t)throw new Error("get_curve_dfs: invalid curve, zcs length must match times length");for(var r=new Array(t);0<t;)if(r[--t]=e.dfs?e.dfs[t]:o(e,t),"number"!=typeof r[t])throw new Error("get_curve_dfs: invalid curve, must provide numeric zcs or dfs");return r}(e)}:l.get_const_curve(0)},l.get_df=function(e,t,r,a){if(void 0===r&&(r=0),void 0===a&&(a=(e.times||e.days||e.dates||e.labels).length-1),t<1/512)return 1;var n=s(e,r);if(r===a)return t===n?o(e,r):Math.pow(o(e,r),t/n);var i=s(e,a);if(t<n)return Math.pow(o(e,r),t/n);if(i<t)return Math.pow(o(e,a),t/i);if(r+1!==a)return imed=Math.ceil((r+a)/2),t>s(e,imed)?l.get_df(e,t,imed,a):l.get_df(e,t,r,imed);if(i-n<1/512)throw new Error("get_df_internal: invalid curve, support points must be increasing and differ at least one day");return o(e,r)*(i-t)/(i-n)+o(e,a)*(t-n)/(i-n)},l.get_rate=function(e,t){return t<1/512?0:Math.pow(l.get_df(e,t),-1/t)-1},l.get_fwd_rate=function(e,t,r){return r-t<1/512?0:Math.pow(l.get_df(e,r)/l.get_df(e,t),-1/(r-t))-1},l.add_curves=function(e,t){for(var r,a=l.get_curve_times(e),n=l.get_curve_times(t),i=[],s=0,o=0,_=[];r=Number.POSITIVE_INFINITY,s<a.length&&(r=Math.min(a[s],r)),o<n.length&&(r=Math.min(n[o],r)),i.push(r),_.push(l.get_rate(e,r)+l.get_rate(t,r)),r===a[s]&&s<a.length&&s++,r===n[o]&&o<n.length&&o++,s!==a.length||o!==n.length;);return{times:i,zcs:_}}}(this.JsonRisk||module.exports),function(d){d.dcf=function(e,t,r,a,n){var i=t||d.get_safe_curve(null),s=r||d.get_safe_curve(null);d.require_vd(),"number"!=typeof a&&(a=0);var o=d.get_safe_date(n);if(o||(o=d.valuation_date),void 0===e.t_pmt||void 0===e.pmt_total)throw new Error("dcf: invalid cashflow object");if(e.t_pmt.length!==e.pmt_total.length)throw new Error("dcf: invalid cashflow object");for(var _,l,u,f=0,c=0;e.date_pmt[c]<=o;)c++;for(;c<e.t_pmt.length;)_=d.get_df(i,e.t_pmt[c]),l=d.get_df(s,e.t_pmt[c]),u=Math.pow(1+a,-e.t_pmt[c]),f+=e.pmt_total[c]*_*l*u,c++;return f},d.irr=function(t,r,a){d.require_vd(),a||(a=0);var n=d.time_from_now(r);return d.find_root_secant(function(e){return d.dcf(t,null,null,e,r)+a*Math.pow(1+e,-n)},0,1e-4)}}(this.JsonRisk||module.exports),function(y){y.fixed_income=function(e){var t=y.get_safe_date(e.maturity);if(!t)throw new Error("fixed_income: must provide maturity date.");var r=y.get_safe_date(e.effective_date);if("number"!=typeof e.notional)throw new Error("fixed_income: must provide valid notional.");this.notional=e.notional,this.notional_exchange=!1!==e.notional_exchange;var a=y.get_safe_natural(e.tenor);if(null===a)throw new Error("fixed_income: must provide valid tenor.");var n=y.get_safe_date(e.first_date),i=y.get_safe_date(e.next_to_last_date),s=e.stub_end||!1,o=e.stub_long||!1;this.current_accrued_interest=e.current_accrued_interest||0,this.type="string"==typeof e.type?e.type:"unknown",this.is_holiday_func=y.is_holiday_factory(e.calendar||""),this.year_fraction_func=y.year_fraction_factory(e.dcc||""),this.bdc=e.bdc||"",this.adjust_accrual_periods=e.adjust_accrual_periods||!1,this.adj=function(e){return y.adjust(e,this.bdc,this.is_holiday_func)};var _=y.get_safe_natural(e.repay_tenor);null===_&&(_=a);var l=e.linear_amortization||!1;this.repay_amount=y.get_safe_number_vector(e.repay_amount)||[0],this.interest_capitalization=y.get_safe_bool_vector(e.interest_capitalization);var u=y.get_safe_date(e.repay_first_date)||this.first_date,f=y.get_safe_date(e.repay_next_to_last_date)||this.next_to_last_date,c=e.stub_end||!1,d=e.stub_long||!1;if(this.conditions_valid_until=y.get_safe_date_vector(e.conditions_valid_until),this.conditions_valid_until){if(this.conditions_valid_until[this.conditions_valid_until.length-1].getTime()!==t.getTime())throw new Error("fixed_income: last date provided under conditions_valid_until must match maturity")}else this.conditions_valid_until=[t];var h=y.get_safe_natural(e.settlement_days)||0;this.settlement_date=y.get_safe_date(e.settlement_date)||y.add_business_days(y.valuation_date,h,this.is_holiday_func),this.residual_spread="number"==typeof e.residual_spread?e.residual_spread:0;e.currency;if(this.schedule=y.schedule(r,t,a,this.adj,n,i,s,o),e.fixed_rate||0===e.fixed_rate)this.is_float=!1,this.fixed_rate=y.get_safe_number_vector(e.fixed_rate),this.float_spread=0,this.cap_rate=0,this.floor_rate=0,this.fixing_schedule=[this.schedule[0],t];else{if(this.is_float=!0,this.fixed_rate=null,this.float_spread=y.get_safe_number_vector(e.float_spread)||[0],this.float_current_rate=y.get_safe_number(e.float_current_rate),null===this.float_current_rate)throw new Error("fixed_income: must provide valid float_current_rate.");var p=y.get_safe_natural(e.fixing_tenor);null===p&&(p=a);var m=y.get_safe_date(e.fixing_first_date)||this.first_date,g=y.get_safe_date(e.fixing_next_to_last_date)||this.next_to_last_date;e.fixing_stub_end,e.fixing_stub_long;this.cap_rate="number"==typeof e.cap_rate?e.cap_rate:Number.POSITIVE_INFINITY,this.floor_rate="number"==typeof e.floor_rate?e.floor_rate:Number.POSITIVE_INFINITY,this.fixing_schedule=y.schedule(this.schedule[0],t,p,this.adj,m,g)}this.is_amortizing=0<this.repay_amount.reduce(function(e,t){return Math.max(e*e,t*t)},0)||this.interest_capitalization.reduce(function(e,t){return e||t},!1)||l,this.is_amortizing?this.repay_schedule=y.schedule(this.schedule[0],t,_,this.adj,u,f,c,d):this.repay_schedule=[this.schedule[0],t],l&&(this.repay_amount=[Math.abs(this.notional)/(this.repay_schedule.length-1)]),this.cash_flows=this.initialize_cash_flows(),this.is_float||(this.cash_flows=this.finalize_cash_flows(null))},y.fixed_income.prototype.initialize_cash_flows=function(){y.require_vd();var e=new Array(this.schedule.length),t=new Array(this.schedule.length),r=new Array(this.schedule.length),a=new Array(this.schedule.length),n=new Array(this.schedule.length),i=new Array(this.schedule.length);e[0]=this.schedule[0],t[0]=this.schedule[0],r[0]=!1,a[0]=!1,n[0]=!0,i[0]=!1;for(var s=1,o=1,_=1,l=1,u=0;e[s]=t[s-1],t[s]=new Date(Math.min(this.schedule[o],this.repay_schedule[_],this.fixing_schedule[l],this.conditions_valid_until[u])),o<this.schedule.length&&t[s].getTime()===this.schedule[o].getTime()?(r[s]=!0,o++):r[s]=!1,_<this.repay_schedule.length&&t[s].getTime()===this.repay_schedule[_].getTime()?(a[s]=!0,_++):a[s]=!1,l<this.fixing_schedule.length&&t[s].getTime()===this.fixing_schedule[l].getTime()?(n[s]=!0,l++):n[s]=!1,u<this.conditions_valid_until.length&&t[s].getTime()===this.conditions_valid_until[u].getTime()?(i[s]=!0,u++):i[s]=!1,o!==this.schedule.length||_!==this.repay_schedule.length||l!==this.fixing_schedule.length;)s++;var f=new Array(e.length),c=new Array(e.length),d=new Array(e.length),h=new Array(e.length),p=(new Array(e.length),new Array(e.length));new Array(e.length),new Array(e.length),new Array(e.length),new Array(e.length),new Array(e.length);for(s=0;s<e.length;s++)this.adjust_accrual_periods&&(e[s]=this.adj(e[s]),t[s]=this.adj(t[s])),f[s]=this.adj(t[s]),h[s]=y.time_from_now(f[s]),c[s]=y.time_from_now(e[s]),d[s]=y.time_from_now(t[s]),p[s]=0===s?0:this.year_fraction_func(e[s],t[s]);return{date_accrual_start:e,date_accrual_end:t,date_pmt:f,t_accrual_start:c,t_accrual_end:d,t_pmt:h,is_interest_date:r,is_repay_date:a,is_fixing_date:n,is_condition_date:i,accrual_factor:p}},y.fixed_income.prototype.finalize_cash_flows=function(e,t){y.require_vd();y.year_fraction_factory(null);for(var r=this.cash_flows,a=r.date_accrual_start.length,n=new Array(a),i=new Array(a),s=new Array(a),o=new Array(a),_=new Array(a),l=new Array(a),u=new Array(a),f=0<=this.notional?1:-1,c=0;this.conditions_valid_until[c]<r.date_accrual_start[0];)c++;var d,h,p,m,g=this.repay_amount[Math.min(c,this.repay_amount.length-1)],v=this.interest_capitalization[Math.min(c,this.interest_capitalization.length-1)],w=(this.cap_rate[Math.min(c,this.cap_rate.length-1)],this.floor_rate[Math.min(c,this.floor_rate.length-1)],this.is_float?this.float_spread:this.fixed_rate);for(p="number"==typeof t?function(){return t}:function(){return w[Math.min(c,w.length-1)]},_[o[s[i[n[0]=0]=0]=0]=0]=-this.notional,u[l[0]=0]=this.notional_exchange?-this.notional:0,m=1;m<a;m++){if(n[m]=n[m-1]-_[m-1],r.is_repay_date[m]?_[m]=g*f:_[m]=0,this.is_float)if(r.date_accrual_start[m]<=y.valuation_date)i[m]=this.float_current_rate;else if(r.is_fixing_date[m-1]){for(h=0;!r.is_fixing_date[m+h]&&m+h<r.is_fixing_date.length;)h++;i[m]=y.get_fwd_rate(e,r.t_accrual_start[m],r.t_accrual_end[m+h])}else i[m]=i[m-1];else i[m]=0;d=i[m]+p(),s[m]=n[m]*d*r.accrual_factor[m],o[m]=(0<m?o[m-1]:0)+s[m],r.is_interest_date[m]?(l[m]=o[m],o[m]=0,v&&(_[m]=_[m]-l[m])):l[m]=0,(m<a-1&&_[m]*f>n[m]*f||m===a-1)&&(_[m]=n[m]),u[m]=l[m],this.notional_exchange&&(u[m]+=_[m]),r.is_condition_date[m]&&(c++,g=this.repay_amount[Math.min(c,this.repay_amount.length-1)],v=this.interest_capitalization[Math.min(c,this.interest_capitalization.length-1)],this.cap_rate[Math.min(c,this.cap_rate.length-1)],this.floor_rate[Math.min(c,this.floor_rate.length-1)])}return{date_accrual_start:r.date_accrual_start,date_accrual_end:r.date_accrual_end,date_pmt:r.date_pmt,t_accrual_start:r.t_accrual_start,t_accrual_end:r.t_accrual_end,t_pmt:r.t_pmt,is_interest_date:r.is_interest_date,is_repay_date:r.is_repay_date,is_fixing_date:r.is_fixing_date,is_condition_date:r.is_condition_date,accrual_factor:r.accrual_factor,current_principal:n,fwd_rate:i,interest_current_period:s,accrued_interest:o,pmt_principal:_,pmt_interest:l,pmt_total:u}},y.fixed_income.prototype.get_cash_flows=function(e){if(this.is_float){if("object"!=typeof e||null===e)throw new Error("fixed_income.get_cash_flows: Must provide forward curve when evaluating floating rate interest stream");return this.finalize_cash_flows(e)}return this.cash_flows},y.fixed_income.prototype.present_value=function(e,t,r){if("object"!=typeof e||null===e)throw new Error("fixed_income.present value: Must provide discount curve when evaluating interest stream");if(this.is_float&&("object"!=typeof r||null===r))throw new Error("fixed_income.present value: Must provide forward curve when evaluating floating rate interest stream");return y.dcf(this.get_cash_flows(y.get_safe_curve(r)||null),y.get_safe_curve(e),y.get_safe_curve(t),this.residual_spread,this.settlement_date)},y.fixed_income.prototype.fair_rate_or_spread=function(e,t,r){y.require_vd();for(var a,n=y.get_safe_curve(r)||y.get_const_curve(0),i=this.finalize_cash_flows(n),s=0;i.date_pmt[s]<=y.valuation_date;)s++;a=i.current_principal[s];var o=new Array(i.pmt_total.length),_=0;for(s=0;s<o.length;s++)o[s]=i.pmt_principal[s],_+=i.current_principal[s]*i.accrual_factor[s]*i.fwd_rate[s],i.is_interest_date[s]&&(o[s]+=_,_=0);var l=a-y.dcf({date_pmt:i.date_pmt,t_pmt:i.t_pmt,pmt_total:o},e,t,this.residual_spread,this.settlement_date);return l/=this.annuity(e,t,n)},y.fixed_income.prototype.annuity=function(e,t,r){var a,n=this.get_cash_flows(y.get_safe_curve(r)||y.get_const_curve(0)),i=new Array(n.pmt_total.length),s=0;for(a=0;a<i.length;a++)i[a]=0,s+=n.current_principal[a]*n.accrual_factor[a],n.is_interest_date[a]&&(i[a]+=s,s=0);return y.dcf({date_pmt:n.date_pmt,t_pmt:n.t_pmt,pmt_total:i},y.get_safe_curve(e),y.get_safe_curve(t),this.residual_spread,this.settlement_date)},y.pricer_bond=function(e,t,r){return new y.fixed_income(e).present_value(t,r,null)},y.pricer_floater=function(e,t,r,a){return new y.fixed_income(e).present_value(t,r,a)}}(this.JsonRisk||module.exports),function(r){r.fxterm=function(e){this.near_leg=new r.fixed_income({notional:e.notional,maturity:e.maturity,fixed_rate:0,tenor:0}),"number"==typeof e.notional_2&&r.get_safe_date(e.maturity_2)?this.far_leg=new r.fixed_income({notional:e.notional_2,maturity:e.maturity_2,fixed_rate:0,tenor:0}):this.far_leg=null},r.fxterm.prototype.present_value=function(e){var t=0;return t+=this.near_leg.present_value(e,null,null),this.far_leg&&(t+=this.far_leg.present_value(e,null,null)),t},r.pricer_fxterm=function(e,t){return new r.fxterm(e).present_value(t)}}(this.JsonRisk||module.exports),function(E){"use strict";function y(e){return e}function A(e,t,r,a,n){for(var i,s=new Array(e.t_pmt.length+1),o=0;e.t_pmt[o]<=0;)o++;for(;o<e.t_pmt.length;)i=E.get_df(r,e.t_pmt[o]),a&&(i*=E.get_df(a,e.t_pmt[o])),n&&(i*=Math.pow(1+n,-e.t_pmt[o])),s[o]=i,o++;return i=E.get_df(r,t),a&&(i*=E.get_df(a,t)),n&&(i*=Math.pow(1+n,-t)),s[o]=i,s}function b(e,t,r,a){if(!a)return 0;for(var n=0,i=0;e.t_pmt[n]<=t;)n++;for(;n<e.t_pmt.length;)i+=e.current_principal[n]*r[n]*a*(e.t_pmt[n]-Math.max(e.t_pmt[n-1],t)),n++;return i/=r[r.length-1]}E.lgm_dcf=function(e,t,r,a,n,i){if(!Array.isArray(n))throw new Error("lgm_dcf: state variable must be an array of numbers");for(var s,o,_=0,l=new Array(n.length);e.t_pmt[_]<=t;)_++;var u=0;e.pmt_interest&&(u=0===_?0:e.pmt_interest[_]*(t-e.t_pmt[_-1])/(e.t_pmt[_]-e.t_pmt[_-1]));var f=b(e,t,r,i);for(s=0;s<n.length;s++)l[s]=-(e.current_principal[_]+u+f)*r[r.length-1];for(;_<e.t_pmt.length;){for(o=y(e.t_pmt[_])-y(t),s=0;s<n.length;s++)l[s]+=e.pmt_total[_]*r[_]*E.fast_exp(-o*n[s]-o*o*a*.5);_++}return l},E.lgm_european_call_on_cf=function(t,r,a,n,i,s,o,e){var _=e||A(t,r,a,i,s);if(r<0)return 0;if(r<1/512||n<1e-10)return Math.max(0,E.lgm_dcf(t,r,_,0,[0],o)[0]);var l,u=Math.sqrt(n),f=y(r+1/365)-y(r);function c(e){return E.lgm_dcf(t,r,_,n,[e],o)[0]}if(20/f<u)l=-10*(u=20/f);else{var d,h;if(0<=c(0)){if((d=0)<c(h=u*j))return E.lgm_dcf(t,r,_,0,[0],o)[0]}else if(h=0,c(d=-u*j)<0)return 0;try{l=E.find_root_ridders(c,h,d,20)}catch(e){return E.lgm_bermudan_call_on_cf(t,[r],a,[n],i,s,o)}}for(var p=0,m=1/u;t.t_pmt[p]<=r;)p++;var g=0;t.pmt_interest&&(g=0===p?0:t.pmt_interest[p]*(r-t.t_pmt[p-1])/(t.t_pmt[p]-t.t_pmt[p-1]));for(var v=b(t,r,_,o),w=-(t.current_principal[p]+g+v)*_[_.length-1]*E.cndf(l*m);p<t.t_pmt.length;)f=y(t.t_pmt[p])-y(r),w+=t.pmt_total[p]*_[p]*E.cndf(l*m+f*u),p++;return w},E.lgm_european_swaption_adjusted_cashflow=function(e,t,r,a){var n,i=e.swap.fair_rate(t,t);if(a)n=i;else{var s=e.swap.fair_rate(t,r);n=e.swap.fixed_rate-s+i}var o=e.swap.fixed_leg.finalize_cash_flows(null,n);return o.pmt_total[0]-=o.current_principal[1],o.pmt_total[o.pmt_total.length-1]+=o.current_principal[o.pmt_total.length-1],o},E.lgm_european_swaption=function(e,t,r,a,n){var i=E.lgm_european_swaption_adjusted_cashflow(e,r,n);return E.lgm_european_call_on_cf(i,t,r,a,null,null,null)},E.lgm_calibrate=function(e,t,r,a){E.require_vd();var n,i,s,o,_,l,u,f,c,d,h,p,m,g,v=[],w=function(e){return E.lgm_european_call_on_cf(i,_,t,e,null,null,null,s)-f};for(d=0;d<e.length;d++)if(E.time_from_now(e[d].first_exercise_date)>1/512){for(_=E.time_from_now(e[d].first_exercise_date),l=E.time_from_now(e[d].maturity),i=E.lgm_european_swaption_adjusted_cashflow(e[d],t,r,!1),s=A(i,_,t,null,null),h=u=0;h<i.t_pmt.length;h++)u+=i.pmt_total[h]*s[h]*(y(i.t_pmt[h])-y(_));if(o=E.get_surface_rate(a,_,l-_)*Math.sqrt(_),n=Math.pow(o*e[d].swap.annuity(t)/u,2),m=(p=E.lgm_dcf(i,_,s,0,[0],null)[0])+e[d].swap.fixed_leg.notional*s[s.length-1],p<0&&(p=0),(f=e[d].present_value(t,r,a))<=p+(g=1e-7*f+1e-7)||0===n)n=0;else{for(m<f&&(f=m),c=w(n),h=10;c<0&&0<h;)h--,c=w(n*=2);try{n=E.find_root_ridders(w,0,n,20,g)}catch(e){Math.abs(f-p)<Math.abs(c)&&(n=0)}}0<v.length&&v[v.length-1]>n&&(n=v[v.length-1]),v.push(n)}return v};var j=4;E.lgm_bermudan_call_on_cf=function(e,t,r,a,n,i,s){if(t[t.length-1]<0)return 0;if(t[t.length-1]<1/512)return E.lgm_european_call_on_cf(e,t[t.length-1],r,0,n,i,s);function o(){var e=new Array(y);for(e[0]=-j*h,f=1;f<y;f++)e[f]=e[0]+f*p;return e}function _(){var e=0;for(f=0;f<y;f++)x[f]=Math.max(M[f],v[f]),!e&&0<f&&(v[f]-M[f])*(v[f-1]-M[f-1])<0&&(e=f);if(e){var t=x[e-1],r=x[e],a=Math.min(v[e-1],M[e-1]),n=Math.min(v[e],M[e]),i=(t-a)/(r-n+t-a),s=.25*(i*(r-n)+(1-i)*(t-a));x[e]-=i*s,x[e-1]-=(1-i)*s}}function l(e){if(b-d<1e-15)return x[e];var t,r=0,a=0,n=1/Math.sqrt(b-d);for(f=0;f<y;f++)t=f===y-1?1:E.fast_cndf((g[f]-m[e]+.5*p)*n),r+=x[f]*(t-a),a=t;return r}var u,f,c,d,h,p,m,g,v,w,y=2*j*15+1,b=0,x=new Array(y),M=new Array(y);for(c=a.length-1;0<=c;){if(d=a[c],h=Math.sqrt(d),p=h/15,m=o(),w=A(e,t[c],r,n,i),v=E.lgm_dcf(e,t[c],w,d,m,s),c<a.length-1)for(u=0;u<y;u++)M[u]=l(u);else for(u=0;u<y;u++)M[u]=0;_(),b=d,g=m,p,c--}return m=[0],M=l(d=0)}}(this.JsonRisk||module.exports),function(a){"use strict";var n=Math.sqrt(4*Math.acos(0));a.get_safe_number=function(e){if("number"==typeof e)return e;if("string"!=typeof e)return null;e=e.trim();var t=parseFloat(e);return isNaN(t)?null:("%"===e.charAt(e.length-1)&&(t*=.01),t)},a.get_safe_positive=function(e){var t=a.get_safe_number(e);return t<=0?null:t},a.get_safe_natural=function(e){var t=a.get_safe_number(e);return t<0||t!==Math.floor(t)?null:t},a.get_safe_number_vector=function(e){if("number"==typeof e)return[e];var t;if("string"==typeof e)t=e.split(/\s+/);else{if(!Array.isArray(e))return null;t=e.slice()}for(var r=0;r<t.length;r++)if(t[r]=a.get_safe_number(t[r]),null===t[r])throw new Error("get_safe_number_vector: invalid input");return t},a.get_safe_bool=function(e){if("boolean"==typeof e)return e;if("number"==typeof e)return 0!==e;if("string"!=typeof e)return!1;var t=e.trim().toLowerCase();return"true"===t||"yes"===t||"y"===t},a.get_safe_bool_vector=function(e){if("boolean"==typeof e)return[e];if("number"==typeof e)return[0!==e];var t;if("string"==typeof e)t=e.split(/\s+/);else{if(!Array.isArray(e))return[!1];t=e.slice()}for(var r=0;r<t.length;r++)t[r]=a.get_safe_bool(t[r]);return t},a.ndf=function(e){return Math.exp(-e*e/2)/n},a.cndf=function(e){var t,r=Math.abs(e);if(r<=37){var a=Math.exp(-r*r/2);if(r<7.07106781186547)t=a*((((((.0352624965998911*r+.700383064443688)*r+6.37396220353165)*r+33.912866078383)*r+112.079291497871)*r+221.213596169931)*r+220.206867912376)/(((((((.0883883476483184*r+1.75566716318264)*r+16.064177579207)*r+86.7807322029461)*r+296.564248779674)*r+637.333633378831)*r+793.826512519948)*r+440.413735824752);else t=a/(n*(r+1/(r+2/(r+3/(r+4/(r+.65))))))}else{if(!(37<r))throw new Error("cndf: invalid input.");t=0}return e<=0?t:1-t};a.fast_cndf=function(e){var t=Math.abs(e),r=1+t*(.049867347+t*(.0211410061+t*(.0032776263+t*(380036e-10+t*(488906e-10+5383e-9*t)))));return r*=r,r*=r,r*=r,r=.5/(r*=r),0<=e?1-r:r};var i=Math.pow(2,6);a.fast_exp=function(e){if(6<Math.abs(e))return Math.exp(e);for(var t=1+e/i,r=0;r<6;r++)t*=t;return t},a.find_root_secant=function(e,t,r,a,n){var i=t,s=r,o=0,_=a||20,l=n||1e-8,u=e(i),f=e(s);for(Math.abs(f)>Math.abs(u)&&(o=i,i=s,s=o,o=u,u=f,f=o);Math.abs(f)>l&&0<_;)o=(i-s)*f/(f-u),u=f,f=e(s=(i=s)+o),_--;if(_<=0)throw new Error("find_root_secant: failed, too many iterations");if(isNaN(s))throw new Error("find_root_secant: failed, invalid result");return s},a.find_root_ridders=function(e,t,r,a,n){var i,s,o,_=t,l=r,u=0,f=0,c=0,d=a||20,h=n||1e-8,p=e(_),m=e(l);if(0<p*m)throw new Error("find_root_ridders: start values do not bracket the root");if(Math.abs(p)<h)return _;if(Math.abs(m)<h)return l;for(;0<d;){if(d--,u=.5*(_+l),Math.abs(_-l)<1e-15)return u;if(i=e(u),Math.abs(i)<h)return u;if(0===(c=Math.sqrt(i*i-m*p)))return u;if(f=(u-_)*(0<(o=p-m)?1:o<0?-1:0)*i/c+u,isNaN(f)&&(f=u),s=e(f),Math.abs(s)<h)return f;i*s<0?(_=f,p=s,l=u,m=i):p*s<0?(l=f,m=s):m*s<0&&(_=f,p=s)}if(d<=0)throw new Error("find_root_ridders: failed, too many iterations")}}(this.JsonRisk||module.exports),function(l){"use strict";var u=function(e,t,r,a){for(var n=[e],i=1,s=l.add_months(e,r);s.getTime()<t.getTime();)n.push(s),i++,s=l.add_months(e,i*r);return a(t).getTime()<=a(n[n.length-1]).getTime()&&n.pop(),n},f=function(e,t,r,a){for(var n=[t],i=1,s=l.add_months(t,-r);s.getTime()>e.getTime();)n.unshift(s),i++,s=l.add_months(t,-i*r);return a(e).getTime()>=a(n[0]).getTime()&&n.shift(),n};l.schedule=function(e,t,r,a,n,i,s,o){if(!(t instanceof Date))throw new Error("schedule: maturity must be provided");if(!(e instanceof Date)){if(null===l.valuation_date)throw new Error("schedule: if valuation_date is unset, effective date must be provided");if(n instanceof Date)throw new Error("schedule: if first date is provided, effective date must be provided");if(!(i instanceof Date)&&s)throw new Error("schedule: if next to last date is not provided and stub in the end is specified, effective date must be provided")}if(e instanceof Date&&t<e||l.valuation_date instanceof Date&&t<l.valuation_date)throw new Error("schedule: maturity is before valuation date or effective date.");if("number"!=typeof r)throw new Error("schedule: tenor must be a nonnegative integer, e.g., 6 for semiannual schedule, 0 for zerobond/iam schedule");if(r<0||Math.floor(r)!==r)throw new Error("schedule: tenor must be a nonnegative integer, e.g., 6 for semiannual schedule, 0 for zerobond/iam schedule");return 0===r?[e instanceof Date?e:l.valuation_date,t]:(n instanceof Date&&!(i instanceof Date)?((_=u(n,t,r,a)).push(t),e.getTime()!==n.getTime()&&_.unshift(e)):i instanceof Date&&!(n instanceof Date)?(_=f(e instanceof Date?e:l.valuation_date,i,r,a),t.getTime()!==i.getTime()&&_.push(t),e instanceof Date&&_.unshift(e),e instanceof Date||_.unshift(l.add_months(_[0],-r))):n instanceof Date&&i instanceof Date?(_=f(n,i,r,a),t.getTime()!==i.getTime()&&_.push(t),_.unshift(n),_.unshift(e)):s?(_=u(e,t,r,a),o&&1<_.length&&_.pop(),_.push(t)):(_=f(e instanceof Date?e:l.valuation_date,t,r,a),o&&1<_.length&&_.shift(),e instanceof Date&&_.unshift(e),e instanceof Date||_.unshift(l.add_months(_[0],-r))),_);var _}}(this.JsonRisk||module.exports),function(i){function s(e,t){if(e.terms)return e.terms[t];if(e.labels_term)return i.period_str_to_time(e.labels_term[t]);throw new Error("get_term_at: invalid surface, cannot derive terms")}function o(e,t){if(e.expiries)return e.expiries[t];if(e.labels_expiry)return i.period_str_to_time(e.labels_expiry[t]);throw new Error("get_expiry_at: invalid surface, cannot derive expiries")}function _(e,t,r,a,n){a=a||0,n=n||(e.terms||e.labels_term||[]).length-1;var i=e.values[t];if(!Array.isArray(i))throw new Error("get_slice_rate: invalid surface, values property must be an array of arrays");return a===n?i[a]:r<s(e,a)?i[a]:r>s(e,n)?i[n]:a+1===n?i[a]*(s(e,n)-r)/(s(e,n)-s(e,a))+i[n]*(r-s(e,a))/(s(e,n)-s(e,a)):(imed=Math.ceil((a+n)/2),r>s(e,imed)?_(e,t,r,imed,n):_(e,t,r,a,imed))}i.get_const_surface=function(e,t){if("number"!=typeof e)throw new Error("get_const_surface: input must be number.");return{type:t||"",expiries:[1],terms:[1],values:[[e]]}},i.get_safe_surface=function(e){return e?{type:e.type||"",expiries:function(e){var t=(e.expiries||e.labels_expiry||[]).length;if(!t)throw new Error("get_surface_terms: invalid surface, need to provide valid expiries or labels_expiry");for(var r=new Array(t);0<t;)r[--t]=o(e,t);return r}(e),terms:function(e){var t=(e.terms||e.labels_term||[]).length;if(!t)throw new Error("get_surface_terms: invalid surface, need to provide valid terms or labels_term");for(var r=new Array(t);0<t;)r[--t]=s(e,t);return r}(e),values:e.values}:i.get_const_surface(0)},i.get_surface_rate=function(e,t,r,a,n){return(a=a||0)===(n=n||(e.expiries||e.labels_expiry||[]).length-1)?_(e,a,r):t<o(e,a)?_(e,a,r):t>o(e,n)?_(e,n,r):a+1===n?_(e,a,r)*(o(e,n)-t)/(o(e,n)-o(e,a))+_(e,n,r)*(t-o(e,a))/(o(e,n)-o(e,a)):(imed=Math.ceil((a+n)/2),t>o(e,imed)?i.get_surface_rate(e,t,r,imed,n):i.get_surface_rate(e,t,r,a,imed))}}(this.JsonRisk||module.exports),function(i){function s(e,t){if(e.terms)return e.terms[t];if(e.labels_term)return i.period_str_to_time(e.labels_term[t]);throw new Error("get_term_at: invalid surface, cannot derive terms")}function o(e,t){if(e.expiries)return e.expiries[t];if(e.labels_expiry)return i.period_str_to_time(e.labels_expiry[t]);throw new Error("get_expiry_at: invalid surface, cannot derive expiries")}function _(e,t,r,a,n){a=a||0,n=n||(e.terms||e.labels_term||[]).length-1;var i=e.values[t];if(!Array.isArray(i))throw new Error("get_slice_rate: invalid surface, values property must be an array of arrays");return a===n?i[a]:r<s(e,a)?i[a]:r>s(e,n)?i[n]:a+1===n?i[a]*(s(e,n)-r)/(s(e,n)-s(e,a))+i[n]*(r-s(e,a))/(s(e,n)-s(e,a)):(imed=Math.ceil((a+n)/2),r>s(e,imed)?_(e,t,r,imed,n):_(e,t,r,a,imed))}i.get_const_surface=function(e,t){if("number"!=typeof e)throw new Error("get_const_surface: input must be number.");return{type:t||"",expiries:[1],terms:[1],values:[[e]]}},i.get_safe_surface=function(e){return e?{type:e.type||"",expiries:function(e){var t=(e.expiries||e.labels_expiry||[]).length;if(!t)throw new Error("get_surface_terms: invalid surface, need to provide valid expiries or labels_expiry");for(var r=new Array(t);0<t;)r[--t]=o(e,t);return r}(e),terms:function(e){var t=(e.terms||e.labels_term||[]).length;if(!t)throw new Error("get_surface_terms: invalid surface, need to provide valid terms or labels_term");for(var r=new Array(t);0<t;)r[--t]=s(e,t);return r}(e),values:e.values}:i.get_const_surface(0)},i.get_surface_rate=function(e,t,r,a,n){return(a=a||0)===(n=n||(e.expiries||e.labels_expiry||[]).length-1)?_(e,a,r):t<o(e,a)?_(e,a,r):t>o(e,n)?_(e,n,r):a+1===n?_(e,a,r)*(o(e,n)-t)/(o(e,n)-o(e,a))+_(e,n,r)*(t-o(e,a))/(o(e,n)-o(e,a)):(imed=Math.ceil((a+n)/2),t>o(e,imed)?i.get_surface_rate(e,t,r,imed,n):i.get_surface_rate(e,t,r,a,imed))}}(this.JsonRisk||module.exports),function(a){a.swap=function(e){this.phi=e.is_payer?-1:1,this.fixed_rate=e.fixed_rate,this.fixed_leg=new a.fixed_income({notional:e.notional*this.phi,notional_exchange:!1,maturity:e.maturity,fixed_rate:e.fixed_rate,tenor:e.tenor,effective_date:e.effective_date,calendar:e.calendar,bdc:e.bdc,dcc:e.dcc}),this.float_leg=new a.fixed_income({notional:-e.notional*this.phi,notional_exchange:!1,maturity:e.maturity,float_spread:e.float_spread,tenor:e.float_tenor,effective_date:e.effective_date,calendar:e.calendar,bdc:e.float_bdc,dcc:e.float_dcc,float_current_rate:e.float_current_rate})},a.swap.prototype.fair_rate=function(e,t){var r=this.float_leg.present_value(e,null,t);return-this.phi*r/this.annuity(e)},a.swap.prototype.annuity=function(e){return this.fixed_leg.annuity(e)*this.phi},a.swap.prototype.present_value=function(e,t){var r=0;return r+=this.fixed_leg.present_value(e,null,null),r+=this.float_leg.present_value(e,null,t)},a.swap.prototype.get_cash_flows=function(e){return{fixed_leg:this.fixed_leg.get_cash_flows(),float_leg:this.float_leg.get_cash_flows(e)}},a.pricer_swap=function(e,t,r){return new a.swap(e).present_value(t,r)}}(this.JsonRisk||module.exports),function(b){b.swaption=function(e){if(this.sign=e.is_short?-1:1,this.maturity=b.get_safe_date(e.maturity),!this.maturity)throw new Error("swaption: must provide valid maturity date.");if(this.first_exercise_date=b.get_safe_date(e.first_exercise_date),!this.first_exercise_date)throw new Error("swaption: must provide valid first_exercise_date date.");this.swap=new b.swap({is_payer:e.is_payer,notional:e.notional,effective_date:this.first_exercise_date,maturity:e.maturity,fixed_rate:e.fixed_rate,tenor:e.tenor,calendar:e.calendar,bdc:e.bdc,dcc:e.dcc,float_spread:e.float_spread,float_tenor:e.float_tenor,float_bdc:e.float_bdc,float_dcc:e.float_dcc,float_current_rate:e.float_current_rate})},b.swaption.prototype.present_value=function(e,t,r){b.require_vd();var a=b.time_from_now(this.maturity),n=b.time_from_now(this.first_exercise_date),i=a-n;if(i<1/512)return 0;var s=this.swap.fair_rate(e,t);if("object"!=typeof r||null===r)throw new Error("swaption.present_value: must provide valid surface");var o,_=b.get_surface_rate(r,n,i)*Math.sqrt(n);if(n<0)return 0;if(n<1/512||_<1e-4)o=Math.max(this.swap.phi*(this.swap.fixed_rate-s),0);else{var l=(this.swap.fixed_rate-s)/_;o=this.swap.phi*(this.swap.fixed_rate-s)*b.cndf(this.swap.phi*l)+_*b.ndf(l)}return o*=this.swap.annuity(e),o*=this.sign},b.pricer_swaption=function(e,t,r,a){return new b.swaption(e).present_value(t,r,a)},b.create_equivalent_regular_swaption=function(e,t,r){if(void 0===e.date_pmt||void 0===e.pmt_total||void 0===e.current_principal)throw new Error("create_equivalent_regular_swaption: invalid cashflow object");if(e.t_pmt.length!==e.pmt_total.length||e.t_pmt.length!==e.current_principal.length)throw new Error("create_equivalent_regular_swaption: invalid cashflow object");b.require_vd(),r||(r={});for(var a,n=r.tenor||6,i=r.bdc||"unadjusted",s=r.calendar||"",o=0;e.date_pmt[o]<=t;)o++;if(0===(a=e.current_principal[o]))throw new Error("create_equivalent_regular_swaption: invalid cashflow object or first_exercise_date, zero outstanding principal");var _=b.irr(e,t,-a);_=12/n*(Math.pow(1+_,n/12)-1);var l=b.time_from_now(t),u=b.get_const_curve(_+1e-4),f=b.get_const_curve(_-1e-4),c=b.dcf(e,u,null,null,t);c/=b.get_df(u,l);for(var d=b.dcf(e,f,null,null,t),h=1e4*((d/=b.get_df(f,l))-c)/(d+c),p=function(e){var t=new b.fixed_income(e);return c=t.present_value(u),c/=b.get_df(u,l),d=t.present_value(f),1e4*((d/=b.get_df(f,l))-c)/(d+c)},m=Math.abs(_)<1e-8?h:-Math.log(1-h*_)/_,g=b.add_days(t,Math.round(365*m)),v={maturity:g,effective_date:t,settlement_date:b.adjust(t,i,b.is_holiday_factory(s)),notional:a,fixed_rate:_,tenor:n,calendar:s,bdc:i},w=p(v),y=10;Math.abs(w-h)>1/512&&0<y;)m=m*h/w,g=b.add_days(t,Math.round(365*m)),v.maturity=g,w=p(v),y--;return{is_payer:!1,maturity:g,first_exercise_date:t,effective_date:t,settlement_date:t,notional:a,fixed_rate:_,tenor:n,float_spread:0,float_tenor:r.float_tenor||6,float_current_rate:0,calendar:s,bdc:i,float_bdc:i}}}(this.JsonRisk||module.exports),function(_){"use strict";var l=1/864e5;function i(e){return e%4==0&&(2e3===e||e%100!=0)}function s(e,t){return new Date(e,t+1,0).getDate()}function o(e,t){return Math.round((t-e)*l)}function r(e,t){return o(e,t)/365}function a(e,t){return o(e,t)/360}function n(e,t){return(360*(t.getFullYear()-e.getFullYear())+30*(t.getMonth()-e.getMonth())+(Math.min(t.getDate(),30)-Math.min(e.getDate(),30)))/360}function u(e,t){if(e-t==0)return 0;if(t<e)return-u(t,e);var r=e.getFullYear(),a=t.getFullYear();if(r===a)return o(e,t)/(i(r)?366:365);var n=a-r-1;return n+=o(e,new Date(r+1,0,1))/(i(r)?366:365),n+=o(new Date(a,0,1),t)/(i(a)?366:365)}function f(e){var t=e.getDay();return 0===t||6===t}function c(e){if(f(e))return!0;var t=e.getDate(),r=e.getMonth();if(1===t&&0===r)return!0;if(25===t&&11===r)return!0;var a=e.getFullYear();if((1998===a||1999===a||2001===a)&&31===t&&11===r)return!0;if(2e3<a){if(1===t&&4===r||26===t&&11===r)return!0;var n=function(e){var t=Math.floor,r=t(e/100),a=e-19*t(e/19),n=t((r-17)/25),i=r-t(r/4)-t((r-n)/3)+19*a+15;i-=30*t(i/30),i-=t(i/28)*(1-t(i/28)*t(29/(i+1))*t((21-a)/11));var s=e+t(e/4)+i+2-r+t(r/4),o=i-(s-=7*t(s/7)),_=3+t((o+40)/44),l=o+28-31*t(_/4);return new Date(e,_-1,l)}(a);if(e.getTime()===_.add_days(n,-2).getTime())return!0;if(e.getTime()===_.add_days(n,1).getTime())return!0}return!1}_.period_str_to_time=function(e){var t=parseInt(e,10);if(isNaN(t))throw new Error("period_str_to_time(str) - Invalid time period string: "+e);var r=e.charAt(e.length-1);if("Y"===r||"y"===r)return t;if("M"===r||"m"===r)return t/12;if("W"===r||"w"===r)return t/52;if("D"===r||"d"===r)return t/365;throw new Error("period_str_to_time(str) - Invalid time period string: "+e)},_.date_str_to_date=function(e){var t,r,a,n=null;if(null!==(n=/^([1-2][0-9]{3})[\/-]([0-9]{1,2})[\/-]([0-9]{1,2})/.exec(e))?(a=parseInt(n[1],10),r=parseInt(n[2],10)-1,t=parseInt(n[3],10)):null!==(n=/^([0-9]{1,2})\.([0-9]{1,2})\.([1-2][0-9]{3})/.exec(e))&&(a=parseInt(n[3],10),r=parseInt(n[2],10)-1,t=parseInt(n[1],10)),null===n)throw new Error("date_str_to_time(str) - Invalid date string: "+e);if(r<0||11<r)throw new Error("date_str_to_time(str) - Invalid month in date string: "+e);if(t<0||t>s(a,r))throw new Error("date_str_to_time(str) - Invalid day in date string: "+e);return new Date(a,r,t)},_.get_safe_date=function(e){if(!e)return null;if(e instanceof Date)return e;if(e instanceof String||"string"==typeof e)return _.date_str_to_date(e);throw new Error("get_safe_date: invalid input.")},_.get_safe_date_vector=function(e){if(e instanceof Date)return[e];var t;if("string"==typeof e)t=e.split(/\s+/);else{if(!Array.isArray(e))return null;t=e.slice()}for(var r=0;r<t.length;r++)if(t[r]=_.get_safe_date(t[r]),null===t[r])throw new Error("get_safe_date_vector: invalid input");return t},_.year_fraction_factory=function(e){if(!(e instanceof String)&&"string"!=typeof e)return r;var t=e.toLowerCase();if("a"===t.charAt(0)){if("actual/365"===t||"act/365"===t||"a/365"===t||"act/365 (fixed)"===t||"actual/365 (fixed)"===t)return r;if("act/360"===t||"a/360"===t)return a;if("act/act"===t||"a/a"===t)return u}return"3"===t.charAt(0)&&"30e/360"===t?n:r},_.time_from_now=function(e){return _.require_vd(),r(_.valuation_date,e)},_.add_days=function(e,t){return new Date(e.getFullYear(),e.getMonth(),e.getDate()+t)},_.add_months=function(e,t,r){for(var a,n=e.getFullYear(),i=e.getMonth()+t;12<=i;)i-=12,n+=1;for(;i<0;)i+=12,n-=1;return a=r||e.getDate(),new Date(n,i,Math.min(a,s(n,i)))},_.add_period=function(e,t){var r=parseInt(t,10);if(isNaN(r))throw new Error("period_str_to_time(str) - Invalid time period string: "+t);var a=t.charAt(t.length-1);if("Y"===a||"y"===a)return _.add_months(e,12*r);if("M"===a||"m"===a)return _.add_months(e,r);if("W"===a||"w"===a)return _.add_days(e,7*r);if("D"===a||"d"===a)return _.add_days(e,r);throw new Error("period_str_to_time(str) - Invalid time period string: "+t)};var d={};_.add_calendar=function(e,t){if(!(e instanceof String||"string"==typeof e))throw new Error("add_calendar: invalid input.");if(!Array.isArray(t))throw new Error("add_calendar: invalid input.");var r,a,n,i=t.length,s=[];for(r=0;r<i;r++)(n=_.get_safe_date(t[r]))&&(f(n)||s.push(n));for(i=s.length,r=1;r<41&&!(i/10<=(a=r*r-r+41));)r++;var o=new Array(a);for(r=0;r<a;r++)o[r]=[];for(r=0;r<i;r++)o[Math.floor(s[r].getTime()*l)%a].push(s[r].getTime());return d[e.toLowerCase()]=o,a},_.is_holiday_factory=function(e){var t=e.toLowerCase();if("target"===t)return c;if(Array.isArray(d[t])){var n=d[t];return function(e){if(f(e))return!0;for(var t=e.getTime(),r=Math.floor(t*l)%n.length,a=0;a<n[r].length;a++)if(t===n[r][a])return!0;return!1}}return f},_.adjust=function(e,t,r){var a,n=(t||"u").charAt(0).toLowerCase(),i=new Date(e);if("u"===n)return i;if("m"===n&&(a=i.getMonth()),"m"===n||"f"===n)for(;r(i);)i=_.add_days(i,1);if("f"===n)return i;if("m"===n&&a===i.getMonth())return i;for("m"===n&&(i=_.add_days(i,-1));r(i);)i=_.add_days(i,-1);return i},_.add_business_days=function(e,t,r){for(var a=e,n=t;0<n;)a=_.adjust(_.add_days(a,1),"f",r),n--;return a}}(this.JsonRisk||module.exports),function(p){var m=null,_=function(e){var t=p.get_curve_times(e),r=e.dfs?Array.isArray(e.dfs[0])?e.dfs:[e.dfs]:null,a=e.zcs?Array.isArray(e.zcs[0])?e.zcs:[e.zcs]:null;if(!r){r=new Array(a.length);for(var n=0;n<a.length;n++){r[n]=new Array(a[n].length);for(var i=0;i<a[n].length;i++)r[n][i]=Math.pow(1+a[n][i],-t[i])}}return{times:t,dfs:r}},l=function(e){if(1!==e)if(1!==m.vector_length){if(e!==m.vector_length)throw new Error("vector_pricing: provided parameters need to have the same length or length one")}else m.vector_length=e};p.store_params=function(e){var t,r,a,n,i,s,o;if((m={vector_length:1,scalars:{},curves:{},surfaces:{}}).valuation_date=p.get_safe_date(e.valuation_date),"object"==typeof e.scalars)for(t=Object.keys(e.scalars),r=0;r<t.length;r++)m.scalars[t[r]]=(a=e.scalars[t[r]],Array.isArray(a.value)?{value:a.value}:{value:[a.value]}),l(m.scalars[t[r]].value.length);if("object"==typeof e.curves)for(t=Object.keys(e.curves),r=0;r<t.length;r++)n=_(e.curves[t[r]]),i=(m.curves[t[r]]=n).dfs?n.dfs.length:n.zcs.length,l(i);if("object"==typeof e.surfaces)for(t=Object.keys(e.surfaces),r=0;r<t.length;r++)m.surfaces[t[r]]=(s=e.surfaces[t[r]],void 0,{expiries:(o=p.get_safe_surface(s)).expiries,terms:o.terms,values:Array.isArray(s.values[0][0])?s.values:[s.values]}),l(m.surfaces[t[r]].values.length)},p.get_params=function(){return m},p.set_params=function(e){if("object"!=typeof e)throw new Error("vector_pricing: try to hard set invalid parameters. Use store_params to normalize and store params.");if("number"!=typeof e.vector_length)throw new Error("vector_pricing: try to hard set invalid parameters. Use store_params to normalize and store params.");m=e};var g=function(e,t){return e?{times:e.times,dfs:e.dfs?e.dfs[1<e.dfs.length?t:0]:null}:null};p.get_internal_object=function(e){switch(e.type.toLowerCase()){case"bond":case"floater":return new p.fixed_income(e);case"swap":return new p.swap(e);case"swaption":return new p.swaption(e);case"fxterm":return new p.fxterm(e);case"callable_bond":return new p.callable_fixed_income(e);default:throw new Error("get_internal_object: invalid instrument type")}},p.vector_pricer=function(e){if("string"!=typeof e.type)throw new Error("vector_pricer: instrument object must contain valid type");p.valuation_date=m.valuation_date;for(var t,r,a,n,i,s,o=p.get_internal_object(e),_=m.curves[e.disc_curve||""]||null,l=m.curves[e.spread_curve||""]||null,u=m.curves[e.fwd_curve||""]||null,f=m.surfaces[e.surface||""]||null,c=m.scalars[e.currency||""]||null,d=new Array(m.vector_length),h=0;h<m.vector_length;h++){switch(t=g(_,h),r=g(l,h),a=g(u,h),s=h,n=(i=f)?{expiries:i.expiries,terms:i.terms,values:i.values[1<i.values.length?s:0]}:null,e.type.toLowerCase()){case"bond":case"floater":case"fxterm":case"irregular_bond":d[h]=o.present_value(t,r,a);break;case"swap":case"swaption":d[h]=o.present_value(t,a,n);break;case"callable_bond":d[h]=o.present_value(t,r,a,n)}if(e.currency&&"EUR"!==e.currency){if(!c)throw new Error("vector_pricer: cannot convert currency, scalar parameter not provided");d[h]/=c.value[1<c.value.length?h:0]}}return d}}(this.JsonRisk||module.exports);