/*! json_risk 12-11-2018 */

!function(e,t){"object"==typeof module&&"undefined"!=typeof exports?module.exports=t():e.JsonRisk=t()}(this,function(){var e={valuation_date:null,pricer:function(e,t){return null}};return e}),function(e){e.get_const_curve=function(e){if("number"!=typeof e)throw new Error("get_const_curve: input must be number.");if(e<=-1)throw new Error("get_const_curve: invalid input.");return{type:"yield",times:[1],dfs:[1/(1+e)]}},e.get_initialised_curve=function(t){if(!t)return e.get_const_curve(0);var r,n=function(t){var r,n;{if(void 0===t.times){if(void 0!==t.days)for(r=t.days.length,n=new Array(r);r>0;)n[--r]=t.days[r]/365;else if(void 0!==t.dates)for(r=t.dates.length,n=new Array(r),yf=e.year_fraction_factory("act/365"),ref_date=e.date_str_to_date(t.dates[0]);r>0;)n[--r]=yf(ref_date,e.date_str_to_date(t.dates[r]));else{if(void 0===t.labels)throw new Error("init_curve: invalid curve, cannot derive times");for(r=t.labels.length,n=new Array(r);r>0;)n[--r]=e.period_str_to_time(t.labels[r])}return n}for(r=t.times.length;r>0;)if(r--,"number"!=typeof t.times[r])throw new Error("get_curve_times: invalid vector of times, must be numeric");return t.times}}(t);if(void 0!==t.dfs)r=t.dfs;else{if(void 0===t.zcs)throw new Error("get_initialised_curve: invalid curve, both dfs and zcs undefined");r=function(e,t){var r,n;if(r=e.length,t.length!==r)throw new Error("get_dfs: invalid input, length of zcs does not match length of times");n=new Array(r);for(;r>0;){if("number"!=typeof e[--r])throw new Error("get_curve_times: invalid vector of times, must be numeric");n[r]=Math.pow(1+e[r],-t[r])}return n}(t.zcs,n)}return{type:"yield",times:n,dfs:r}},get_df_internal=function(e,t,r,n){if(t<1/512)return 1;if(r==n)return t===e.times[r]?e.dfs[r]:Math.pow(e.dfs[r],t/e.times[r]);if(t<e.times[r])return Math.pow(e.dfs[r],t/e.times[r]);if(t>e.times[n])return Math.pow(e.dfs[n],t/e.times[n]);if(r+1==n){if(e.times[n]-e.times[r]<1/512)throw new Error("get_df_internal: invalid curve, support points must be increasing and differ at least one day");return e.dfs[r]*(e.times[n]-t)/(e.times[n]-e.times[r])+e.dfs[n]*(t-e.times[r])/(e.times[n]-e.times[r])}return imed=Math.ceil((r+n)/2),t>e.times[imed]?get_df_internal(e,t,imed,n):get_df_internal(e,t,r,imed)},e.get_df=function(t,r){var n=e.get_initialised_curve(t);return get_df_internal(n,r,0,n.times.length-1)},e.get_rate=function(t,r){return r<1/512?0:Math.pow(e.get_df(t,r),-1/r)-1},e.get_fwd_rate=function(t,r,n){if(n-r<1/512)return 0;var i=e.get_initialised_curve(t);return Math.pow(e.get_df(i,n)/e.get_df(i,r),-1/(n-r))-1}}(this.JsonRisk||module.exports),function(e){e.fix_cash_flows=function(t,r,n,i,a,o){if(null===e.valuation_date)throw new Error("fix_cash_flows: valuation_date must be set");var s,f,d=new Array(t.length-1),u=new Array(t.length-1),l=new Array(t.length),_=new Array(t.length-1),c=e.year_fraction_factory(null);for(l[0]=c(e.valuation_date,t[0]),s=1;s<t.length;s++)d[s-1]=(f=t[s],e.adjust(f,r,n)),u[s-1]=c(e.valuation_date,d[s-1]),l[s]=c(e.valuation_date,t[s]),_[s-1]=a*o*i(t[s-1],t[s]);return _[_.length-1]+=a,{schedule:t,times_schedule:l,dates:d,amounts:_,times:u}},e.dcf=function(t,r,n,i,a){if(null===e.valuation_date)throw new Error("dcf: valuation_date must be set");var o=e.get_initialised_curve(r),s=e.get_initialised_curve(n);"number"!=typeof i&&(i=0);var f=e.get_initialised_date(a);if(f||(f=e.valuation_date),void 0===t.times||void 0===t.amounts)throw new Error("dcf: invalid cashflow object");if(t.times.length!==t.amounts.length)throw new Error("dcf: invalid cashflow object");for(var d,u,l,_=0,c=0;t.dates[c]<=f;)c++;for(;c<t.times.length;)d=e.get_df(o,t.times[c]),u=e.get_df(s,t.times[c]),l=Math.exp(-t.times[c]*i),_+=t.amounts[c]*d*u*l,c++;return _},e.fixed_income=function(t){var r=e.get_initialised_date(t.maturity);if(!r)throw new Error("fixed_income: must provide maturity date.");if("number"!=typeof t.notional)throw new Error("fixed_income: must provide valid notional.");if(this.notional=t.notional,"number"!=typeof t.tenor)throw new Error("fixed_income: must provide valid tenor.");if(t.tenor<0||t.tenor!==Math.floor(t.tenor))throw new Error("fixed_income: must provide valid tenor.");var n=t.tenor;this.type="string"==typeof t.type?t.type:"unknown",this.is_holiday_func=e.is_holiday_factory(t.calendar||""),this.year_fraction_func=e.year_fraction_factory(t.dcc||""),this.bdc=t.bdc||"";var i=e.get_initialised_date(t.effective_date),a=e.get_initialised_date(t.first_date),o=e.get_initialised_date(t.next_to_last_date),s="number"==typeof t.settlement_days?t.settlement_days:0;this.settlement_date=e.adjust(e.add_days(e.valuation_date,s),"following",this.is_holiday_func);"number"==typeof t.residual_spread&&t.residual_spread,t.currency;if("number"==typeof t.fixed_rate)this.is_float=!1,this.fixed_rate=t.fixed_rate;else{if(this.is_float=!0,this.float_spread="number"==typeof t.float_spread?t.float_spread:0,"number"!=typeof t.current_rate)throw new Error("fixed_income: must provide valid current_rate.");this.current_rate=t.current_rate}this.schedule=e.backward_schedule(i,r,n,this.is_holiday_func,this.bdc,a,o),this.cash_flows=e.fix_cash_flows(this.schedule,this.bdc,this.is_holiday_func,this.year_fraction_func,this.notional,this.fixed_rate)},e.fixed_income.prototype.get_cash_flows=function(t){if(!this.is_float)return this.cash_flows;var r,n,i=new Array(this.cash_flows.schedule.length-1);for(i[0]=this.notional*this.current_rate*this.year_fraction_func(this.cash_flows.schedule[0],this.cash_flows.schedule[1]),r=2;r<this.cash_flows.schedule.length;r++)n=e.get_fwd_rate(t,this.cash_flows.times_schedule[r-1],this.cash_flows.times_schedule[r])+this.float_spread,i[r-1]=this.notional*n*this.year_fraction_func(this.cash_flows.schedule[r-1],this.cash_flows.schedule[r]);return i[i.length-1]+=this.notional,{schedule:this.cash_flows.schedule,times_schedule:this.cash_flows.times_schedule,dates:this.cash_flows.dates,amounts:i,times:this.cash_flows.times}},e.fixed_income.prototype.present_value=function(t,r,n){return e.dcf(this.get_cash_flows(n||null),t,r,this.residual_spread,this.settlement_date)},e.pricer_bond=function(t,r,n){return new e.fixed_income(t).present_value(r,n,null)},e.pricer_floater=function(t,r,n,i){return new e.fixed_income(t).present_value(r,n,i)},e.pricer_swap=function(t,r,n){var i=t.payer?-1:1,a=new e.fixed_income({notional:t.notional*i,maturity:t.maturity,fixed_rate:t.fixed_rate,tenor:t.fixed_tenor,effective_date:t.effective_date,calendar:t.calendar,bdc:t.fixed_bdc,dcc:t.fixed_dcc}),o=new e.fixed_income({notional:-t.notional*i,maturity:t.maturity,float_spread:t.float_spread,tenor:t.float_tenor,effective_date:t.effective_date,calendar:t.calendar,bdc:t.float_bdc,dcc:t.float_dcc,current_rate:t.float_current_rate});return a.present_value(r,null,n)+o.present_value(r,null,n)},e.pricer_fxterm=function(t,r){var n=new e.fixed_income({notional:t.notional,maturity:t.maturity,fixed_rate:0,tenor:0}).present_value(r,null,null);return"number"!=typeof t.notional_2?n:n+new e.fixed_income({notional:t.notional_2,maturity:t.maturity_2,fixed_rate:0,tenor:0}).present_value(r,null,null)}}(this.JsonRisk||module.exports),function(e){e.backward_schedule=function(t,r,n,i,a,o,s){if(!(r instanceof Date))throw new Error("backward_schedule: maturity must be provided");if(!(t instanceof Date)){if(null===e.valuation_date)throw new Error("backward_schedule: if valuation_date is unset, effective date must be provided");if(o instanceof Date)throw new Error("backward_schedule: if first date is provided, effective date must be provided")}if(t instanceof Date&&r<t||e.valuation_date instanceof Date&&r<e.valuation_date)throw new Error("backward_schedule: maturity is before valution or effective date.");if("number"!=typeof n)throw new Error("backward_schedule: tenor must be a nonnegative integer, e.g., 6 for semiannual schedule, 0 for zerobond/iam schedule");if(n<0||Math.floor(n)!==n)throw new Error("backward_schedule: tenor must be a nonnegative integer, e.g., 6 for semiannual schedule, 0 for zerobond/iam schedule");if(0===n)return[t,r];var f=function(t){return e.adjust(t,a,i)},d=[r],u=r;s instanceof Date&&f(s)<f(r)&&(d.unshift(s),u=s);for(var l,_=0;;){if(_++,l=e.add_months(u,-n*_),o instanceof Date&&l<o)return f(d[0]).getTime()!==f(o).getTime()&&d.unshift(o),f(d[0]).getTime()!==f(t).getTime()&&d.unshift(t),d;if(t instanceof Date&&l<t)return f(d[0]).getTime()!=f(t).getTime()&&d.unshift(t),d;if(e.valuation_date instanceof Date&&l<e.valuation_date)return d.unshift(l),f(l)>e.valuation_date&&(_++,l=e.add_months(u,-n*_),o instanceof Date&&l<o?d.unshift(o):t instanceof Date&&l<t?d.unshift(t):d.unshift(l)),d;d.unshift(l)}}}(this.JsonRisk||module.exports),function(e){var t=1/864e5;function r(e){return e%4==0&&(2e3===e||e%100!=0)}function n(e,t){return 1===t?r(e)?29:28:3===t||5===t||8===t||10===t?30:31}function i(e,r){return(r-e)*t}function a(e,t){return i(e,t)/365}function o(e,t){return i(e,t)/360}function s(e,t){return(360*(t.getFullYear()-e.getFullYear())+30*(t.getMonth()-e.getMonth())+(Math.min(t.getDate(),30)-Math.min(e.getDate(),30)))/360}function f(e,t){if(e-t==0)return 0;if(e>t)return-f(t,e);var n=e.getFullYear(),a=t.getFullYear();if(n===a)return i(t,e)/(r(n)?366:365);var o=a-n-1;return o+=i(e,new Date(n+1,0,1))/(r(n)?366:365),o+=i(new Date(a,0,1),t)/(r(a)?366:365)}function u(e){return d=e.getDay(),0===d||6===d}function l(t){var r=t.getDay();if(0===r)return!0;if(6===r)return!0;var n=t.getDate(),i=t.getMonth();if(1===n&&0===i)return!0;if(25===n&&11===i)return!0;var a=t.getFullYear();if((1998===a||1999===a||2001===a)&&31===n&&11===i)return!0;if(a>2e3){if(1===n&&4===i||26===n&&11===i)return!0;var o=function(e){var t=Math.floor,r=t(e/100),n=e-19*t(e/19),i=t((r-17)/25),a=r-t(r/4)-t((r-i)/3)+19*n+15;a-=30*t(a/30),a-=t(a/28)*(1-t(a/28)*t(29/(a+1))*t((21-n)/11));var o=e+t(e/4)+a+2-r+t(r/4),s=a-(o-=7*t(o/7)),f=3+t((s+40)/44),d=s+28-31*t(f/4);return new Date(e,f-1,d)}(a);if(t.getTime()===e.add_days(o,-2).getTime())return!0;if(t.getTime()===e.add_days(o,1).getTime())return!0}return!1}e.period_str_to_time=function(e){var t=parseInt(e),r=e.charAt(e.length-1);if("Y"===r||"y"===r)return t;if("M"===r||"m"===r)return t/12;if("W"===r||"w"===r)return t/52;if("D"===r||"d"===r)return t/365;throw new Error("period_str_to_time(str) - Invalid time period string: "+e)},e.date_str_to_date=function(e){var t,r,i,a=null;if(null!==(a=/^([1-2][0-9]{3})[\/-]([0-9]{1,2})[\/-]([0-9]{1,2})/.exec(e))?(i=parseInt(a[1]),r=parseInt(a[2])-1,t=parseInt(a[3])):null!==(a=/^([0-9]{1,2})\.([0-9]{1,2})\.([1-2][0-9]{3})/.exec(e))&&(i=parseInt(a[3]),r=parseInt(a[2])-1,t=parseInt(a[1])),null===a)throw new Error("date_str_to_time(str) - Invalid date string: "+e);if(r<0||r>11)throw new Error("date_str_to_time(str) - Invalid month in date string: "+e);if(t<0||t>n(i,r))throw new Error("date_str_to_time(str) - Invalid day in date string: "+e);return new Date(i,r,t)},e.get_initialised_date=function(t){if(!t)return null;if(t instanceof Date)return t;if(t instanceof String||"string"==typeof t)return e.date_str_to_date(t);throw new Error("get_initialised_date: invalid input.")},e.year_fraction_factory=function(e){if(!(e instanceof String)&&"string"!=typeof e)return a;var t=e.toLowerCase();if("a"===t.charAt(0)){if("actual/365"===t||"act/365"===t||"a/365"===t||"act/365 (fixed)"===t||"actual/365 (fixed)"===t)return a;if("act/360"===t||"a/360"===t)return o;if("act/act"===t||"a/a"===t)return f}return"3"===t.charAt(0)&&"30e/360"===t?s:a},e.add_days=function(e,t){return new Date(e.valueOf()+864e5*t)},e.add_months=function(e,t,r){for(y=e.getFullYear(),m=e.getMonth()+t;m>=12;)m-=12,y+=1;for(;m<0;)m+=12,y-=1;return d=void 0===r?e.getDate():r,new Date(y,m,Math.min(d,n(y,m)))},e.is_holiday_factory=function(e){return"target"===e.toLowerCase()?l:u},e.adjust=function(t,r,n){var i,a=(r||"u").charAt(0).toLowerCase(),o=new Date(t);if("u"===a)return o;if("m"===a&&(i=o.getMonth()),"m"===a||"f"===a)for(;n(o);)o=e.add_days(o,1);if("f"===a)return o;if("m"===a&&i===o.getMonth())return o;for("m"===a&&(o=e.add_days(o,-1));n(o);)o=e.add_days(o,-1);return o}}(this.JsonRisk||module.exports);