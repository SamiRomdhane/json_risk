/*! json_risk 28-10-2018 */

!function(t,e){"object"==typeof module&&"undefined"!=typeof exports?module.exports=e():t.JsonRisk=e()}(this,function(){var t={valuation_date:null,pricer:function(t,e){return null}};return t}),function(t){t.pricer_bond=function(e,r,i){return new t.fixed_income(e).present_value(r,i,null)}}(this.JsonRisk||module.exports),function(t){t.get_const_curve=function(t){if("number"!=typeof t)throw new Error("get_const_curve: input must be number.");if(t<=-1)throw new Error("get_const_curve: invalid input.");return{type:"yield",times:[1],dfs:[1/(1+t)]}},t.get_initialised_curve=function(e){if(!e)return t.get_const_curve(0);var r,i=function(e){var r,i;{if(void 0===e.times){if(void 0!==e.days)for(r=e.days.length,i=new Array(r);r>0;)i[--r]=e.days[r]/365;else if(void 0!==e.dates)for(r=e.dates.length,i=new Array(r),yf=t.year_fraction_factory("act/365"),ref_date=t.date_str_to_date(e.dates[0]);r>0;)i[--r]=yf(ref_date,t.date_str_to_date(e.dates[r]));else{if(void 0===e.labels)throw new Error("init_curve: invalid curve, cannot derive times");for(r=e.labels.length,i=new Array(r);r>0;)i[--r]=t.period_str_to_time(e.labels[r])}return i}for(r=e.times.length;r>0;)if(r--,"number"!=typeof e.times[r])throw new Error("get_curve_times: invalid vector of times, must be numeric");return e.times}}(e);if(void 0!==e.dfs)r=e.dfs;else{if(void 0===e.zcs)throw new Error("get_initialised_curve: invalid curve, both dfs and zcs undefined");r=function(t,e){var r,i;if(r=t.length,e.length!==r)throw new Error("get_dfs: invalid input, length of zcs does not match length of times");i=new Array(r);for(;r>0;){if("number"!=typeof t[--r])throw new Error("get_curve_times: invalid vector of times, must be numeric");i[r]=Math.pow(1+t[r],-e[r])}return i}(e.zcs,i)}return{type:"yield",times:i,dfs:r}},get_df_internal=function(t,e,r,i){if(e<1/512)return 1;if(r==i)return e===t.times[r]?t.dfs[r]:Math.pow(t.dfs[r],e/t.times[r]);if(e<t.times[r])return Math.pow(t.dfs[r],e/t.times[r]);if(e>t.times[i])return Math.pow(t.dfs[i],e/t.times[i]);if(r+1==i){if(t.times[i]-t.times[r]<1/512)throw new Error("get_df_internal: invalid curve, support points must be increasing and differ at least one day");return t.dfs[r]*(t.times[i]-e)/(t.times[i]-t.times[r])+t.dfs[i]*(e-t.times[r])/(t.times[i]-t.times[r])}return imed=Math.ceil((r+i)/2),e>t.times[imed]?get_df_internal(t,e,imed,i):get_df_internal(t,e,r,imed)},t.get_df=function(e,r){return c=t.get_initialised_curve(e),get_df_internal(c,r,0,c.times.length-1)},t.get_rate=function(e,r){return r<1/512?0:Math.pow(t.get_df(e,r),-1/r)-1},t.get_fwd_amount=function(e,r,i){return c=t.get_initialised_curve(e),t.get_df(c,r)/t.get_df(c,i)-1}}(this.JsonRisk||module.exports),function(t){t.fix_cash_flows=function(e,r,i,n,a,o){if(null===t.valuation_date)throw new Error("fix_cash_flows: valuation_date must be set");var s,f,d=new Array(e.length-1),u=new Array(e.length-1),l=new Array(e.length),_=new Array(e.length-1),c=t.year_fraction_factory(null);for(l[0]=c(t.valuation_date,e[0]),s=1;s<e.length;s++)d[s-1]=(f=e[s],t.adjust(f,r,i)),u[s-1]=c(t.valuation_date,d[s-1]),l[s]=c(t.valuation_date,e[s]),_[s-1]=a*o*n(e[s-1],e[s]);return _[_.length-1]+=a,{schedule:e,times_schedule:l,dates:d,amounts:_,times:u}},t.dcf=function(e,r,i,n,a){if(null===t.valuation_date)throw new Error("dcf: valuation_date must be set");var o=t.get_initialised_curve(r),s=t.get_initialised_curve(i);"number"!=typeof n&&(n=0);var f=t.get_initialised_date(a);if(f||(f=t.valuation_date),void 0===e.times||void 0===e.amounts)throw new Error("dcf: invalid cashflow object");if(e.times.length!==e.amounts.length)throw new Error("dcf: invalid cashflow object");for(var d,u,l,_=0,c=0;e.dates[c]<=f;)c++;for(;c<e.times.length;)d=t.get_df(o,e.times[c]),u=t.get_df(s,e.times[c]),l=Math.exp(-e.times[c]*n),_+=e.amounts[c]*d*u*l,c++;return _},t.fixed_income=function(e){var r=t.get_initialised_date(e.maturity);if(!r)throw new Error("fixed_income: must provide maturity date.");if("number"!=typeof e.notional)throw new Error("fixed_income: must provide valid notional.");if(this.notional=e.notional,"number"!=typeof e.tenor)throw new Error("fixed_income: must provide valid tenor.");if(e.tenor<0||e.tenor!==Math.floor(e.tenor))throw new Error("fixed_income: must provide valid tenor.");var i=e.tenor;this.type="string"==typeof e.type?e.type:"unknown",this.is_holiday_func=t.is_holiday_factory(e.calendar||""),this.year_fraction_func=t.year_fraction_factory(e.dcc||""),this.bdc=e.bdc||"";var n=t.get_initialised_date(e.effective_date),a=t.get_initialised_date(e.first_date),o=t.get_initialised_date(e.next_to_last_date),s="number"==typeof e.settlement_days?e.settlement_days:0;this.settlement_date=t.adjust(t.add_days(t.valuation_date,s),"following",this.is_holiday_func);"number"==typeof e.residual_spread&&e.residual_spread,e.currency;if("number"==typeof e.fixed_rate)this.is_float=!1,this.fixed_rate=e.fixed_rate;else{if(this.is_float=!0,this.float_spread="number"==typeof e.float_spread?e.float_spread:0,"number"!=typeof e.current_rate)throw new Error("fixed_income: must provide valid current_rate.");this.current_rate=e.current_rate}this.schedule=t.backward_schedule(n,r,i,this.is_holiday_func,this.bdc,a,o),this.cash_flows=t.fix_cash_flows(this.schedule,this.bdc,this.is_holiday_func,this.year_fraction_func,this.notional,this.fixed_rate)},t.fixed_income.prototype.get_cash_flows=function(e){if(!this.is_float)return this.cash_flows;var r,i=new Array(this.cash_flows.schedule.length-1);for(i[0]=this.notional*this.current_rate*this.year_fraction_func(this.cash_flows.schedule[0],this.cash_flows.schedule[1]),r=2;r<this.cash_flows.schedule.length;r++)i[r-1]=this.notional*t.get_fwd_amount(e,this.cash_flows.times_schedule[r-1],this.cash_flows.times_schedule[r]),i[r-1]+=this.notional*this.float_spread*this.year_fraction_func(this.cash_flows.schedule[r-1],this.cash_flows.schedule[r]);return i[i.length-1]+=this.notional,{schedule:this.cash_flows.schedule,times_schedule:this.cash_flows.times_schedule,dates:this.cash_flows.dates,amounts:i,times:this.cash_flows.times}},t.fixed_income.prototype.present_value=function(e,r,i){return t.dcf(this.get_cash_flows(i||null),e,r,this.residual_spread,this.settlement_date)}}(this.JsonRisk||module.exports),function(t){t.pricer_floater=function(e,r,i,n){return new t.fixed_income(e).present_value(r,i,n)}}(this.JsonRisk||module.exports),function(t){t.backward_schedule=function(e,r,i,n,a,o,s){if(!(r instanceof Date))throw new Error("backward_schedule: maturity must be provided");if(!(e instanceof Date)){if(null===t.valuation_date)throw new Error("backward_schedule: if valuation_date is unset, effective date must be provided");if(o instanceof Date)throw new Error("backward_schedule: if first date is provided, effective date must be provided")}if(e instanceof Date&&r<e||t.valuation_date instanceof Date&&r<t.valuation_date)throw new Error("backward_schedule: maturity is before valution or effective date.");if("number"!=typeof i)throw new Error("backward_schedule: tenor must be a nonnegative integer, e.g., 6 for semiannual schedule, 0 for zerobond/iam schedule");if(i<0||Math.floor(i)!==i)throw new Error("backward_schedule: tenor must be a nonnegative integer, e.g., 6 for semiannual schedule, 0 for zerobond/iam schedule");if(0===i)return[e,r];var f=function(e){return t.adjust(e,a,n)},d=[r],u=r;s instanceof Date&&f(s)<f(r)&&(d.unshift(s),u=s);for(var l,_=0;;){if(_++,l=t.add_months(u,-i*_),o instanceof Date&&l<o)return f(d[0]).getTime()!==f(o).getTime()&&d.unshift(o),f(d[0]).getTime()!==f(e).getTime()&&d.unshift(e),d;if(e instanceof Date&&l<e)return f(d[0]).getTime()!=f(e).getTime()&&d.unshift(e),d;if(t.valuation_date instanceof Date&&l<t.valuation_date)return d.unshift(l),f(l)>t.valuation_date&&(_++,l=t.add_months(u,-i*_),o instanceof Date&&l<o?d.unshift(o):e instanceof Date&&l<e?d.unshift(e):d.unshift(l)),d;d.unshift(l)}}}(this.JsonRisk||module.exports),function(t){function e(t){return t%4==0&&(2e3===t||t%100!=0)}function r(t,r){return 1===r?e(t)?29:28:3===r||5===r||8===r||10===r?30:31}function i(t,e){return(e-t)*one_over_dl}function n(t,e){return i(t,e)/365}function a(t,e){return i(t,e)/360}function o(t,e){return(360*(e.getFullYear()-t.getFullYear())+30*(e.getMonth()-t.getMonth())+(Math.min(e.getDate(),30)-Math.min(t.getDate(),30)))/360}function s(t,r){if(t-r==0)return 0;if(t>r)return-s(r,t);var n=t.getFullYear(),a=r.getFullYear();if(n===a)return i(r,t)/(e(n)?366:365);var o=a-n-1;return o+=i(t,new Date(n+1,0,1))/(e(n)?366:365),o+=i(new Date(a,0,1),r)/(e(a)?366:365)}function f(t){return d=t.getDay(),0===d||6===d}function u(e){var r=e.getDay();if(0===r)return!0;if(6===r)return!0;var i=e.getDate(),n=e.getMonth();if(1===i&&0===n)return!0;if(25===i&&11===n)return!0;var a=e.getFullYear();if((1998===a||1999===a||2001===a)&&31===i&&11===n)return!0;if(a>2e3){if(1===i&&4===n||26===i&&11===n)return!0;var o=function(t){var e=Math.floor,r=e(t/100),i=t-19*e(t/19),n=e((r-17)/25),a=r-e(r/4)-e((r-n)/3)+19*i+15;a-=30*e(a/30),a-=e(a/28)*(1-e(a/28)*e(29/(a+1))*e((21-i)/11));var o=t+e(t/4)+a+2-r+e(r/4),s=a-(o-=7*e(o/7)),f=3+e((s+40)/44),d=s+28-31*e(f/4);return new Date(t,f-1,d)}(a);if(e.getTime()===t.add_days(o,-2).getTime())return!0;if(e.getTime()===t.add_days(o,1).getTime())return!0}return!1}dl=864e5,one_over_dl=1/dl,t.period_str_to_time=function(t){var e=parseInt(t),r=t.charAt(t.length-1);if("Y"===r||"y"===r)return e;if("M"===r||"m"===r)return e/12;if("W"===r||"w"===r)return e/52;if("D"===r||"d"===r)return e/365;throw new Error("period_str_to_time(str) - Invalid time period string: "+t)},t.date_str_to_date=function(t){var e,i,n,a=null;if(null!==(a=/^([1-2][0-9]{3})[\/-]([0-9]{1,2})[\/-]([0-9]{1,2})/.exec(t))?(n=parseInt(a[1]),i=parseInt(a[2])-1,e=parseInt(a[3])):null!==(a=/^([0-9]{1,2})\.([0-9]{1,2})\.([1-2][0-9]{3})/.exec(t))&&(n=parseInt(a[3]),i=parseInt(a[2])-1,e=parseInt(a[1])),null===a)throw new Error("date_str_to_time(str) - Invalid date string: "+t);if(i<0||i>11)throw new Error("date_str_to_time(str) - Invalid month in date string: "+t);if(e<0||e>r(n,i))throw new Error("date_str_to_time(str) - Invalid day in date string: "+t);return new Date(n,i,e)},t.get_initialised_date=function(e){if(!e)return null;if(e instanceof Date)return e;if(e instanceof String||"string"==typeof e)return t.date_str_to_date(e);throw new Error("get_initialised_date: invalid input.")},t.year_fraction_factory=function(t){if(!(t instanceof String)&&"string"!=typeof t)return n;var e=t.toLowerCase();if("a"===e.charAt(0)){if("actual/365"===e||"act/365"===e||"a/365"===e||"act/365 (fixed)"===e||"actual/365 (fixed)"===e)return n;if("act/360"===e||"a/360"===e)return a;if("act/act"===e||"a/a"===e)return s}return"3"===e.charAt(0)&&"30e/360"===e?o:n},t.add_days=function(t,e){return new Date(t.valueOf()+dl*e)},t.add_months=function(t,e,i){for(y=t.getFullYear(),m=t.getMonth()+e;m>=12;)m-=12,y+=1;for(;m<0;)m+=12,y-=1;return d=void 0===i?t.getDate():i,new Date(y,m,Math.min(d,r(y,m)))},t.is_holiday_factory=function(t){return"target"===t.toLowerCase()?u:f},t.adjust=function(e,r,i){var n,a=(r||"u").charAt(0).toLowerCase(),o=new Date(e);if("u"===a)return o;if("m"===a&&(n=o.getMonth()),"m"===a||"f"===a)for(;i(o);)o=t.add_days(o,1);if("f"===a)return o;if("m"===a&&n===o.getMonth())return o;for("m"===a&&(o=t.add_days(o,-1));i(o);)o=t.add_days(o,-1);return o}}(this.JsonRisk||module.exports);