/*! json_risk 25-02-2018 */

!function(e,t){"object"==typeof module&&"undefined"!=typeof exports?module.exports=t():e.JsonRisk=t()}(this,function(){var e={valuation_date:null,pricer:function(e,t){return null}};return e}),function(e){e.validate_bond=function(e){return"number"==typeof e.notional&&(e.maturity instanceof Date&&void 0)},e.pricer_bond=function(e,t){return null},e.bond_dirty_value=function(t,a,n,r){if(null===e.valuation_date)throw new Error("dcf: valuation_date must be set");if(!(t.maturity instanceof String)&&"string"!=typeof t.maturity)throw new Error("bond_dirty_value: must provide maturity date.");if("number"!=typeof t.notional)throw new Error("bond_dirty_value: must provide notional.");var i,o=e.is_holiday_factory(t.calendar||""),s=e.year_fraction_factory(t.dcc||""),u=e.date_str_to_date(t.maturity),d=void 0===t.effective_date?null:e.date_str_to_date(t.effective_date),f=void 0===t.first_date?null:e.date_str_to_date(t.first_date),l=void 0===t.next_to_last_date?null:e.date_str_to_date(t.next_to_last_date),_=e.backward_schedule(d,u,t.freq,o,t.bdc||"",f,l);i="number"==typeof t.fixed_rate?e.fix_cash_flows(_,t.bdc,o,s,t.notional,t.fixed_rate):e.float_cash_flows(_,t.bdc,o,s,t.notional,t.current_rate,t.float_spread,r);var c=e.adjust(e.add_days(e.valuation_date,"number"==typeof t.settlement_days?t.settlement_days:0),"following",o);return e.dcf(i,a,n,t.residual_spread,c)}}(this.JsonRisk||module.exports),function(e){e.get_const_curve=function(e){return{type:"yield",labels:["1Y"],times:[1],values:[e]}},get_rate_internal_=function(e,t,a,n){return a==n?e.values[a]:a+1==n?e.values[a]*(e._cache.times[n]-t)/(e._cache.times[n]-e._cache.times[a])+e.values[n]*(t-e._cache.times[a])/(e._cache.times[n]-e._cache.times[a]):t<e._cache.times[a]?e.values[a]:t>e._cache.times[n]?e.values[n]:(imed=Math.ceil((a+n)/2),t>e._cache.times[imed]?get_rate_internal_(e,t,imed,n):get_rate_internal_(e,t,a,imed))},e.get_rate=function(t,a){return void 0!==t._cache&&void 0!==t._cache.times||function(t){if(t._cache={},void 0!==t.times)t._cache.times=t.times;else if(void 0!==t.days)for(i=t.days.length,t._cache.times=new Array(i);i>0;)i--,t._cache.times[i]=t.days[i]/365;else if(void 0!==t.dates)for(i=t.dates.length,t._cache.times=new Array(i),yf=e.year_fraction_factory("act/365"),ref_date=e.date_str_to_date(t.dates[0]);i>0;)i--,t._cache.times[i]=yf(ref_date,e.date_str_to_date(t.dates[i]));else{if(void 0===t.labels)throw new Error("init_curve: invalid curve, cannot derive times");for(i=t.labels.length,t._cache.times=new Array(i);i>0;)i--,t._cache.times[i]=e.period_str_to_time(t.labels[i])}if(t._cache.times.length!==t.values.length)throw new Error("init_curve: invalid curve, length of values does not match length of times")}(t),get_rate_internal_(t,a,0,t._cache.times.length-1)},e.get_fwd_amount=function(e,t,a){return Math.pow(1+get_rate(e,t),-t)/Math.pow(1+get_rate(e,a),-a)-1}}(this.JsonRisk||module.exports),function(e){e.fix_cash_flows=function(t,a,n,r,i,o){if(null===e.valuation_date)throw new Error("fix_cash_flows: valuation_date must be set");var s,u,d=new Array(t.length-1),f=new Array(t.length-1),l=new Array(t.length-1),_=e.year_fraction_factory(null);for(s=1;s<t.length;s++)d[s-1]=(u=t[s],e.adjust(u,a,n)),f[s-1]=_(e.valuation_date,d[s-1]),l[s-1]=i*o*r(t[s-1],t[s]);return l[l.length-1]+=i,{schedule:t,dates:d,amounts:l,times:f}},e.float_cash_flows=function(t,a,n,r,i,o,s,u){if(null===e.valuation_date)throw new Error("float_cash_flows: valuation_date must be set");var d,f,l=new Array(t.length-1),_=new Array(t.length-1),c=new Array(t.length-1),h=e.year_fraction_factory(null);for(d=1;d<t.length;d++)1==d&&(c[d-1]=i*o*r(t[d-1],t[d])),l[d-1]=(f=t[d],e.adjust(f,a,n)),_[d-1]=h(e.valuation_date,l[d-1]);return e.update_float_cash_flows({schedule:t,dates:l,amounts:c}),{schedule:t,dates:l,amounts:c,times:_}},e.update_float_cash_flows=function(t,a,n,r,i){var o;for(o=2;o<t.schedule.length;o++)t.amounts[o-1]=n*e.get_fwd_amount(i,t.schedule[o-1],t.schedule[o])*yf(t.schedule[o-1],t.schedule[o]);t.amounts[t.amounts.length]+=n},e.dcf=function(t,a,n,r,i){if(null===e.valuation_date)throw new Error("dcf: valuation_date must be set");null==a&&(a=e.get_const_curve(0)),null==n&&(n=e.get_const_curve(0)),"number"!=typeof r&&(r=0);var o=i instanceof Date?i:e.valuation_date;if(void 0===t.times||void 0===t.amounts)throw new Error("dcf: invalid cashflow object");if(t.times.length!==t.amounts.length)throw new Error("dcf: invalid cashflow object");for(var s,u,d,f=0,l=0;t.dates[l]<=o;)l++;for(;l<t.times.length;)s=e.get_rate(a,t.times[l]),u=e.get_rate(n,t.times[l]),d=Math.pow(1+s+u+r,-t.times[l]),f+=t.amounts[l]*d,l++;return f}}(this.JsonRisk||module.exports),function(e){e.backward_schedule=function(t,a,n,r,i,o,s){if(!(a instanceof Date))throw new Error("backward_schedule: maturity must be provided");if(!(t instanceof Date)){if(null===e.valuation_date)throw new Error("backward_schedule: if valuation_date is unset, effective date must be provided");if(o instanceof Date)throw new Error("backward_schedule: if first date is provided, effective date must be provided")}if(t instanceof Date&&a<t||e.valuation_date instanceof Date&&a<e.valuation_date)throw new Error("backward_schedule: maturity is before valution or effective date.");if("number"!=typeof n)throw new Error("backward_schedule: freq must be a nonnegative integer, e.g., 6 for semiannual schedule, 0 for zerobond/iam schedule");if(n<0||Math.floor(n)!==n)throw new Error("backward_schedule: freq must be a nonnegative integer, e.g., 6 for semiannual schedule, 0 for zerobond/iam schedule");if(0===n)return[t,a];var u=function(t){return e.adjust(t,i,r)},d=[a],f=a;s instanceof Date&&u(s)<u(a)&&(d.unshift(s),f=s);for(var l,_=0;;){if(_++,l=e.add_months(f,-n*_),o instanceof Date&&l<o)return u(d[0]).getTime()!==u(o).getTime()&&d.unshift(o),u(d[0]).getTime()!==u(t).getTime()&&d.unshift(t),d;if(t instanceof Date&&l<t)return u(d[0]).getTime()!=u(t).getTime()&&d.unshift(t),d;if(e.valuation_date instanceof Date&&l<e.valuation_date)return d.unshift(l),u(l)>e.valuation_date&&(_++,l=e.add_months(f,-n*_),o instanceof Date&&l<o?d.unshift(o):t instanceof Date&&l<t?d.unshift(t):d.unshift(l)),d;d.unshift(l)}}}(this.JsonRisk||module.exports),function(e){function t(e){return e%4==0&&(2e3===e||e%100!=0)}function a(e,a){return 1===a?t(e)?29:28:3===a||5===a||8===a||10===a?30:31}function n(e,t){return(t-e)/864e5}function r(e,t){return n(e,t)/365}function i(e,t){return n(e,t)/360}function o(e,t){return(360*(t.getFullYear()-e.getFullYear())+30*(t.getMonth()-e.getMonth())+(Math.min(t.getDate(),30)-Math.min(e.getDate(),30)))/360}function s(e,a){if(e-a==0)return 0;if(e>a)return-s(a,e);var r=e.getFullYear(),i=a.getFullYear();if(r===i)return n(a,e)/(t(r)?366:365);var o=i-r-1;return o+=n(e,new Date(r+1,0,1))/(t(r)?366:365),o+=n(new Date(i,0,1),a)/(t(i)?366:365)}function u(e){return d=e.getDay(),0===d||6===d}function f(t){var a=t.getDay();if(0===a)return!0;if(6===a)return!0;var n=t.getDate(),r=t.getMonth();if(1===n&&0===r)return!0;if(25===n&&11===r)return!0;var i,o=t.getFullYear();if((1998===o||1999===o||2001===o)&&31===n&&11===r)return!0;if(o>2e3){if(1===n&&4===r||26===n&&11===r)return!0;var s=(i=o,es_d_m=[[15,3],[7,3],[30,2],[12,3],[3,3],[23,3],[15,3],[31,2],[19,3],[11,3],[27,2],[16,3],[7,3],[23,2],[12,3],[4,3],[23,3],[8,3],[31,2],[20,3],[4,3],[27,2],[16,3],[1,3],[20,3],[12,3],[4,3],[17,3],[8,3],[31,2],[20,3],[5,3],[27,2],[16,3],[1,3],[21,3],[12,3],[28,2],[17,3],[9,3],[24,2],[13,3],[5,3],[25,3],[9,3],[1,3],[21,3],[6,3],[28,2],[17,3],[9,3],[25,2],[13,3],[5,3],[18,3],[10,3],[1,3],[21,3],[6,3],[29,2],[17,3],[2,3],[22,3],[14,3],[29,2],[18,3],[10,3],[26,2],[14,3],[6,3],[29,2],[11,3],[2,3],[22,3],[14,3],[30,2],[18,3],[10,3],[26,2],[15,3],[6,3],[19,3],[11,3],[3,3],[22,3],[7,3],[30,2],[19,3],[3,3],[26,2],[15,3],[31,2],[19,3],[11,3],[3,3],[16,3],[7,3],[30,2],[12,3],[4,3],[23,3],[15,3],[31,2],[20,3],[11,3],[27,2],[16,3],[8,3],[23,2],[12,3],[4,3],[24,3],[8,3],[31,2],[20,3],[5,3],[27,2],[16,3],[1,3],[21,3],[12,3],[4,3],[17,3],[9,3],[31,2],[20,3],[5,3],[28,2],[16,3],[1,3],[21,3],[13,3],[28,2],[17,3],[9,3],[25,2],[13,3],[5,3],[25,3],[10,3],[1,3],[21,3],[6,3],[29,2],[17,3],[9,3],[25,2],[14,3],[5,3],[18,3],[10,3],[2,3],[21,3],[6,3],[29,2],[18,3],[2,3],[22,3],[14,3],[30,2],[18,3],[10,3],[26,2],[15,3],[6,3],[29,2],[11,3],[3,3],[22,3],[14,3],[30,2],[19,3],[10,3],[26,2],[15,3],[7,3],[19,3],[11,3],[3,3],[23,3],[7,3],[30,2],[19,3],[4,3],[26,2],[15,3],[31,2],[20,3],[11,3],[3,3],[16,3],[8,3],[30,2],[12,3],[4,3],[24,3],[15,3],[31,2],[20,3],[12,3],[28,2],[17,3],[9,3],[25,2],[13,3],[5,3],[18,3],[10,3],[1,3],[21,3],[6,3],[29,2],[17,3],[2,3],[22,3],[14,3],[29,2],[18,3],[10,3],[26,2],[14,3],[6,3],[29,2],[11,3],[2,3],[22,3],[14,3],[30,2],[18,3],[10,3],[26,2],[15,3],[6,3],[19,3],[11,3],[3,3],[22,3],[7,3],[30,2],[19,3],[3,3],[26,2],[15,3],[31,2],[19,3],[11,3],[3,3],[16,3],[7,3],[30,2],[12,3],[4,3],[23,3],[15,3],[31,2],[20,3],[11,3],[27,2],[16,3],[8,3],[23,2],[12,3],[4,3],[24,3],[8,3],[31,2],[20,3],[5,3],[27,2],[16,3],[1,3],[21,3],[12,3],[4,3],[17,3],[9,3],[31,2],[20,3],[5,3],[28,2],[16,3],[1,3],[21,3],[13,3],[28,2],[17,3],[9,3],[25,2],[13,3],[5,3],[25,3],[10,3],[1,3],[21,3],[6,3],[29,2],[17,3],[9,3],[25,2],[14,3],[6,3]],index=i-1900,index<0&&(index=0),index>es_d_m.length&&(index=es_d_m.length),new Date(i,es_d_m[index][1],es_d_m[index][0]));if(t.getTime()===e.add_days(s,-2).getTime())return!0;if(t.getTime()===e.add_days(s,1).getTime())return!0}return!1}e.period_str_to_time=function(e){var t=parseInt(e),a=e.charAt(e.length-1);if("Y"===a||"y"===a)return t;if("M"===a||"m"===a)return t/12;if("W"===a||"w"===a)return t/52;if("D"===a||"d"===a)return t/365;throw new Error("period_str_to_time(str) - Invalid time period string: "+e)},e.date_str_to_date=function(e){var t,n,r,i=null;if(null!==(i=/^([1-2][0-9]{3})[\/-]([0-9]{1,2})[\/-]([0-9]{1,2})/.exec(e))?(r=parseInt(i[1]),n=parseInt(i[2])-1,t=parseInt(i[3])):null!==(i=/^([0-9]{1,2})\.([0-9]{1,2})\.([1-2][0-9]{3})/.exec(e))&&(r=parseInt(i[3]),n=parseInt(i[2])-1,t=parseInt(i[1])),null===i)throw new Error("date_str_to_time(str) - Invalid date string: "+e);if(n<0||n>11)throw new Error("date_str_to_time(str) - Invalid month in date string: "+e);if(t<0||t>a(r,n))throw new Error("date_str_to_time(str) - Invalid day in date string: "+e);return new Date(r,n,t)},e.year_fraction_factory=function(e){if(!(e instanceof String)&&"string"!=typeof e)return r;var t=e.toLowerCase();if("a"===t.charAt(0)){if("actual/365"===t||"act/365"===t||"a/365"===t||"act/365 (fixed)"===t||"actual/365 (fixed)"===t)return r;if("act/360"===t||"a/360"===t)return i;if("act/act"===t||"a/a"===t)return s}return"3"===t.charAt(0)&&"30e/360"===t?o:r},e.add_days=function(e,t){return new Date(e.valueOf()+864e5*t)},e.add_months=function(e,t,n){for(y=e.getFullYear(),m=e.getMonth()+t;m>=12;)m-=12,y+=1;for(;m<0;)m+=12,y-=1;return d=null==n?e.getDate():n,new Date(y,m,Math.min(d,a(y,m)))},e.is_holiday_factory=function(e){return"target"===e.toLowerCase()?f:u},e.adjust=function(t,a,n){var r,i=(a||"u").charAt(0).toLowerCase(),o=new Date(t);if("u"===i)return o;if("m"===i&&(r=o.getMonth()),"m"===i||"f"===i)for(;n(o);)o=e.add_days(o,1);if("f"===i)return o;if("m"===i&&r===o.getMonth())return o;for("m"===i&&(o=e.add_days(o,-1));n(o);)o=e.add_days(o,-1);return o}}(this.JsonRisk||module.exports);