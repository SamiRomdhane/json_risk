/*! json_risk 20-12-2023 */

!function(e,t){"object"==typeof module&&"undefined"!=typeof exports?module.exports=t():e.JsonRisk=t()}(this,function(){var e={valuation_date:null,require_vd:function(){if(!(e.valuation_date instanceof Date))throw new Error("JsonRisk: valuation_date must be set")}};return e}),function(_){_.callable_fixed_income=function(e){if(!_.get_safe_number_vector(e.fixed_rate))throw new Error("callable_fixed_income: must provide valid fixed_rate.");var t=_.get_safe_date(e.first_exercise_date);if(null===t)throw new Error("callable_fixed_income: must provide first call date");if(this.base=new _.fixed_income(e),t.getTime()<=this.base.schedule[0].getTime())throw new Error("callable_fixed_income: first call date before issue date");if(!this.base.notional_exchange)throw new Error("callable_fixed_income: callable instruments must exchange notionals");var r=_.get_safe_natural(e.call_tenor);this.call_schedule=_.schedule(t,_.get_safe_date(e.maturity),r||0,this.base.adj),this.call_schedule.pop(),this.opportunity_spread=_.get_safe_number(e.opportunity_spread)||0,this.exclude_base=_.get_safe_bool(e.exclude_base),this.simple_calibration=_.get_safe_bool(e.simple_calibration);for(var a,n=this.base.get_cash_flows(),i=n.current_principal.length-1;0===n.current_principal[i];)i--;for(;this.call_schedule[this.call_schedule.length-1]>=n.date_pmt[i];)this.call_schedule.pop();for(this.basket=new Array(this.call_schedule.length),i=0;i<this.call_schedule.length;i++)!this.base.is_amortizing&&1===this.base.fixed_rate.length||this.simple_calibration?this.basket[i]=new _.swaption({is_payer:!1,maturity:e.maturity,first_exercise_date:this.call_schedule[i],notional:e.notional,fixed_rate:this.base.fixed_rate[0]-this.opportunity_spread-this.base.excl_margin,tenor:12,float_spread:0,float_tenor:e.float_tenor||6,float_current_rate:0,calendar:e.calendar,bdc:e.bdc,float_bdc:e.bdc,dcc:e.dcc,float_dcc:e.dcc}):((a=_.create_equivalent_regular_swaption(this.base.get_cash_flows(),this.call_schedule[i],{tenor:12,float_spread:0,float_tenor:e.float_tenor||6,calendar:e.calendar,bdc:e.bdc})).fixed_rate-=this.opportunity_spread,this.basket[i]=new _.swaption(a))},_.callable_fixed_income.prototype.present_value=function(e,t,r,a){var n,i=0;_.require_vd();var s,o=[];for(n=0;n<this.call_schedule.length;n++)1/512<(s=_.time_from_now(this.call_schedule[n]))&&o.push(s);if("object"!=typeof e||null===e)throw new Error("callable_fixed_income.present_value: must provide discount curve");if("object"!=typeof r||null===r)throw new Error("callable_fixed_income.present_value: must provide forward curve for calibration");if(_.get_safe_curve(e),_.get_safe_curve(r),t&&_.get_safe_curve(t),"object"!=typeof a||null===a)throw new Error("callable_fixed_income.present_value: must provide valid surface");var l=_.lgm_calibrate(this.basket,e,r,a);return 1===l.length?i=-_.lgm_european_call_on_cf(this.base.get_cash_flows(),o[0],e,l[0],t,this.base.residual_spread,this.opportunity_spread):1<l.length&&(i=-_.lgm_bermudan_call_on_cf(this.base.get_cash_flows(),o,e,l,t,this.base.residual_spread,this.opportunity_spread)),this.exclude_base||(i+=this.base.present_value(e,t,null)),i},_.pricer_callable_bond=function(e,t,r,a,n){return new _.callable_fixed_income(e).present_value(t,r,a,n)}}(this.JsonRisk||module.exports),function(f){var r=null;function a(e,t){if(e.times)return e.times[t];if(e.days)return e.days[t]/365;if(e.dates)return(r=r||f.year_fraction_factory("a/365"))(f.get_safe_date(e.dates[0]),f.get_safe_date(e.dates[t]));if(e.labels)return f.period_str_to_time(e.labels[t]);throw new Error("get_time_at: invalid curve, cannot derive times")}function n(e,t){if(Array.isArray(e.dfs))return e.dfs[t];if(Array.isArray(e.zcs))return Math.pow(1+e.zcs[t],-a(e,t));throw new Error("get_df: invalid curve, must provide dfs or zcs")}function c(e){var t=(e.times||e.days||e.dates||e.labels||[]).length;if(!t)throw new Error("get_curve_dfs: invalid curve, need to provide valid times, days, dates, or labels");if(e.dfs){if(e.dfs.length!==t)throw new Error("get_curve_dfs: invalid curve, dfs length must match times length")}else if(e.zcs.length!==t)throw new Error("get_curve_dfs: invalid curve, zcs length must match times length");for(var r=new Array(t);0<t;)if(r[--t]=e.dfs?e.dfs[t]:n(e,t),"number"!=typeof r[t])throw new Error("get_curve_dfs: invalid curve, must provide numeric zcs or dfs");return r}function i(e,t,r){var a=0,n=e.length-1;if(r<1/512)return 1;var i=e[a];if(a===n)return r===i?t[a]:Math.pow(t[a],r/i);var s,o,l=e[n];if(r<i)return Math.pow(t[a],r/i);if(l<r)return Math.pow(t[n],r/l);for(;a+1!==n;)(o=e[s=(a+n)/2|0])<r?(i=o,a=s):(l=o,n=s);if(l-i<1/512)throw new Error("get_df_internal: invalid curve, support points must be increasing and differ at least one day");var _=1/(l-i);return(t[a]*(l-r)+t[n]*(r-i))*_}function d(e,t,r){return r<1/512?0:Math.pow(i(e,t,r),-1/r)-1}f.get_const_curve=function(e,t){if("number"!=typeof e)throw new Error("get_const_curve: input must be number.");if(e<=-1)throw new Error("get_const_curve: invalid input.");return f.get_safe_curve({type:t||"yield",times:[1],dfs:[1/(1+e)]})},f.get_curve_times=function(e){var t=(e.times||e.days||e.dates||e.labels||[]).length;if(!t)throw new Error("get_curve_times: invalid curve, need to provide valid times, days, dates, or labels");for(var r=new Array(t);0<t;)r[--t]=a(e,t);return r},f.get_safe_curve=function(e){e||(e={times:[1],dfs:[1]});var t=f.get_curve_times(e),r=c(e);e.get_df=function(e){return i(t,r,e)},e.get_rate=function(e){return d(t,r,e)},e.get_fwd_rate=function(e,t){return t-e<1/512?0:Math.pow(this.get_df(t)/this.get_df(e),-1/(t-e))-1},e.get_times=function(){return t},e.get_dfs=function(){return r};var a=e;if("object"==typeof e._rule){var n={labels:e._rule.labels_x,zcs:e._rule.values[0]};"multiplicative"===e._rule.model&&(a=f.multiply_curves(e,n)),"additive"===e._rule.model&&(a=f.add_curves(e,n)),"absolute"===e._rule.model&&(a=n),t=f.get_curve_times(a),r=c(a)}return e},f.get_df=function(e,t){return e.get_df instanceof Function?e.get_df(t):f.get_safe_curve(e).get_df(t)},f.get_rate=function(e,t){return e.get_rate instanceof Function?e.get_rate(t):f.get_safe_curve(e).get_rate(t)},f.get_fwd_rate=function(e,t,r){return e.get_fwd_rate instanceof Function?e.get_fwd_rate(t,r):f.get_safe_curve(e).get_fwd_rate(t,r)},f.add_curves=function(e,t){for(var r,a=f.get_curve_times(e),n=f.get_curve_times(t),i=c(e),s=c(t),o=[],l=0,_=0,u=[];r=Number.POSITIVE_INFINITY,l<a.length&&(r=Math.min(a[l],r)),_<n.length&&(r=Math.min(n[_],r)),o.push(r),u.push(d(a,i,r)+d(n,s,r)),r===a[l]&&l<a.length&&l++,r===n[_]&&_<n.length&&_++,l!==a.length||_!==n.length;);return{times:o,zcs:u}},f.multiply_curves=function(e,t){for(var r,a=f.get_curve_times(e),n=f.get_curve_times(t),i=c(e),s=c(t),o=[],l=0,_=0,u=[];r=Number.POSITIVE_INFINITY,l<a.length&&(r=Math.min(a[l],r)),_<n.length&&(r=Math.min(n[_],r)),o.push(r),u.push(d(a,i,r)*d(n,s,r)),r===a[l]&&l<a.length&&l++,r===n[_]&&_<n.length&&_++,l!==a.length||_!==n.length;);return{times:o,zcs:u}}}(this.JsonRisk||module.exports),function(c){c.dcf=function(e,t,r,a,n){c.require_vd(),"number"!=typeof a&&(a=0),t=t||c.get_const_curve(0);var i=c.get_safe_date(n);i||(i=c.valuation_date);var s=c.time_from_now(i);if(void 0===e.t_pmt||void 0===e.pmt_total)throw new Error("dcf: invalid cashflow object");if(e.t_pmt.length!==e.pmt_total.length)throw new Error("dcf: invalid cashflow object");for(var o,l,_=0,u=0,f=!r&&0===a;e.t_pmt[u]<=s;)u++;for(;u<e.t_pmt.length;)o=f?t.get_df(e.t_pmt[u]):(l=a+t.get_rate(e.t_pmt[u]),r&&(l+=r.get_rate(e.t_pmt[u])),Math.pow(1+l,-e.t_pmt[u])),_+=e.pmt_total[u]*o,u++;return _},c.irr=function(t,r,a){c.require_vd(),a||(a=0);var n=c.time_from_now(r);return c.find_root_secant(function(e){return c.dcf(t,null,null,e,r)+a*Math.pow(1+e,-n)},0,1e-4)}}(this.JsonRisk||module.exports),function(r){r.equity=function(e){if(this.quantity=r.get_safe_number(e.quantity),null===this.quantity)throw new Error("equity: must provide valid quantity")},r.equity.prototype.present_value=function(e){var t=r.get_safe_scalar(e);return this.quantity*t.get_value()},r.pricer_equity=function(e,t){return new r.equity(e).present_value(t)}}(this.JsonRisk||module.exports),function(b){b.fixed_income=function(e){var t=b.get_safe_date(e.maturity);if(!t)throw new Error("fixed_income: must provide maturity date.");var r=b.get_safe_date(e.effective_date);if(this.notional=b.get_safe_number(e.notional),null===this.notional)throw new Error("fixed_income: must provide valid notional.");this.notional_exchange=b.get_safe_bool(e.notional_exchange),null!==e.notional_exchange&&""!==e.notional_exchange&&void 0!==e.notional_exchange||(this.notional_exchange=!0);var a=b.get_safe_natural(e.tenor);if(null===a)throw new Error("fixed_income: must provide valid tenor.");var n=b.get_safe_date(e.first_date),i=b.get_safe_date(e.next_to_last_date),s=b.get_safe_bool(e.stub_end),o=b.get_safe_bool(e.stub_long);this.excl_margin=b.get_safe_number(e.excl_margin)||0,this.type="string"==typeof e.type?e.type:"unknown",this.is_holiday_func=b.is_holiday_factory(e.calendar||""),this.year_fraction_func=b.year_fraction_factory(e.dcc||""),this.bdc=e.bdc||"",this.adjust_accrual_periods=b.get_safe_bool(e.adjust_accrual_periods),this.adj=function(e){return b.adjust(e,this.bdc,this.is_holiday_func)};var l=b.get_safe_natural(e.repay_tenor);null===l&&(l=a);var _=e.linear_amortization||!1;this.repay_amount=b.get_safe_number_vector(e.repay_amount)||[0],this.interest_capitalization=b.get_safe_bool_vector(e.interest_capitalization);var u=b.get_safe_date(e.repay_first_date)||this.first_date,f=b.get_safe_date(e.repay_next_to_last_date)||this.next_to_last_date,c=e.stub_end||!1,d=e.stub_long||!1;if(this.conditions_valid_until=b.get_safe_date_vector(e.conditions_valid_until),this.conditions_valid_until){if(this.conditions_valid_until[this.conditions_valid_until.length-1].getTime()!==t.getTime())throw new Error("fixed_income: last date provided under conditions_valid_until must match maturity")}else this.conditions_valid_until=[t];var h=b.get_safe_natural(e.settlement_days)||0;this.settlement_date=b.get_safe_date(e.settlement_date)||b.add_business_days(b.valuation_date,h,this.is_holiday_func),this.residual_spread="number"==typeof e.residual_spread?e.residual_spread:0;e.currency;if(this.schedule=b.schedule(r,t,a,this.adj,n,i,s,o),e.fixed_rate||0===e.fixed_rate)this.is_float=!1,this.fixed_rate=b.get_safe_number_vector(e.fixed_rate),this.float_spread=0,this.cap_rate=[0],this.floor_rate=[0],this.fixing_schedule=[this.schedule[0],t];else{if(this.is_float=!0,this.fixed_rate=null,this.float_spread=b.get_safe_number_vector(e.float_spread)||[0],this.float_current_rate=b.get_safe_number(e.float_current_rate),null===this.float_current_rate)throw new Error("fixed_income: must provide valid float_current_rate.");var g=b.get_safe_natural(e.fixing_tenor);null===g&&(g=a);var p=b.get_safe_date(e.fixing_first_date)||this.first_date,m=b.get_safe_date(e.fixing_next_to_last_date)||this.next_to_last_date;e.fixing_stub_end,e.fixing_stub_long;this.cap_rate="number"==typeof e.cap_rate?[e.cap_rate]:[Number.POSITIVE_INFINITY],this.floor_rate="number"==typeof e.floor_rate?[e.floor_rate]:[Number.POSITIVE_INFINITY],this.fixing_schedule=b.schedule(this.schedule[0],t,g,this.adj,p,m)}this.is_amortizing=0<this.repay_amount.reduce(function(e,t){return Math.max(e*e,t*t)},0)||this.interest_capitalization.reduce(function(e,t){return e||t},!1)||_,this.is_amortizing?this.repay_schedule=b.schedule(this.schedule[0],t,l,this.adj,u,f,c,d):this.repay_schedule=[this.schedule[0],t],_&&(this.repay_amount=[Math.abs(this.notional)/(this.repay_schedule.length-1)]),this.cash_flows=this.initialize_cash_flows(),this.is_float||(this.cash_flows=this.finalize_cash_flows(null))},b.fixed_income.prototype.initialize_cash_flows=function(){b.require_vd();var e=new Array(this.schedule.length),t=new Array(this.schedule.length),r=new Array(this.schedule.length),a=new Array(this.schedule.length),n=new Array(this.schedule.length),i=new Array(this.schedule.length);e[0]=this.schedule[0],t[0]=this.schedule[0],r[0]=!1,a[0]=!1,n[0]=!0,i[0]=!1;var s=1,o=1,l=1,_=1,u=0;for(i_max=this.schedule.length+this.repay_schedule.length+this.fixing_schedule.length+this.conditions_valid_until.length;s<i_max&&(e[s]=t[s-1],t[s]=new Date(Math.min(this.schedule[o],this.repay_schedule[l],this.fixing_schedule[_],this.conditions_valid_until[u])),o<this.schedule.length&&t[s].getTime()===this.schedule[o].getTime()?(r[s]=!0,o++):r[s]=!1,l<this.repay_schedule.length&&t[s].getTime()===this.repay_schedule[l].getTime()?(a[s]=!0,l++):a[s]=!1,_<this.fixing_schedule.length&&t[s].getTime()===this.fixing_schedule[_].getTime()?(n[s]=!0,_++):n[s]=!1,u<this.conditions_valid_until.length&&t[s].getTime()===this.conditions_valid_until[u].getTime()?(i[s]=!0,u++):i[s]=!1,o!==this.schedule.length||l!==this.repay_schedule.length||_!==this.fixing_schedule.length);)s++;var f=new Array(e.length),c=new Array(e.length),d=new Array(e.length),h=new Array(e.length),g=(new Array(e.length),new Array(e.length));new Array(e.length),new Array(e.length),new Array(e.length),new Array(e.length),new Array(e.length);for(s=0;s<e.length;s++)this.adjust_accrual_periods&&(e[s]=this.adj(e[s]),t[s]=this.adj(t[s])),f[s]=this.adj(t[s]),h[s]=b.time_from_now(f[s]),c[s]=b.time_from_now(e[s]),d[s]=b.time_from_now(t[s]),g[s]=0===s?0:this.year_fraction_func(e[s],t[s]);return{date_accrual_start:e,date_accrual_end:t,date_pmt:f,t_accrual_start:c,t_accrual_end:d,t_pmt:h,is_interest_date:r,is_repay_date:a,is_fixing_date:n,is_condition_date:i,accrual_factor:g}},b.fixed_income.prototype.finalize_cash_flows=function(e,t){b.require_vd();b.year_fraction_factory(null);for(var r=this.cash_flows,a=r.date_accrual_start.length,n=new Array(a),i=new Array(a),s=new Array(a),o=new Array(a),l=new Array(a),_=new Array(a),u=new Array(a),f=0<=this.notional?1:-1,c=0;this.conditions_valid_until[c]<r.date_accrual_start[0];)c++;var d,h,g,p=this.repay_amount[Math.min(c,this.repay_amount.length-1)],m=this.interest_capitalization[Math.min(c,this.interest_capitalization.length-1)],v=(this.cap_rate[Math.min(c,this.cap_rate.length-1)],this.floor_rate[Math.min(c,this.floor_rate.length-1)],this.is_float?this.float_spread:this.fixed_rate);g="number"==typeof t?function(){return t}:function(){return v[Math.min(c,v.length-1)]},l[o[s[i[n[0]=0]=0]=0]=0]=-this.notional,u[_[0]=0]=this.notional_exchange?-this.notional:0;var w,y=0;for(w=1;w<a;w++){if(n[w]=n[w-1]-l[w-1],r.is_repay_date[w]?l[w]=p*f:l[w]=0,this.is_float)if(r.t_accrual_start[w]<=0)i[w]=this.float_current_rate;else if(r.is_fixing_date[w-1]){for(h=0;!r.is_fixing_date[w+h]&&w+h<r.is_fixing_date.length;)h++;i[w]=b.get_fwd_rate(e,r.t_accrual_start[w],r.t_accrual_end[w+h])}else i[w]=i[w-1];else i[w]=0;d=i[w]+g(),s[w]=n[w]*(d-this.excl_margin)*r.accrual_factor[w],0!==this.excl_margin&&(y+=n[w]*this.excl_margin*r.accrual_factor[w]),o[w]=(0<w?o[w-1]:0)+s[w],r.is_interest_date[w]?(_[w]=o[w],o[w]=0,m&&(l[w]=l[w]-_[w],0!==this.excl_margin&&(l[w]=l[w]-y)),y=0):_[w]=0,(w<a-1&&l[w]*f>n[w]*f||w===a-1)&&(l[w]=n[w]),u[w]=_[w],this.notional_exchange&&(u[w]+=l[w]),r.is_condition_date[w]&&(c++,p=this.repay_amount[Math.min(c,this.repay_amount.length-1)],m=this.interest_capitalization[Math.min(c,this.interest_capitalization.length-1)],this.cap_rate[Math.min(c,this.cap_rate.length-1)],this.floor_rate[Math.min(c,this.floor_rate.length-1)])}if(!1===this.notional_exchange)for(w=0;w<a;w++)l[w]=0;return{date_accrual_start:r.date_accrual_start,date_accrual_end:r.date_accrual_end,date_pmt:r.date_pmt,t_accrual_start:r.t_accrual_start,t_accrual_end:r.t_accrual_end,t_pmt:r.t_pmt,is_interest_date:r.is_interest_date,is_repay_date:r.is_repay_date,is_fixing_date:r.is_fixing_date,is_condition_date:r.is_condition_date,accrual_factor:r.accrual_factor,current_principal:n,fwd_rate:i,interest_current_period:s,accrued_interest:o,pmt_principal:l,pmt_interest:_,pmt_total:u}},b.fixed_income.prototype.get_cash_flows=function(e){if(this.is_float){if("object"!=typeof e||null===e)throw new Error("fixed_income.get_cash_flows: Must provide forward curve when evaluating floating rate interest stream");return this.finalize_cash_flows(e)}return this.cash_flows},b.fixed_income.prototype.present_value=function(e,t,r){if("object"!=typeof e||null===e)throw new Error("fixed_income.present value: Must provide discount curve when evaluating interest stream");if(this.is_float&&("object"!=typeof r||null===r))throw new Error("fixed_income.present value: Must provide forward curve when evaluating floating rate interest stream");return b.dcf(this.get_cash_flows(b.get_safe_curve(r)||null),b.get_safe_curve(e),t?b.get_safe_curve(t):null,this.residual_spread,this.settlement_date)},b.fixed_income.prototype.fair_rate_or_spread=function(e,t,r){b.require_vd();for(var a,n=b.get_safe_curve(r)||b.get_const_curve(0),i=this.finalize_cash_flows(n),s=0;i.date_pmt[s]<=b.valuation_date;)s++;a=i.current_principal[s];var o=new Array(i.pmt_total.length),l=0;for(s=0;s<o.length;s++)o[s]=i.pmt_principal[s],l+=i.current_principal[s]*i.accrual_factor[s]*i.fwd_rate[s],i.is_interest_date[s]&&(o[s]+=l,l=0);var _=a-b.dcf({date_pmt:i.date_pmt,t_pmt:i.t_pmt,pmt_total:o},b.get_safe_curve(e),b.get_safe_curve(t),this.residual_spread,this.settlement_date);return _/=this.annuity(e,t,n)},b.fixed_income.prototype.annuity=function(e,t,r){var a,n=this.get_cash_flows(b.get_safe_curve(r)||b.get_const_curve(0)),i=new Array(n.pmt_total.length),s=0;for(a=0;a<i.length;a++)i[a]=0,s+=n.current_principal[a]*n.accrual_factor[a],n.is_interest_date[a]&&(i[a]+=s,s=0);return b.dcf({date_pmt:n.date_pmt,t_pmt:n.t_pmt,pmt_total:i},b.get_safe_curve(e),b.get_safe_curve(t),this.residual_spread,this.settlement_date)},b.pricer_bond=function(e,t,r){return new b.fixed_income(e).present_value(t,r,null)},b.pricer_floater=function(e,t,r,a){return new b.fixed_income(e).present_value(t,r,a)}}(this.JsonRisk||module.exports),function(r){r.fxterm=function(e){this.near_leg=new r.fixed_income({notional:e.notional,maturity:e.maturity,fixed_rate:0,tenor:0}),"number"==typeof e.notional_2&&r.get_safe_date(e.maturity_2)?this.far_leg=new r.fixed_income({notional:e.notional_2,maturity:e.maturity_2,fixed_rate:0,tenor:0}):this.far_leg=null},r.fxterm.prototype.present_value=function(e){var t=0;return t+=this.near_leg.present_value(e,null,null),this.far_leg&&(t+=this.far_leg.present_value(e,null,null)),t},r.pricer_fxterm=function(e,t){return new r.fxterm(e).present_value(t)}}(this.JsonRisk||module.exports),function(A){"use strict";function y(e){return e}function j(e,t,r,a,n){var i,s=new Array(e.t_pmt.length+1),o=0;"number"!=typeof n&&(n=0);for(var l=!a&&0===n;e.t_pmt[o]<=0;)o++;for(;o<e.t_pmt.length;)l?s[o]=r.get_df(e.t_pmt[o]):(i=r.get_rate(e.t_pmt[o]),a&&(i+=a.get_rate(e.t_pmt[o])),i+=n,s[o]=Math.pow(1+i,-e.t_pmt[o])),o++;return l?s[o]=r.get_df(t):(i=r.get_rate(t),a&&(i+=a.get_rate(t)),i+=n,s[o]=Math.pow(1+i,-t)),s}function b(e,t,r,a){if(!a)return 0;for(var n=0,i=0;e.t_pmt[n]<=t;)n++;for(;n<e.t_pmt.length;)i+=e.current_principal[n]*r[n]*a*(e.t_pmt[n]-Math.max(e.t_pmt[n-1],t)),n++;return i/=r[r.length-1]}A.lgm_dcf=function(e,t,r,a,n,i){if(!n.length)throw new Error("lgm_dcf: state variable must be an array of numbers");for(var s,o,l,_,u=0,f=new Float64Array(n.length),c=e.t_pmt,d=e.pmt_total;c[u]<=t;)u++;var h=0;e.pmt_interest&&(h=0===u?0:e.pmt_interest[u]*(t-c[u-1])/(c[u]-c[u-1]));var g=b(e,t,r,i);for(l=-(e.current_principal[u]+h+g)*r[r.length-1],s=0;s<n.length;s++)f[s]=l;for(;u<c.length;){if(o=y(e.t_pmt[u])-y(t),0!==(l=d[u]*r[u]))for(_=o*o*a*.5,s=0;s<n.length;s++)f[s]+=l*Math.exp(-o*n[s]-_);u++}return f},A.lgm_european_call_on_cf=function(t,r,a,n,i,s,o,e){var l=e||j(t,r,a,i,s);if(r<0)return 0;if(r<1/512||n<1e-10)return Math.max(0,A.lgm_dcf(t,r,l,0,[0],o)[0]);var _,u=Math.sqrt(n),f=y(r+1/365)-y(r);function c(e){return A.lgm_dcf(t,r,l,n,[e],o)[0]}if(20/f<u)_=-10*(u=20/f);else{var d,h;if(0<=c(0)){if((d=0)<c(h=u*D))return A.lgm_dcf(t,r,l,0,[0],o)[0]}else if(h=0,c(d=-u*D)<0)return 0;try{_=A.find_root_ridders(c,h,d,20)}catch(e){return A.lgm_bermudan_call_on_cf(t,[r],a,[n],i,s,o)}}for(var g=0,p=1/u;t.t_pmt[g]<=r;)g++;var m=0;t.pmt_interest&&(m=0===g?0:t.pmt_interest[g]*(r-t.t_pmt[g-1])/(t.t_pmt[g]-t.t_pmt[g-1]));for(var v=b(t,r,l,o),w=-(t.current_principal[g]+m+v)*l[l.length-1]*A.cndf(_*p);g<t.t_pmt.length;)f=y(t.t_pmt[g])-y(r),w+=t.pmt_total[g]*l[g]*A.cndf(_*p+f*u),g++;return w},A.lgm_european_swaption_adjusted_cashflow=function(e,t,r,a){var n,i=e.swap.fair_rate(t,t);if(a)n=i;else{var s=e.swap.fair_rate(t,r);n=e.swap.fixed_rate-s+i}var o=e.swap.fixed_leg.finalize_cash_flows(null,n);return o.pmt_total[0]-=o.current_principal[1],o.pmt_total[o.pmt_total.length-1]+=o.current_principal[o.pmt_total.length-1],o},A.lgm_european_swaption=function(e,t,r,a,n){var i=A.lgm_european_swaption_adjusted_cashflow(e,r,n);return A.lgm_european_call_on_cf(i,t,r,a,null,null,null)},A.lgm_calibrate=function(e,t,r,a){A.require_vd();var n,i,s,o,l,_,u,f,c,d,h,g,p,m=[],v=function(e){return A.lgm_european_call_on_cf(i,l,t,e,null,null,null,s)-u};for(c=0;c<e.length;c++)if(A.time_from_now(e[c].first_exercise_date)>1/512){for(l=A.time_from_now(e[c].first_exercise_date),A.time_from_now(e[c].maturity),i=A.lgm_european_swaption_adjusted_cashflow(e[c],t,r,!1),s=j(i,l,t,null,null),d=_=0;d<i.t_pmt.length;d++)_+=i.pmt_total[d]*s[d]*(y(i.t_pmt[d])-y(l));if(u=e[c].present_value(t,r,a),o=e[c].std_dev,n=Math.pow(o*e[c].swap.annuity(t)/_,2),g=(h=A.lgm_dcf(i,l,s,0,[0],null)[0])+e[c].swap.fixed_leg.notional*s[s.length-1],h<0&&(h=0),(u=e[c].present_value(t,r,a))<=h+(p=1e-7*u+1e-7)||0===n)n=0;else{for(g<u&&(u=g),f=v(n),d=10;f<0&&0<d;)d--,f=v(n*=2);try{n=A.find_root_ridders(v,0,n,20,p)}catch(e){Math.abs(u-h)<Math.abs(f)&&(n=0)}}0<m.length&&m[m.length-1]>n&&(n=m[m.length-1]),m.push(n)}return m};var D=4;A.lgm_bermudan_call_on_cf=function(e,t,r,a,n,i,s){if(t[t.length-1]<0)return 0;if(t[t.length-1]<1/512)return A.lgm_european_call_on_cf(e,t[t.length-1],r,0,n,i,s);function o(){var e=new Float64Array(2*D*15+1);for(e[0]=-D*h,f=1;f<b;f++)e[f]=e[f-1]+g;return e}function l(){var e=0;for(f=0;f<b;f++)M[f]=Math.max(E[f],w[f],0),!e&&0<f&&(w[f]-E[f])*(w[f-1]-E[f-1])<0&&(e=f);if(e){var t=M[e-1],r=M[e],a=Math.min(w[e-1],E[e-1]),n=Math.min(w[e],E[e]),i=(t-a)/(r-n+t-a),s=.25*(i*(r-n)+(1-i)*(t-a));M[e]-=i*s,M[e-1]-=(1-i)*s}}function _(e){if(x-d<1e-12)return M[e];for(var t,r=0,a=0,n=1/Math.sqrt(x-d),i=p*n,s=0,o=(v[0]-m[e]+.5*p)*n;o<-D;)o+=i,s+=1;for(;o<D&&!(b<=s);)t=A.fast_cndf(o),r+=M[s]*(t-a),a=t,o+=i,s++;return r}var u,f,c,d,h,g,p,m,v,w,y,b=2*D*15+1,x=0,M=new Float64Array(b),E=new Float64Array(b);for(c=a.length-1;0<=c;){if(d=a[c],h=Math.sqrt(d),g=h/15,m=o(),y=j(e,t[c],r,n,i),w=A.lgm_dcf(e,t[c],y,d,m,s),c<a.length-1)for(u=0;u<b;u++)E[u]=_(u);else for(u=0;u<b;u++)E[u]=0;l(),x=d,v=m,p=g,c--}return m=[0],E=_(d=0)}}(this.JsonRisk||module.exports),function(a){"use strict";var n=Math.sqrt(4*Math.acos(0));a.get_safe_number=function(e){if("number"==typeof e)return e;if("string"!=typeof e)return null;e=e.trim();var t=parseFloat(e);return isNaN(t)?null:("%"===e.charAt(e.length-1)&&(t*=.01),t)},a.get_safe_positive=function(e){var t=a.get_safe_number(e);return t<=0?null:t},a.get_safe_natural=function(e){var t=a.get_safe_number(e);return t<0||t!==Math.floor(t)?null:t},a.get_safe_number_vector=function(e){if("number"==typeof e)return[e];var t;if("string"==typeof e)t=e.split(/\s+/);else{if(!Array.isArray(e))return null;t=e.slice()}for(var r=0;r<t.length;r++)if(t[r]=a.get_safe_number(t[r]),null===t[r])throw new Error("get_safe_number_vector: invalid input");return t},a.get_safe_bool=function(e){if("boolean"==typeof e)return e;if("number"==typeof e)return 0!==e;if("string"!=typeof e)return!1;var t=e.trim().toLowerCase();return"true"===t||"yes"===t||"t"===t||"y"===t},a.get_safe_bool_vector=function(e){if("boolean"==typeof e)return[e];if("number"==typeof e)return[0!==e];var t;if("string"==typeof e)t=e.split(/\s+/);else{if(!Array.isArray(e))return[!1];t=e.slice()}for(var r=0;r<t.length;r++)t[r]=a.get_safe_bool(t[r]);return t},a.ndf=function(e){return Math.exp(-e*e/2)/n},a.cndf=function(e){var t,r=Math.abs(e);if(r<=37){var a=Math.exp(-r*r/2);if(r<7.07106781186547)t=a*((((((.0352624965998911*r+.700383064443688)*r+6.37396220353165)*r+33.912866078383)*r+112.079291497871)*r+221.213596169931)*r+220.206867912376)/(((((((.0883883476483184*r+1.75566716318264)*r+16.064177579207)*r+86.7807322029461)*r+296.564248779674)*r+637.333633378831)*r+793.826512519948)*r+440.413735824752);else t=a/(n*(r+1/(r+2/(r+3/(r+4/(r+.65))))))}else{if(!(37<r))throw new Error("cndf: invalid input.");t=0}return e<=0?t:1-t};a.fast_cndf=function(e){var t=0<e?e:-e,r=1+t*(.049867347+t*(.0211410061+t*(.0032776263+t*(380036e-10+t*(488906e-10+5383e-9*t)))));return r*=r,r*=r,r*=r,r=.5/(r*=r),0<=e?1-r:r},a.find_root_secant=function(e,t,r,a,n){var i=t,s=r,o=0,l=a||20,_=n||1e-8,u=e(i),f=e(s);for(Math.abs(f)>Math.abs(u)&&(o=i,i=s,s=o,o=u,u=f,f=o);Math.abs(f)>_&&0<l;)o=(i-s)*f/(f-u),u=f,f=e(s=(i=s)+o),l--;if(l<=0)throw new Error("find_root_secant: failed, too many iterations");if(isNaN(s))throw new Error("find_root_secant: failed, invalid result");return s},a.find_root_ridders=function(e,t,r,a,n){var i,s,o,l=t,_=r,u=0,f=0,c=0,d=a||20,h=n||1e-8,g=e(l),p=e(_);if(0<g*p)throw new Error("find_root_ridders: start values do not bracket the root");if(Math.abs(g)<h)return l;if(Math.abs(p)<h)return _;for(;0<d;){if(d--,u=.5*(l+_),Math.abs(l-_)<1e-15)return u;if(i=e(u),Math.abs(i)<h)return u;if(0===(c=Math.sqrt(i*i-p*g)))return u;if(f=(u-l)*(0<(o=g-p)?1:o<0?-1:0)*i/c+u,isNaN(f)&&(f=u),s=e(f),Math.abs(s)<h)return f;i*s<0?(l=f,g=s,_=u,p=i):g*s<0?(_=f,p=s):p*s<0&&(l=f,g=s)}if(d<=0)throw new Error("find_root_ridders: failed, too many iterations")}}(this.JsonRisk||module.exports),function(a){a.get_safe_scalar=function(e){if("object"!=typeof e)throw new Error("get_safe_scalar: must provide object");var t=a.get_safe_number(e.value);if(null===t)throw new Error("get_safe_scalar: must provide object with scalar value property");if("object"==typeof e._rule){var r=e._rule.values[0][0];"multiplicative"===e._rule.model&&(t*=r),"additive"===e._rule.model&&(t+=r),"absolute"===e._rule.model&&(t=r)}return e.get_value=function(){return t},e}}(this.JsonRisk||module.exports),function(_){"use strict";var u=function(e,t,r,a){for(var n=[e],i=1,s=_.add_months(e,r);s.getTime()<t.getTime();)n.push(s),i++,s=_.add_months(e,i*r);return a(t).getTime()<=a(n[n.length-1]).getTime()&&n.pop(),n},f=function(e,t,r,a){for(var n=[t],i=1,s=_.add_months(t,-r);s.getTime()>e.getTime();)n.unshift(s),i++,s=_.add_months(t,-i*r);return a(e).getTime()>=a(n[0]).getTime()&&n.shift(),n};_.schedule=function(e,t,r,a,n,i,s,o){if(!(t instanceof Date))throw new Error("schedule: maturity must be provided");if(isNaN(t))throw new Error("schedule: invalid date provided for maturity");if(!(e instanceof Date)){if(null===_.valuation_date)throw new Error("schedule: if valuation_date is unset, effective date must be provided");if(n instanceof Date)throw new Error("schedule: if first date is provided, effective date must be provided");if(!(i instanceof Date)&&s)throw new Error("schedule: if next to last date is not provided and stub in the end is specified, effective date must be provided")}if(e instanceof Date&&isNaN(e))throw new Error("schedule: invalid date provided for effective date");if(t<=(e instanceof Date?e:_.valuation_date))throw new Error("schedule: maturity is before valuation date or effective date.");if("number"!=typeof r)throw new Error("schedule: tenor must be a nonnegative integer, e.g., 6 for semiannual schedule, 0 for zerobond/iam schedule");if(r<0||Math.floor(r)!==r)throw new Error("schedule: tenor must be a nonnegative integer, e.g., 6 for semiannual schedule, 0 for zerobond/iam schedule");return 0===r?[e instanceof Date?e:_.valuation_date,t]:(n instanceof Date&&!(i instanceof Date)?((l=u(n,t,r,a)).push(t),e.getTime()!==n.getTime()&&l.unshift(e)):i instanceof Date&&!(n instanceof Date)?(l=f(e instanceof Date?e:_.valuation_date,i,r,a),t.getTime()!==i.getTime()&&l.push(t),e instanceof Date&&l.unshift(e),e instanceof Date||l.unshift(_.add_months(l[0],-r))):n instanceof Date&&i instanceof Date?(l=f(n,i,r,a),t.getTime()!==i.getTime()&&l.push(t),l.unshift(n),l.unshift(e)):s?(l=u(e,t,r,a),o&&1<l.length&&l.pop(),l.push(t)):(l=f(e instanceof Date?e:_.valuation_date,t,r,a),o&&1<l.length&&l.shift(),e instanceof Date&&l.unshift(e),e instanceof Date||l.unshift(_.add_months(l[0],-r))),l);var l}}(this.JsonRisk||module.exports),function(c){function f(e,t){if(e.terms)return e.terms[t];if(e.labels_term)return c.period_str_to_time(e.labels_term[t]);throw new Error("get_term_at: invalid surface, cannot derive terms")}function u(e,t){if(e.expiries)return e.expiries[t];if(e.labels_expiry)return c.period_str_to_time(e.labels_expiry[t]);throw new Error("get_expiry_at: invalid surface, cannot derive expiries")}function d(e,t,r){var a=0,n=(e.terms||e.labels_term||[]).length-1,i=e.values[t];if(!Array.isArray(i))throw new Error("get_slice_rate: invalid surface, values property must be an array of arrays");if(a===n)return i[a];var s,o,l=f(e,a),_=f(e,n);if(r<f(e,a))return i[a];if(r>f(e,n))return i[n];for(;a+1!==n;)(o=f(e,s=(a+n)/2|0))<r?(l=o,a=s):(_=o,n=s);if(_-l<1/512)throw new Error("get_slice_rate: invalid surface, support points must be increasing and differ at least one day");var u=1/(_-l);return(i[a]*(_-r)+i[n]*(r-l))*u}function n(e,t,r){var a=0,n=(e.expiries||e.labels_expiry||[]).length-1;if(a===n)return d(e,a,r);var i,s,o=u(e,a),l=u(e,n);if(t<o)return d(e,a,r);if(l<t)return d(e,n,r);for(;a+1!==n;)(s=u(e,i=(a+n)/2|0))<t?(o=s,a=i):(l=s,n=i);if(l-o<1/512)throw new Error("get_surface_rate: invalid surface, support points must be increasing and differ at least one day");var _=1/(l-o);return(d(e,a,r)*(l-t)+d(e,n,r)*(t-o))*_}c.get_const_surface=function(e,t){if("number"!=typeof e)throw new Error("get_const_surface: input must be number.");return c.get_safe_surface({type:t||"",expiries:[1],terms:[1],values:[[e]]})},c.get_safe_surface=function(r){if(!r)return c.get_const_surface(0);var a=null;if("object"==typeof r._rule){if((a={labels_expiry:r._rule.labels_y,labels_term:r._rule.labels_x,values:r._rule.values}).labels_expiry.length!==a.values.length)throw new Error("get_safe_surface: length of scenario labels_y must match length of scenario values outer array");if(a.labels_term.length!==a.values[0].length)throw new Error("get_safe_surface: length of scenario labels_x must match length of scenario values inner arrays");"multiplicative"===r._rule.model&&(r.get_rate=function(e,t){return n(r,e,t)*n(a,e,t)}),"additive"===r._rule.model&&(r.get_rate=function(e,t){return n(r,e,t)+n(a,e,t)}),"absolute"===r._rule.model&&(r.get_rate=function(e,t){return n(a,e,t)})}else r.get_rate=function(e,t){return n(r,e,t)};if(r.moneyness&&r.smile){if(!r.moneyness.length||!r.smile.length)throw new Error("get_cube_rate: invalid cube, moneyness and smile must be arrays");for(var e=0;e<r.smile.length;e++)c.get_safe_surface(r.smile[e])}return r},c.get_surface_rate=function(e,t,r){return e.get_rate instanceof Function?e.get_rate(t,r):c.get_safe_surface(e).get_rate(t,r)},c.get_cube_rate=function(e,t,r,a){var n=c.get_surface_rate(e,t,r);if(e.moneyness&&e.smile){if(!e.moneyness.length||!e.smile.length)throw new Error("get_cube_rate: invalid cube, moneyness and smile must be arrays");var i=0,s=e.moneyness.length-1;if(i===s)return n+c.get_surface_rate(e.smile[i],t,r);var o,l,_=e.moneyness[i],u=e.moneyness[s];if(a<_)return n+c.get_surface_rate(e.smile[i],t,r);if(u<a)return n+c.get_surface_rate(e.smile[s],t,r);for(;i+1!==s;)o=(i+s)/2|0,(l=e.moneyness[o])<a?(_=l,i=o):(u=l,s=o);if(u-_<1e-15)throw new Error("get_cube_rate: invalid cube, moneyness must be nondecreasing");var f=1/(u-_);return n+(c.get_surface_rate(e.smile[i],t,r)*(u-a)+c.get_surface_rate(e.smile[s],t,r)*(a-_))*f}return n}}(this.JsonRisk||module.exports),function(a){a.swap=function(e){this.phi=a.get_safe_bool(e.is_payer)?-1:1,this.fixed_rate=e.fixed_rate,this.fixed_leg=new a.fixed_income({notional:e.notional*this.phi,notional_exchange:!1,maturity:e.maturity,fixed_rate:e.fixed_rate,tenor:e.tenor,effective_date:e.effective_date,calendar:e.calendar,bdc:e.bdc,dcc:e.dcc}),this.float_leg=new a.fixed_income({notional:-e.notional*this.phi,notional_exchange:!1,maturity:e.maturity,float_spread:e.float_spread,tenor:e.float_tenor,effective_date:e.effective_date,calendar:e.calendar,bdc:e.float_bdc,dcc:e.float_dcc,float_current_rate:e.float_current_rate})},a.swap.prototype.fair_rate=function(e,t){var r=this.float_leg.present_value(e,null,t);return 0===r?0:-this.phi*r/this.annuity(e)},a.swap.prototype.annuity=function(e){return this.fixed_leg.annuity(e)*this.phi},a.swap.prototype.present_value=function(e,t){var r=0;return r+=this.fixed_leg.present_value(e,null,null),r+=this.float_leg.present_value(e,null,t)},a.swap.prototype.get_cash_flows=function(e){return{fixed_leg:this.fixed_leg.get_cash_flows(),float_leg:this.float_leg.get_cash_flows(e)}},a.pricer_swap=function(e,t,r){return new a.swap(e).present_value(t,r)}}(this.JsonRisk||module.exports),function(x){x.swaption=function(e){if(this.sign=x.get_safe_bool(e.is_short)?-1:1,this.maturity=x.get_safe_date(e.maturity),!this.maturity)throw new Error("swaption: must provide valid maturity date.");if(this.first_exercise_date=x.get_safe_date(e.first_exercise_date),!this.first_exercise_date)throw new Error("swaption: must provide valid first_exercise_date date.");this.swap=new x.swap({is_payer:e.is_payer,notional:e.notional,effective_date:this.first_exercise_date,maturity:e.maturity,fixed_rate:e.fixed_rate,tenor:e.tenor,calendar:e.calendar,bdc:e.bdc,dcc:e.dcc,float_spread:e.float_spread,float_tenor:e.float_tenor,float_bdc:e.float_bdc,float_dcc:e.float_dcc,float_current_rate:e.float_current_rate})},x.swaption.prototype.present_value=function(e,t,r){x.require_vd();var a,n=x.time_from_now(this.maturity),i=x.time_from_now(this.first_exercise_date),s=n-i;if(s<1/512)return 0;if(this.fair_rate=this.swap.fair_rate(e,t),this.moneyness=this.swap.fixed_rate-this.fair_rate,"object"!=typeof r||null===r)throw new Error("swaption.present_value: must provide valid surface");if(this.vol=x.get_cube_rate(r,i,s,this.moneyness),this.std_dev=this.vol*Math.sqrt(i),i<0)return 0;if(i<1/512||this.std_dev<1e-4)a=Math.max(this.swap.phi*this.moneyness,0);else{var o=this.moneyness/this.std_dev;a=this.swap.phi*this.moneyness*x.cndf(this.swap.phi*o)+this.std_dev*x.ndf(o)}return a*=this.swap.annuity(e),a*=this.sign},x.pricer_swaption=function(e,t,r,a){return new x.swaption(e).present_value(t,r,a)},x.create_equivalent_regular_swaption=function(e,t,r){if(void 0===e.date_pmt||void 0===e.pmt_total||void 0===e.current_principal)throw new Error("create_equivalent_regular_swaption: invalid cashflow object");if(e.t_pmt.length!==e.pmt_total.length||e.t_pmt.length!==e.current_principal.length)throw new Error("create_equivalent_regular_swaption: invalid cashflow object");x.require_vd(),r||(r={});for(var a,n=r.tenor||6,i=r.bdc||"unadjusted",s=r.calendar||"",o=0;e.date_pmt[o]<=t;)o++;if(0===(a=e.current_principal[o]))throw new Error("create_equivalent_regular_swaption: invalid cashflow object or first_exercise_date, zero outstanding principal");var l=x.irr(e,t,-a);l=12/n*(Math.pow(1+l,n/12)-1);var _=x.time_from_now(t),u=x.get_const_curve(l+1e-4),f=x.get_const_curve(l-1e-4),c=x.dcf(e,u,null,null,t);c/=u.get_df(_);var d=x.dcf(e,f,null,null,t),h=1e4*((d/=f.get_df(_))-c)/(d+c),g=function(e){var t=new x.fixed_income(e);return c=t.present_value(u),c/=u.get_df(_),d=t.present_value(f),1e4*((d/=f.get_df(_))-c)/(d+c)},p=Math.abs(l)<1e-8?h:-Math.log(1-h*l)/l;p<1/365&&(p=1/365);for(var m=p,v=x.add_days(t,Math.round(365*m)),w={maturity:v,effective_date:t,settlement_date:x.adjust(t,i,x.is_holiday_factory(s)),notional:a,fixed_rate:l,tenor:n,calendar:s,bdc:i},y=g(w),b=10;Math.abs(y-h)>1/512&&0<b;)m=m*h/y,(isNaN(m)||1e3<m||m<1/512)&&(m=p),v=x.add_days(t,Math.round(365*m)),w.maturity=v,y=g(w),b--;return{is_payer:!1,maturity:v,first_exercise_date:t,effective_date:t,settlement_date:t,notional:a,fixed_rate:l,tenor:n,float_spread:0,float_tenor:r.float_tenor||6,float_current_rate:0,calendar:s,bdc:i,float_bdc:i}}}(this.JsonRisk||module.exports),function(l){"use strict";var _=1/864e5;function i(e){return e%4==0&&(2e3===e||e%100!=0)}function u(e,t){return new Date(e,t+1,0).getDate()}function s(e,t){return Math.round((t-e)*_)}function t(e,t){return s(e,t)/365}function r(e,t){return s(e,t)/360}function a(e,t){var r=e.getFullYear(),a=t.getFullYear(),n=e.getMonth(),i=t.getMonth(),s=Math.min(e.getDate(),30),o=t.getDate();return 29<s&&31==o&&(o=30),(360*(a-r)+30*(i-n)+(o-s))/360}function n(e,t){var r=e.getFullYear(),a=t.getFullYear(),n=e.getMonth(),i=t.getMonth(),s=Math.min(e.getDate(),30);return(360*(a-r)+30*(i-n)+(Math.min(t.getDate(),30)-s))/360}function o(e,t){var r=e.getFullYear(),a=t.getFullYear(),n=e.getMonth(),i=t.getMonth(),s=Math.min(e.getDate(),30),o=Math.min(t.getDate(),30);return 1==n&&s==u(r,n)&&(s=30),1==i&&o==u(a,i)&&(o=30),(360*(a-r)+30*(i-n)+(o-s))/360}function f(e,t){if(e-t==0)return 0;if(t<e)return-f(t,e);var r=e.getFullYear(),a=t.getFullYear();if(r===a)return s(e,t)/(i(r)?366:365);var n=a-r-1;return n+=s(e,new Date(r+1,0,1))/(i(r)?366:365),n+=s(new Date(a,0,1),t)/(i(a)?366:365)}function c(e){var t=e.getDay();return 0===t||6===t}function d(e){if(c(e))return!0;var t=e.getDate(),r=e.getMonth();if(1===t&&0===r)return!0;if(25===t&&11===r)return!0;var a=e.getFullYear();if((1998===a||1999===a||2001===a)&&31===t&&11===r)return!0;if(2e3<a){if(1===t&&4===r||26===t&&11===r)return!0;var n=function(e){var t=Math.floor,r=t(e/100),a=e-19*t(e/19),n=t((r-17)/25),i=r-t(r/4)-t((r-n)/3)+19*a+15;i-=30*t(i/30),i-=t(i/28)*(1-t(i/28)*t(29/(i+1))*t((21-a)/11));var s=e+t(e/4)+i+2-r+t(r/4),o=i-(s-=7*t(s/7)),l=3+t((o+40)/44),_=o+28-31*t(l/4);return new Date(e,l-1,_)}(a);if(e.getTime()===l.add_days(n,-2).getTime())return!0;if(e.getTime()===l.add_days(n,1).getTime())return!0}return!1}l.period_str_to_time=function(e){var t=parseInt(e,10);if(isNaN(t))throw new Error("period_str_to_time(str) - Invalid time period string: "+e);var r=e.charAt(e.length-1);if("Y"===r||"y"===r)return t;if("M"===r||"m"===r)return t/12;if("W"===r||"w"===r)return t/52;if("D"===r||"d"===r)return t/365;throw new Error("period_str_to_time(str) - Invalid time period string: "+e)},l.date_str_to_date=function(e){var t,r,a,n=null;if(null!==(n=/^([1-2][0-9]{3})[\/-]([0-9]{1,2})[\/-]([0-9]{1,2})/.exec(e))?(a=parseInt(n[1],10),r=parseInt(n[2],10)-1,t=parseInt(n[3],10)):null!==(n=/^([0-9]{1,2})\.([0-9]{1,2})\.([1-2][0-9]{3})/.exec(e))&&(a=parseInt(n[3],10),r=parseInt(n[2],10)-1,t=parseInt(n[1],10)),null===n)throw new Error("date_str_to_time(str) - Invalid date string: "+e);if(r<0||11<r)throw new Error("date_str_to_time(str) - Invalid month in date string: "+e);if(t<0||t>u(a,r))throw new Error("date_str_to_time(str) - Invalid day in date string: "+e);return new Date(a,r,t)},l.get_safe_date=function(e){if(!e)return null;if(e instanceof Date)return e;if(e instanceof String||"string"==typeof e)return l.date_str_to_date(e);throw new Error("get_safe_date: invalid input.")},l.get_safe_date_vector=function(e){if(e instanceof Date)return[e];var t;if("string"==typeof e)t=e.split(/\s+/);else{if(!Array.isArray(e))return null;t=e.slice()}for(var r=0;r<t.length;r++)if(t[r]=l.get_safe_date(t[r]),null===t[r])throw new Error("get_safe_date_vector: invalid input");return t},l.year_fraction_factory=function(e){if(!(e instanceof String)&&"string"!=typeof e)return t;if(""===e)return t;switch(e.toLowerCase()){case"actual/365":case"act/365":case"a/365":case"act/365 (fixed)":case"actual/365 (fixed)":return t;case"actual/360":case"act/360":case"a/360":case"french":return r;case"actual/actual":case"act/act":case"a/a":return f;case"30/360":case"30u/360":case"bond":case"bond basis":return a;case"30e/360":case"eurobond":case"eurobond basis":return n;case"30g/360":case"30e/360 (isda)":case"30/360 german":return o;default:throw new Error("year fraction factory: invalid input "+e)}},l.time_from_now=function(e){return l.require_vd(),t(l.valuation_date,e)},l.add_days=function(e,t){return new Date(e.getFullYear(),e.getMonth(),e.getDate()+t)},l.add_months=function(e,t,r){for(var a,n=e.getFullYear(),i=e.getMonth()+t;12<=i;)i-=12,n+=1;for(;i<0;)i+=12,n-=1;return a=r||e.getDate(),new Date(n,i,Math.min(a,u(n,i)))},l.add_period=function(e,t){var r=parseInt(t,10);if(isNaN(r))throw new Error("period_str_to_time(str) - Invalid time period string: "+t);var a=t.charAt(t.length-1);if("Y"===a||"y"===a)return l.add_months(e,12*r);if("M"===a||"m"===a)return l.add_months(e,r);if("W"===a||"w"===a)return l.add_days(e,7*r);if("D"===a||"d"===a)return l.add_days(e,r);throw new Error("period_str_to_time(str) - Invalid time period string: "+t)};var h={};l.add_calendar=function(e,t){if(!(e instanceof String||"string"==typeof e))throw new Error("add_calendar: invalid input.");if(!Array.isArray(t))throw new Error("add_calendar: invalid input.");var r,a,n,i=t.length,s=[];for(r=0;r<i;r++)(n=l.get_safe_date(t[r]))&&(c(n)||s.push(n));for(i=s.length,r=1;r<41&&!(i/10<=(a=r*r-r+41));)r++;var o=new Array(a);for(r=0;r<a;r++)o[r]=[];for(r=0;r<i;r++)o[Math.floor(s[r].getTime()*_)%a].push(s[r].getTime());return h[e.toLowerCase()]=o,a},l.is_holiday_factory=function(e){var t=e.toLowerCase();if("target"===t)return d;if(Array.isArray(h[t])){var n=h[t];return function(e){if(c(e))return!0;for(var t=e.getTime(),r=Math.floor(t*_)%n.length,a=0;a<n[r].length;a++)if(t===n[r][a])return!0;return!1}}if(""===t)return c;throw new Error("is_holiday_factory: calendar not found: "+t)},l.adjust=function(e,t,r){if(!(t instanceof String)&&"string"!=typeof t)return e;var a,n=(t||"u").charAt(0).toLowerCase(),i=new Date(e);if("u"===n)return i;if("m"===n&&(a=i.getMonth()),"m"===n||"f"===n)for(;r(i);)i=l.add_days(i,1);if("f"===n)return i;if("m"===n&&a===i.getMonth())return i;for("m"===n&&(i=l.add_days(i,-1));r(i);)i=l.add_days(i,-1);return i},l.add_business_days=function(e,t,r){for(var a=e,n=t;0<n;)a=l.adjust(l.add_days(a,1),"f",r),n--;return a}}(this.JsonRisk||module.exports),function(d){var h=null,g=function(e,t){var r=d.get_curve_times(e),a=e.dfs?Array.isArray(e.dfs[0])?e.dfs:[e.dfs]:null,n=e.zcs?Array.isArray(e.zcs[0])?e.zcs:[e.zcs]:null;if(!a){a=new Array(n.length);for(var i=0;i<n.length;i++){a[i]=new Array(n[i].length);for(var s=0;s<n[i].length;s++)a[i][s]=Math.pow(1+n[i][s],-r[s])}}return{name:t||null,tags:e.tags||null,times:r,dfs:a}},p=function(e){if(1!==e)if(1!==h.vector_length){if(e!==h.vector_length)throw new Error("vector_pricing: provided parameters need to have the same length or length one")}else h.vector_length=e},f=function(e,t){var r=t.name||null,a=t.tags||[];if(delete t._rule,0===e)return!1;var n=h.scenario_groups;if(0===n.length)return!1;for(var i=1,s=0,o=0;i<e;)if(i++,o<n[s].length)o++;else{if(!(s<n.length))return!1;o=0,s++}for(var l,_=n[s][o].rules,u=0;u<_.length;u++){if(l=_[u],Array.isArray(l.risk_factors)&&-1<l.risk_factors.indexOf(r))return t._rule=l,!0;if(Array.isArray(l.tags)){var f=!0;for(i=0;i<l.tags.length;i++)-1===a.indexOf(l.tags[i])&&(f=!1);if(f)return t._rule=l,!0}}return!1};function i(e){var t=e.toLowerCase();if(t.endsWith("atm"))return 0;var r=t.match(/([+-][0-9]+)bp$/);return r.length<2?null:r[1]/1e4}function m(e,t){for(var r,a=[],n=0;n<t.length;n++)t[n].startsWith(e)&&t[n].length!==e.length&&null!==(r=i(t[n]))&&a.push({name:t[n],moneyness:r});return a.sort(function(e,t){return e.moneyness-t.moneyness}),a}d.store_params=function(e){var t,r,a,n,i,s,o,l,_,u,f;if((h={vector_length:1,scalars:{},curves:{},surfaces:{},scenario_groups:[]}).valuation_date=d.get_safe_date(e.valuation_date),"object"==typeof e.scalars)for(t=Object.keys(e.scalars),r=0;r<t.length;r++)h.scalars[t[r]]=(a=e.scalars[t[r]],n=t[r],{value:Array.isArray(a.value)?a.value:[a.value],tags:a.tags||null,name:n||null}),p(h.scalars[t[r]].value.length);if("object"==typeof e.curves)for(t=Object.keys(e.curves),r=0;r<t.length;r++)i=g(e.curves[t[r]],t[r]),s=(h.curves[t[r]]=i).dfs?i.dfs.length:i.zcs.length,p(s);if("object"==typeof e.surfaces){for(t=Object.keys(e.surfaces),r=0;r<t.length;r++)h.surfaces[t[r]]=(_=e.surfaces[t[r]],u=t[r],Object.assign({},_,{name:u||null,values:Array.isArray(_.values[0][0])?_.values:[_.values]})),p(h.surfaces[t[r]].values.length);for(r=0;r<t.length;r++)if(0<(o=m(t[r],t)).length)for(h.surfaces[t[r]].smile=[],h.surfaces[t[r]].moneyness=[],l=0;l<o.length;l++)h.surfaces[t[r]].smile.push(h.surfaces[o[l].name]),h.surfaces[t[r]].moneyness.push(o[l].moneyness)}if("object"==typeof e.calendars)for(t=Object.keys(e.calendars),r=0;r<t.length;r++)f=e.calendars[t[r]],d.add_calendar(t[r],f.dates);if(Array.isArray(e.scenario_groups)){h.scenario_groups=e.scenario_groups;var c=0;for(r=0;r<e.scenario_groups.length;r++){if(!Array.isArray(e.scenario_groups[r]))throw new Error("vector_pricing: invalid parameters, scenario groups must be arrays.");c+=e.scenario_groups[r].length}p(c+1)}},d.get_params=function(){return h},d.set_params=function(e){if("object"!=typeof e)throw new Error("vector_pricing: try to hard set invalid parameters. Use store_params to normalize and store params.");if("number"!=typeof e.vector_length)throw new Error("vector_pricing: try to hard set invalid parameters. Use store_params to normalize and store params.");h=e};var c=function(e,t){return e?{name:e.name||null,tags:e.tags||null,value:e.value[1<e.value.length?t:0]}:null},v=function(e,t){if(!e)return null;var r=e.times,a=e.dfs?e.dfs[1<e.dfs.length?t:0]:null;return{name:e.name||null,tags:e.tags||null,times:r,dfs:a}},w=function(e,t,r){if(!e)return null;var a,n=e.values[1<e.values.length?t:0],i=null,s=null;if(!0!==r&&Array.isArray(e.smile)&&Array.isArray(e.moneyness))for(s=e.moneyness,i=[],a=0;a<e.smile.length;a++)i.push(w(e.smile[a],t,!0));return Object.assign({},e,{values:n,moneyness:s,smile:i})};d.get_internal_object=function(e){switch(e.type.toLowerCase()){case"bond":case"floater":return new d.fixed_income(e);case"swap":return new d.swap(e);case"swaption":return new d.swaption(e);case"fxterm":return new d.fxterm(e);case"callable_bond":return new d.callable_fixed_income(e);case"equity":return new d.equity(e);default:throw new Error("get_internal_object: invalid instrument type")}},d.vector_pricer=function(e){var t={simulation_once:function(){this.results.present_value=new Array(this.num_scenarios)},simulation_scenario:function(){var e=this.idx_scen,t=this.dc,r=this.sc,a=this.fc,n=this.su,i=this.qu;switch(this.instrument.type.toLowerCase()){case"bond":case"floater":case"fxterm":case"irregular_bond":this.results.present_value[e]=this.object.present_value(t,r,a);break;case"swap":case"swaption":this.results.present_value[e]=this.object.present_value(t,a,n);break;case"callable_bond":this.results.present_value[e]=this.object.present_value(t,r,a,n);break;case"equity":this.results.present_value[e]=this.object.present_value(i)}this.instrument.currency&&"EUR"!==this.instrument.currency&&(this.results.present_value[e]/=d.get_safe_scalar(this.fx).get_value())}};return d.simulation(e,[t]).present_value},d.simulation=function(e,t){if("string"!=typeof e.type)throw new Error("vector_pricer: instrument object must contain valid type");d.valuation_date=h.valuation_date;for(var r,a={instrument:e,object:d.get_internal_object(e),params:h,num_scen:h.vector_length,idx_scen:0,dc:null,sc:null,fc:null,su:null,qu:null,fx:null,results:{}},n=h.curves[e.disc_curve||""]||null,i=h.curves[e.spread_curve||""]||null,s=h.curves[e.fwd_curve||""]||null,o=h.surfaces[e.surface||""]||null,l=h.scalars[e.quote||""]||{value:[1]},_=h.scalars[e.currency||""]||{value:[1]},u=0;u<h.vector_length;u++){for(a.dc=v(n,u),a.sc=v(i,u),a.fc=v(s,u),a.su=w(o,u),a.qu=c(l,u),a.fx=c(_,u),a.idx_scen=u,a.dc&&f(u,a.dc),a.sc&&f(u,a.sc),a.fc&&f(u,a.fc),a.su&&f(u,a.su),a.qu&&f(u,a.qu),a.fx&&f(u,a.fx),r=0;r<t.length;r++)0===u&&"function"==typeof t[r].simulation_once&&t[r].simulation_once.call(a);for(r=0;r<t.length;r++)"function"==typeof t[r].simulation_scenario&&t[r].simulation_scenario.call(a)}return a.results}}(this.JsonRisk||module.exports);